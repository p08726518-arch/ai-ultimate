<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Asisten Interaktif Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Math Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js" defer></script>
    <script src="https://unpkg.com/nerdamer@1.1.13/all.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bignumber.js/9.1.2/bignumber.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/complex.js/2.1.1/complex.min.js" defer></script>

    <!-- Utility & Creative Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/id.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chance/1.1.11/chance.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>

    <!-- WebLLM for Local AI Model -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/dist/web-llm.mjs"></script>

    <style>
        .example-prompt-button {
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            color: #4338ca;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: left;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }
        .example-prompt-button:hover { background-color: #e0e7ff; border-color: #a5b4fc; }
        .dark .example-prompt-button { background-color: #374151; border-color: #4b5563; color: #c7d2fe; }
        .dark .example-prompt-button:hover { background-color: #4b5563; border-color: #6366f1; }
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        
        /* Light Mode (Default) */
        body { background-color: #f3f4f6; color: #1f2937; }
        #chat-container::-webkit-scrollbar-track { background: transparent; }
        #chat-container::-webkit-scrollbar-thumb { background: #9ca3af; }
        .ai-message { background-color: #ffffff; border: 1px solid #e5e7eb; }
        .ai-message .prose { color: #374151; }
        .ai-message .prose h3 { color: #4f46e5; }
        .ai-message .prose strong { color: #4338ca; }
        .ai-message .prose blockquote { border-left-color: #a5b4fc; }
        .ai-message .prose hr { border-color: #d1d5db; }
        .ai-message .prose code { color: #4338ca; background-color: #eef2ff; }
        .ai-message .prose pre { background-color: #f9fafb; color: #111827; }
        .ai-message .prose a { color: #4f46e5; }
        .ai-message .prose th, .ai-message .prose td { border: 1px solid #d1d5db; }        
        .interactive-input, .interactive-select, .interactive-textarea { background-color: #f9fafb; border: 1px solid #d1d5db; color: #111827; }
        .trello-list { background-color: #f3f4f6; }
        .trello-list h4 { color: #4f46e5; }
        .trello-card { background-color: #ffffff; border: 1px solid #e5e7eb; color: #1f2937; }
        .tictactoe-cell { background-color: #e5e7eb; color: #1f2937; }
        .tictactoe-cell:hover:not(.occupied) { background-color: #d1d5db; }

        /* Dark Mode Overrides */
        .dark .sports-tracker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .dark .sport-card {
            background-color: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }
        .dark .sport-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #354bba;
            margin-bottom: 0.75rem;
        }
        .dark .sport-value { font-size: 2.25rem; font-weight: 700; color: #e0e7ff; line-height: 1.2; }
        .dark .sport-unit { font-size: 0.875rem; color: #9ca3af; }
        .dark .sport-compass { width: 96px; height: 96px; background: radial-gradient(circle, #374151 0%, #111827 100%); border: 2px solid #4f46e5; position: relative; margin: 0 auto; border-radius: 50%; }
        .dark body { background-color: #0f172a; color: #d1d5db; }
        .dark #chat-container::-webkit-scrollbar-track { background: transparent; }
        .dark #chat-container::-webkit-scrollbar-thumb { background: #4b5563; }
        .message-bubble { opacity: 0; transform: translateY(20px); animation: fadeIn 0.5s forwards; }
        .dark .ai-message { background-color: #1f2937; border: 1px solid #374151; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .dark .ai-message .prose { color: #d1d5db; }
        .dark .ai-message .prose h3 { color: #c4b5fd; }
        .dark .ai-message .prose strong { color: #a5b4fc; }
        .dark .ai-message .prose blockquote { border-left-color: #6366f1; }
        .dark .ai-message .prose hr { border-color: #374151; }
        .dark .ai-message .prose code { color: #a5b4fc; background-color: #374151; }
        .dark .ai-message .prose pre { background-color: #1f2937; color: #d1d5db; }
        .dark .ai-message .prose a { color: #93c5fd; }
        .dark .ai-message .prose th, .dark .ai-message .prose td { border: 1px solid #4b5563; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .feature-fade-in {
            opacity: 0; transform: scale(0.95) translateY(10px); animation: fadeIn 0.5s ease-out forwards; }
        .thinking-message.prose { color: #a78bfa !important; font-style: italic; }
        .sport-needle { width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 50px solid #f43f5e; position: absolute; top: 8px; left: 50%; transform-origin: 50% 40px; transition: transform 0.5s ease; z-index: 10; transform: translateX(-50%); }
        .feature-container { margin: 1rem 0; padding: 1.5rem; border-radius: 12px; background-color: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .map-container { height: 400px; border-radius: 8px; margin-top: 1rem; border: 2px solid #4b5563; }
        .dark .interactive-input, .dark .interactive-select, .dark .interactive-textarea { background-color: #374151; border: 1px solid #4b5563; color: white; }
        .interactive-button { background-color: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; border: none; cursor: pointer; }
        .interactive-button:hover { background-color: #4338ca; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .mic-button.listening { background-color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .tictactoe-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 240px; height: 240px; margin: 20px auto; }
        .dark .tictactoe-cell { background-color: #374151; color: #fff; }
        .dark .tictactoe-cell:hover:not(.occupied) { background-color: #4b5563; }
        .trello-board { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }
        .trello-list { border-radius: 12px; padding: 1rem; width: 280px; flex-shrink: 0; }
        .dark .trello-list { background-color: #1f2937; }
        .dark .trello-list h4 { color: #a5b4fc; }
        .trello-cards { min-height: 80px; display: flex; flex-direction: column; gap: 0.75rem; }
        .dark .trello-card { background-color: #374151; border: none; color: #d1d5db; }
        .trello-card .delete-card { opacity: 0; transition: opacity 0.2s; float: right; cursor: pointer; font-size: 0.8rem; }
        .piano-container{display:flex;justify-content:center;padding:1rem 0}.piano-keys{position:relative;display:flex;height:180px}.piano-key{cursor:pointer;transition:background-color .1s ease}.piano-key.white{width:50px;height:180px;border:1px solid #333;background-color:#fff;z-index:1}.piano-key.white.active{background-color:#ccc}.piano-key.black{width:30px;height:110px;background-color:#222;position:absolute;z-index:2;margin-left:-15px}.piano-key.black.active{background-color:#444}.piano-key.black[data-note="C#4"]{left:50px}.piano-key.black[data-note="D#4"]{left:100px}.piano-key.black[data-note="F#4"]{left:200px}.piano-key.black[data-note="G#4"]{left:250px}.piano-key.black[data-note="A#4"]{left:300px}
        .trello-card:hover .delete-card { opacity: 1; }
        .trello-card:active { cursor: grabbing; }
        .trello-card.dragging { opacity: 0.5; }
        .ludo-board{position:relative;width:390px;height:390px;margin:auto;background-color:#1e293b;border:2px solid #4b5563;display:grid;grid-template-columns:6fr 3fr 6fr;grid-template-rows:6fr 3fr 6fr;}.ludo-home-area{display:grid;place-items:center;}.ludo-home-inner{width:104px;height:104px;border:2px solid white;border-radius:10px;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:5px;padding:5px;}.ludo-home-area.red{background-color:rgba(239,68,68,0.5);}.ludo-home-area.green{background-color:rgba(16,185,129,0.5);}.ludo-home-area.blue{background-color:rgba(59,130,246,0.5);}.ludo-home-area.yellow{background-color:rgba(245,158,11,0.5);}.ludo-center{background:repeating-conic-gradient(from 0deg, #ef4444 0 90deg, #10b981 90deg 180deg, #3b82f6 180deg 270deg, #f59e0b 270deg 360deg);grid-column:2;grid-row:2;}.ludo-path{display:grid;}.ludo-path-top{grid-template-columns:repeat(6,1fr) 1fr repeat(6,1fr);grid-template-rows:repeat(3,1fr);grid-column:1 / 4;grid-row:1;}.ludo-path-middle{grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(6,1fr) 1fr repeat(6,1fr);grid-column:2;grid-row:1 / 4;}.ludo-path-bottom{grid-template-columns:repeat(6,1fr) 1fr repeat(6,1fr);grid-template-rows:repeat(3,1fr);grid-column:1 / 4;grid-row:3;}.ludo-cell{width:26px;height:26px;border:1px solid #475569;box-sizing:border-box;position:relative;}.ludo-token{width:20px;height:20px;border-radius:50%;border:2px solid white;position:absolute;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 4px rgba(0,0,0,0.5);z-index:10;display:flex;align-items:center;justify-content:center;}.ludo-token.movable{animation:pulse-movable 1.5s infinite;}.token-red{background-color:#ef4444;}.token-green{background-color:#10b981;}.token-yellow{background-color:#f59e0b;}.token-blue{background-color:#3b82f6;}.ludo-dice-container{display:flex;align-items:center;gap:15px;}.ludo-dice{width:50px;height:50px;color:black;display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:bold;border-radius:8px;transition:all .2s;}.ludo-dice.rolling{transform:rotate(360deg) scale(1.2);}.ludo-status{height:24px;font-weight:bold;}.cell-safe::after{content:'⭐';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:14px;opacity:0.5;}@keyframes pulse-movable{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,255,255,0.7)}50%{transform:scale(1.1);box-shadow:0 0 10px 5px rgba(255,255,255,0)}}
        .dice-visual{width:100px;height:100px;background:#f0fdf4;border-radius:15px;display:flex;align-items:center;justify-content:center; border: 1px solid #e5e7eb;}.dark .dice-visual{background:#1f2937; border-color: #374151;}.dice-face{width:80px;height:80px;display:grid;grid-template-areas:"a . c" ". e ." "d . b";gap:4px}.dice-dot{width:20px;height:20px;background-color:#1a202c;border-radius:50%}.dark .dice-dot{background-color:#d1d5db;}.dice-dot.a{grid-area:a}.dice-dot.b{grid-area:b}.dice-dot.c{grid-area:c}.dice-dot.d{grid-area:d}.dice-dot.e{grid-area:e}.dice-dot.f{grid-area:f}.dice-dot.g{grid-area:g}
        .game-board-2048{width:280px;height:280px;background:rgba(187,173,160,0.5);border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);grid-gap:8px;position:relative}.tile-2048{background:rgba(238,228,218,0.35);border-radius:6px;width:60px;height:60px;display:flex;justify-content:center;align-items:center;font-size:1.5rem;font-weight:bold;transition:all .15s ease-in-out;animation:appear .2s ease-in-out}.tile-2048-2{background:#eee4da;color:#776e65}.tile-2048-4{background:#ede0c8;color:#776e65}.tile-2048-8{background:#f2b179;color:#f9f6f2}.tile-2048-16{background:#f59563;color:#f9f6f2}.tile-2048-32{background:#f67c5f;color:#f9f6f2}.tile-2048-64{background:#f65e3b;color:#f9f6f2}.tile-2048-128{background:#edcf72;color:#f9f6f2;font-size:1.3rem}.tile-2048-256{background:#edcc61;color:#f9f6f2;font-size:1.3rem}.tile-2048-512{background:#edc850;color:#f9f6f2;font-size:1.3rem}.tile-2048-1024{background:#edc53f;color:#f9f6f2;font-size:1.1rem}.tile-2048-2048{background:#edc22e;color:#f9f6f2;font-size:1.1rem;box-shadow:0 0 20px rgba(243,215,116,.6)}.tile-merged{animation:merge .2s ease-in-out;}@keyframes appear{0%{transform:scale(0);opacity:0}100%{transform:scale(1);opacity:1}}@keyframes merge{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    </style>
</head>
<body class="relative">
    <!-- Ping Display -->
    <div id="ping-display" class="fixed top-4 right-16 text-sm font-mono bg-gray-900 bg-opacity-70 backdrop-blur-sm px-2 py-1 rounded-md z-50">
        -- ms
    </div>
    <!-- Background Settings -->
    <div id="bg-settings-panel" class="fixed top-16 left-4 bg-gray-800 bg-opacity-80 backdrop-blur-md text-white p-4 rounded-lg shadow-lg z-50 hidden w-64">
        <h4 class="font-bold mb-3">Pengaturan Latar</h4>
        <div class="space-y-3 text-sm"><label class="block">Warna Solid: <input type="color" id="bg-color-picker" class="w-full h-8 p-0 border-none rounded"></label><label class="block">URL Gambar: <input type="text" id="bg-image-url" placeholder="https://..." class="w-full bg-gray-700 p-1 rounded border border-gray-600"></label><label class="flex items-center gap-2"><input type="checkbox" id="dynamic-bg-toggle"> Warna Dinamis</label><button id="reset-bg-btn" class="w-full bg-red-600 hover:bg-red-700 text-white py-1 rounded mt-2">Reset</button></div>
    </div>

    <!-- Theme Toggle -->

    <!-- History Sidebar -->
    <button id="history-toggle-btn" class="fixed top-4 left-16 z-50 p-2 bg-gray-700 rounded-full text-white hover:bg-gray-600 transition-colors" title="Riwayat Chat">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    </button>
    <div id="history-sidebar" class="fixed top-0 left-0 h-full w-80 bg-gray-100 dark:bg-gray-900 shadow-lg z-40 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-4 border-b border-gray-300 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white">📜 Riwayat</h3>
            <div class="flex items-center gap-1">
                <button id="new-chat-btn" title="Mulai Chat Baru" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-800 dark:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
        </div>
        <div id="history-list" class="flex-1 p-2 space-y-2 overflow-y-auto"></div>
        <div class="p-2 border-t border-gray-300 dark:border-gray-700">
            <div class="grid grid-cols-2 gap-2 text-sm" id="history-actions">
                <button onclick="exportChatHistory()" class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 p-2 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">📥 Ekspor</button>
                <label class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 p-2 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 cursor-pointer text-center transition-colors">📤 Impor<input type="file" class="hidden" accept=".json" onchange="importChatHistory(event)"></label>
            </div>
            <button onclick="clearAllChatHistory()" class="w-full mt-2 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 p-2 rounded-md hover:bg-red-200 dark:hover:bg-red-800 text-sm">🗑️ Hapus Semua Riwayat</button>
            
            <!-- Moved Settings Buttons -->
            <div class="mt-4 pt-4 border-t border-gray-300 dark:border-gray-700">
                <h4 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-3 px-2">Pengaturan</h4>
                <div class="space-y-2">
                    <!-- Theme Toggle -->
                    <button id="theme-toggle-btn" class="w-full flex items-center justify-between text-left bg-gray-200 dark:bg-gray-800 p-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-700 text-sm transition-colors">
                        <span>Ganti Tema</span>
                        <div class="relative w-5 h-5">
                            <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                            <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        </div>
                    </button>
                    <!-- Background Settings -->
                    <button id="bg-settings-toggle-btn" class="w-full flex items-center justify-between text-left bg-gray-200 dark:bg-gray-800 p-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-700 text-sm transition-colors" title="Pengaturan Latar">
                        <span>Pengaturan Latar</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                    </button>
                    <!-- Model Selector -->
                    <details class="group">
                        <summary class="list-none w-full flex items-center justify-between text-left bg-gray-200 dark:bg-gray-800 p-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-700 text-sm transition-colors cursor-pointer" title="Pilih Model AI">
                            <span>Pilih Model AI</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 00-1 1v.5a1.5 1.5 0 01-3 0v-.5a1 1 0 00-1-1H6a1 1 0 01-1-1v-3a1 1 0 011-1h.5a1.5 1.5 0 000-3H6a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" /></svg>
                        </summary>
                        <div id="model-selector-panel" class="bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-white p-2 rounded-lg mt-1">
                            <h4 class="font-bold mb-2 text-sm">Pilih Model Aktif</h4>
                            <div class="space-y-1" id="model-list">
                                <button class="w-full text-left text-sm p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-700" onclick="switchActiveModel('falcon')">🪶 Falcon 2</button>
                                <button class="w-full text-left text-sm p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-700" onclick="switchActiveModel('gemini')">✨ Gemini 1.5 Pro</button>
                                <button class="w-full text-left text-sm p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-700" onclick="switchActiveModel('deepseek')">💻 DeepSeek V2</button>
                                <button class="w-full text-left text-sm p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-700" onclick="switchActiveModel('chatgpt')">🤖 ChatGPT-4o</button>
                                <button class="w-full text-left text-sm p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-700" onclick="switchActiveModel('claude')">✍️ Claude 3.5</button>
                                <button class="w-full text-left text-sm p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-700" onclick="switchActiveModel('tinylama')">🦙 TinyLlama (Lokal)</button>
                                <button class="w-full text-left text-sm p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-700" onclick="switchActiveModel('qwen')">🐉 Qwen (Lokal)</button>
                                <button id="webllm-model-btn" class="w-full text-left text-sm p-2 rounded hover:bg-gray-300 dark:hover:bg-gray-700" onclick="switchActiveModel('webllm')">🧠 WebLLM (Lokal)</button>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <!-- Dropdown More Produk -->
            <details class="group mt-2">
                <summary class="list-none block w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 text-sm text-center transition-colors cursor-pointer">
                    📱 More Produk
                </summary>
                <div class="mt-2 space-y-2 p-2 bg-gray-100 dark:bg-gray-800 rounded-md">
                    <a href="https://akhtarnurrahman1.github.io/block-blast-io/" target="_blank" rel="noopener noreferrer" class="block p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-xs text-gray-800 dark:text-gray-200">1. Block Blast</a>
                    <a href="https://p08726518-arch.github.io/spase-exploler2345/" target="_blank" rel="noopener noreferrer" class="block p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-xs text-gray-800 dark:text-gray-200">2. Space Explorer</a>
                    <a href="https://easysearch.site/" target="_blank" rel="noopener noreferrer" class="block p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-xs text-gray-800 dark:text-gray-200">3. al quran (Official)</a>
                    <a href="https://p08726518-arch.github.io/easy-search1/" target="_blank" rel="noopener noreferrer" class="block p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-xs text-gray-800 dark:text-gray-200">4. EasySearch (Github)</a>
                    <a href="https://p08726518-arch.github.io/html-viewer434/" target="_blank" rel="noopener noreferrer" class="block p-2 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-xs text-gray-800 dark:text-gray-200">5. HTML Viewer</a>
                </div>
            </details>
        </div>
    </div>

    <div class="flex flex-col h-screen max-w-4xl mx-auto p-4">
        <header class="text-center mb-4 pt-4 pb-4">
             <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight flex items-center justify-center gap-3">
                <svg class="w-8 h-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 22.5l-.648-1.938a3.375 3.375 0 00-2.685-2.685L11.25 18l1.938-.648a3.375 3.375 0 002.685-2.685L16.25 13.5l.648 1.938a3.375 3.375 0 002.685 2.685L21.75 18l-1.938.648a3.375 3.375 0 00-2.685 2.685z" /></svg>
                AI Asisten Interaktif Ultimate
            </h1>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto pr-2 space-y-6">
            <div id="welcome-message" class="message-bubble flex gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex-shrink-0 flex items-center justify-center font-bold text-white dark:text-indigo-100">AI</div>
                <div class="ai-message rounded-xl p-4 max-w-full prose dark:prose-invert">
                    <p>Selamat datang di versi Ultimate! Saya adalah gabungan dari semua fitur terbaik.</p>
                    <p>Kini Anda bisa melakukan kalkulasi matematika, bermain game, menggunakan utilitas canggih, hingga menyimpan file rahasia Anda. Coba gunakan suara Anda dengan menekan tombol mikrofon!</p>
                    <p>Ketik <a href="#" class="example-link font-semibold">panduan</a> untuk melihat semua yang bisa saya lakukan sekarang.</p>
                </div>
            </div>
            <div id="example-prompts" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4 px-12">
                <button class="example-prompt-button">
                    <div class="font-semibold">Jadwal Sholat</div>
                    <div class="text-sm text-indigo-500 dark:text-indigo-400">Lihat waktu sholat berdasarkan lokasimu</div>
                </button>
                <button class="example-prompt-button">
                    <div class="font-semibold">Game Lempar Dadu</div>
                    <div class="text-sm text-indigo-500 dark:text-indigo-400">Coba keberuntunganmu melempar dadu</div>
                </button>
            </div>
        </div>

        <div class="mt-6">
            <form id="input-form" class="flex items-center gap-3 bg-white dark:bg-slate-800 p-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-lg">
                <style>
                    /* CSS untuk toggle button */
                    .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
                    .toggle-checkbox:checked + .toggle-label .toggle-circle { transform: translateX(20px); }
                    .toggle-label, .toggle-circle { transition: all 0.2s ease-in-out; }
                </style>
                <div class="flex items-center justify-center w-28 flex-shrink-0" title="Deep Research Mode">
                    <label for="deep-research-toggle" class="flex items-center cursor-pointer">
                        <button type="button" id="tts-toggle-btn" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-600 dark:text-white p-2 rounded-full transition duration-300 flex-shrink-0 mr-2" title="Aktifkan/Nonaktifkan Suara">
                            <!-- Ikon akan diisi oleh JavaScript -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M13.28 3.97a.75.75 0 010 1.06L6.31 12l6.97 6.97a.75.75 0 11-1.06 1.06l-7.5-7.5a.75.75 0 010-1.06l7.5-7.5a.75.75 0 011.06 0zm6 0a.75.75 0 010 1.06L12.31 12l6.97 6.97a.75.75 0 11-1.06 1.06l-7.5-7.5a.75.75 0 010-1.06l7.5-7.5a.75.75 0 011.06 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <div class="relative">
                            <input type="checkbox" id="deep-research-toggle" class="sr-only toggle-checkbox">
                            <div class="toggle-label block bg-gray-200 dark:bg-gray-600 w-12 h-7 rounded-full">
                                <div class="toggle-circle absolute left-1 top-1 bg-white w-5 h-5 rounded-full"></div>
                            </div>
                        </div>
                        <div class="ml-2 text-xs font-semibold text-gray-700 dark:text-gray-300">
                            Deep<br>Research
                        </div>
                    </label>
                </div>
                <textarea id="expression" rows="1" class="w-full bg-transparent p-2 text-gray-900 dark:text-white focus:ring-0 focus:outline-none transition resize-none" placeholder="Ketik permintaan atau klik mikrofon..."></textarea>
                <button type="button" id="mic-btn" class="mic-button bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-600 dark:text-white p-3 rounded-full transition duration-300 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M8.25 4.5a3.75 3.75 0 117.5 0v8.25a3.75 3.75 0 11-7.5 0V4.5z" /><path d="M6 10.5a.75.75 0 01.75.75v1.5a5.25 5.25 0 1010.5 0v-1.5a.75.75 0 011.5 0v1.5a6.75 6.75 0 11-13.5 0v-1.5A.75.75 0 016 10.5z" /></svg>
                </button>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-full transition duration-300 shadow-lg flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
                </button>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Core Variables & Setup ---
    const chatContainer = document.getElementById('chat-container');
    const inputForm = document.getElementById('input-form');
    const expressionEl = document.getElementById('expression');
    const micBtn = document.getElementById('mic-btn');
    const submitBtn = inputForm.querySelector('button[type="submit"]');
    const ttsToggleBtn = document.getElementById('tts-toggle-btn');
    let isTtsEnabled = localStorage.getItem('isTtsEnabled') === 'true';
    let voices = [];

    // --- TTS (Text-to-Speech) Setup ---
    const speakerOnIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.348 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" /><path d="M15.932 7.757a.75.75 0 011.06 0 4.5 4.5 0 010 6.364.75.75 0 01-1.06-1.06 3 3 0 000-4.243.75.75 0 010-1.06z" /></svg>`;
    const speakerOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.348 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM17.72 17.72a.75.75 0 10-1.06-1.06L18.94 15l-2.28-2.28a.75.75 0 00-1.06-1.06l-1.06 1.06-2.28-2.28a.75.75 0 00-1.06-1.06l-1.06 1.06L8.86 8.86a.75.75 0 10-1.06 1.06L10.06 12l-2.28 2.28a.75.75 0 101.06 1.06l2.28-2.28 1.06 1.06a.75.75 0 001.06 0l2.28-2.28 1.06 1.06a.75.75 0 101.06-1.06l-1.06-1.06 2.28 2.28z" /></svg>`;

    moment.locale('id');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const sunIcon = document.getElementById('theme-icon-sun');
    const moonIcon = document.getElementById('theme-icon-moon');
    const historySidebar = document.getElementById('history-sidebar');
    const historyToggleBtn = document.getElementById('history-toggle-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    let isSwitchingModel = false;
    const bgSettingsPanel = document.getElementById('bg-settings-panel');
    let dynamicBgInterval = null;
    let stats;

    window.activeCharts = {};
    let activeModel = localStorage.getItem('activeModel') || 'falcon'; // Default model
    window.activeMaps = {};
            window.tripState = {}; // Untuk melacak perjalanan real-time
    let isWebLLMLoading = true; // Flag to track WebLLM loading state
    let webLlmChat; // Variable to hold the WebLLM instance
    let currentSessionId = null;
    let waitingForApiKey = null;
    let db;

    // --- Stats.js Performance Monitor ---
    function initStats() {
        stats = new Stats();
        stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
        stats.dom.style.position = 'fixed';
        stats.dom.style.top = '4px';
        stats.dom.style.left = 'auto';
        stats.dom.style.right = '4px';
        document.body.appendChild(stats.dom);
        function animate() {
            stats.begin();
            stats.end();
            requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
    }

    function loadVoices() {
        voices = speechSynthesis.getVoices();
    }
    loadVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    }

    function updateTtsButton() {
        ttsToggleBtn.innerHTML = isTtsEnabled ? speakerOnIcon : speakerOffIcon;
        if (isTtsEnabled) {
            ttsToggleBtn.classList.add('text-indigo-500', 'dark:text-indigo-400');
        } else {
            ttsToggleBtn.classList.remove('text-indigo-500', 'dark:text-indigo-400');
        }
    }

    function speakText(text) {
        if (!isTtsEnabled || !text) return;

        // Hentikan suara yang sedang berjalan
        speechSynthesis.cancel();

        // Bersihkan teks dari markdown dan tag HTML sederhana
        const cleanText = text.replace(/<[^>]*>/g, ' ').replace(/(\*\*|__|\*|_|`)/g, '');

        const msg = new SpeechSynthesisUtterance(cleanText);
        msg.lang = "id-ID";

        // Coba temukan suara Google Bahasa Indonesia
        const indonesianVoice = voices.find(v => v.name === "Google Bahasa Indonesia" && v.lang === "id-ID");
        if (indonesianVoice) {
            msg.voice = indonesianVoice;
        }

        speechSynthesis.speak(msg);
    }

    // --- Library Readiness Check ---
    function checkLibrariesReady() {
        expressionEl.placeholder = "Memuat pustaka matematika...";
        expressionEl.disabled = true;
        submitBtn.disabled = true;

        const interval = setInterval(() => {
            const mathReady = typeof math !== 'undefined';
            const nerdamerReady = typeof nerdamer !== 'undefined';
            const bigNumberReady = typeof BigNumber !== 'undefined';

            if (mathReady && nerdamerReady && bigNumberReady) {
                clearInterval(interval);
                expressionEl.placeholder = "Ketik permintaan atau klik mikrofon...";
                expressionEl.disabled = false;
                submitBtn.disabled = false;
                console.log("Semua pustaka matematika (Math.js, Nerdamer, BigNumber.js) berhasil dimuat.");
                initStats(); // Inisialisasi Stats.js setelah pustaka lain siap
            } else {
                console.log(`Status Pustaka: Math.js (${mathReady}), Nerdamer (${nerdamerReady}), Algebrite (${algebriteReady})`);
            }
        }, 200); // Cek setiap 200ms
    }

    function checkWebLLMReady() {
        const webLlmBtn = document.getElementById('webllm-model-btn');
        if (!webLlmBtn) return;

        // Initial state
        webLlmBtn.disabled = true;
        webLlmBtn.innerHTML = '🧠 <span class="opacity-70">Memuat Model Lokal...</span>';

        const checkInterval = setInterval(() => {
            if (typeof webllm !== 'undefined' && webllm.ChatModule) {
                clearInterval(checkInterval);
                webLlmBtn.disabled = false;
                webLlmBtn.innerHTML = '🧠 WebLLM (Lokal)';
                isWebLLMLoading = false;
                console.log("WebLLM is ready.");
                // Jika model aktif adalah webllm, perbarui UI
                if (activeModel === 'webllm') {
                    updateActiveModelUI();
                }
            }
        }, 500); // Check every 500ms
    }

    // --- Robust WebLLM Readiness Check using a Promise ---
    let webLLMReadyPromise = new Promise(resolve => {
        const interval = setInterval(() => {
            if (typeof webllm !== 'undefined' && webllm.ChatModule) {
                clearInterval(interval);
                console.log("WebLLM library is ready.");
                resolve();
            }
        }, 200); // Check every 200ms
    });

    function checkWebLLMReady() {
        const localModelButtons = document.querySelectorAll('#model-list button[onclick*="Llama"], #model-list button[onclick*="Qwen"], #model-list button[onclick*="webllm"]');
        
        // Disable buttons while loading
        localModelButtons.forEach(btn => {
            btn.disabled = true;
            btn.innerHTML += ' <span class="loading-text opacity-70 text-xs">(Memuat...)</span>';
        });

        webLLMReadyPromise.then(() => {
            localModelButtons.forEach(btn => {
                btn.disabled = false;
                btn.querySelector('.loading-text')?.remove();
            });
        });
    }

    checkLibrariesReady(); // Mulai pemeriksaan saat DOM siap
    checkWebLLMReady();

    // Pindahkan listener untuk bg-settings-toggle-btn karena elemennya dipindah
    document.getElementById('bg-settings-toggle-btn').addEventListener('click', () => {
        bgSettingsPanel.classList.toggle('hidden');
    });

    // --- Theme Management ---
    function showToast(message, type = 'info') {
        const toastId = `toast-${Date.now()}`;
        const colors = {
            info: 'bg-blue-500',
            success: 'bg-green-500',
            error: 'bg-red-500',
            warning: 'bg-yellow-500'
        };
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `fixed top-5 right-5 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full opacity-0 transition-all duration-300 ease-out`;
        toast.innerHTML = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
        }, 10);

        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function updateActiveModelUI() {
        const modelButtons = document.querySelectorAll('#model-list button');
        const webLlmBtn = document.getElementById('webllm-model-btn');
        if (isWebLLMLoading && webLlmBtn) {
            webLlmBtn.disabled = true;
            webLlmBtn.innerHTML = '🧠 <span class="opacity-70">Memuat...</span>';
        }
        modelButtons.forEach(btn => {
            if (btn.getAttribute('onclick').includes(`'${activeModel}'`)) {
                btn.classList.add('bg-indigo-600', 'font-bold');
            } else {
                btn.classList.remove('bg-indigo-600', 'font-bold');
            }
        });
    }

    window.switchActiveModel = async (modelName) => {
        if (isSwitchingModel || activeModel === modelName) return;

        const localModels = ['webllm', 'tinylama', 'qwen'];
        const modelsWithoutApiKey = ['falcon', ...localModels];

        if (!modelsWithoutApiKey.includes(modelName) && !localStorage.getItem(`${modelName}_api_key`)) { // Cek API Key untuk model online
            waitingForApiKey = modelName;
            const readableName = modelName.charAt(0).toUpperCase() + modelName.slice(1);
            addMessageToUI('notification', marked.parse(`🔑 **API Key untuk ${readableName} belum diatur.**\n\nSilakan masukkan API Key Anda di bawah ini. Anda bisa mendapatkannya dari situs resmi masing-masing penyedia model AI.`));
            return;
        }

        activeModel = modelName;
        localStorage.setItem('activeModel', modelName);
        updateActiveModelUI();
        const readableName = modelName.charAt(0).toUpperCase() + modelName.slice(1);
        showToast(`Model aktif: <strong>${readableName}</strong>`, 'success');

        // Jika model yang dipilih adalah model lokal dan belum di-cache, mulai proses unduh
        if (localModels.includes(modelName)) {
            const config = window.modelConfigs[modelName];
            if (!window.localModels[config.id]) {
                await handleLocalModelQuery(`Halo ${config.name}, apakah kamu sudah siap?`, modelName);
            }
        }

        isSwitchingModel = true;
        setTimeout(() => {
            isSwitchingModel = false;
        }, 1000); // Cooldown 1 detik
    };

    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            sunIcon.classList.remove('hidden'); // Show sun in dark mode
            moonIcon.classList.add('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            sunIcon.classList.add('hidden');
            moonIcon.classList.remove('hidden');
        }
    }

    themeToggleBtn.addEventListener('click', () => {
        const isDark = document.documentElement.classList.contains('dark');
        const newTheme = isDark ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });

    // Apply theme on initial load
    const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
    applyTheme(savedTheme);

    // --- Background Management ---
    function applyBackground(settings) {
        if (dynamicBgInterval) clearInterval(dynamicBgInterval);
        if (settings.dynamic) {
            let hue = 0;
            document.body.style.backgroundImage = 'none';
            dynamicBgInterval = setInterval(() => {
                hue = (hue + 0.1) % 360;
                document.body.style.backgroundColor = `hsl(${hue}, 20%, ${savedTheme === 'dark' ? '10%' : '95%'})`;
            }, 50);
        } else if (settings.image) {
            document.body.style.backgroundImage = `url('${settings.image}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundAttachment = 'fixed';
        } else if (settings.color) {
            document.body.style.backgroundImage = 'none';
            document.body.style.backgroundColor = settings.color;
        } else { // Reset
            document.body.style.cssText = ''; // Clear all inline styles
        }
    }

    const bgSettings = JSON.parse(localStorage.getItem('bgSettings')) || {};
    const bgColorPicker = document.getElementById('bg-color-picker');
    const bgImageUrl = document.getElementById('bg-image-url');
    const dynamicBgToggle = document.getElementById('dynamic-bg-toggle');
    const resetBgBtn = document.getElementById('reset-bg-btn');

    bgColorPicker.value = bgSettings.color || '#f3f4f6';
    bgImageUrl.value = bgSettings.image || '';
    dynamicBgToggle.checked = bgSettings.dynamic || false;
    applyBackground(bgSettings);

    bgColorPicker.addEventListener('input', (e) => updateBgSettings({ color: e.target.value, image: '', dynamic: false }));
    bgImageUrl.addEventListener('input', (e) => updateBgSettings({ image: e.target.value, color: '', dynamic: false }));
    dynamicBgToggle.addEventListener('change', (e) => updateBgSettings({ dynamic: e.target.checked }));
    resetBgBtn.addEventListener('click', () => updateBgSettings({ color: '', image: '', dynamic: false }));

    function updateBgSettings(newSettings) {
        localStorage.setItem('bgSettings', JSON.stringify(newSettings));
        applyBackground(newSettings);
    }
    // --- IndexedDB Setup for Secret Files ---
    function initDB() {
                const request = indexedDB.open('AiUltimateDB', 3); // Naikkan versi DB untuk upgrade
        request.onerror = (event) => console.error("IndexedDB error:", event.target.errorCode);
        request.onsuccess = (event) => db = event.target.result;
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
                    if (event.oldVersion < 1) {
                        db.createObjectStore('files', {keyPath: 'id', autoIncrement: true});
                    }
                    // Versi 2 (dihapus) - history
                    if (event.oldVersion < 3) {
                        if (db.objectStoreNames.contains('history')) {
                            db.deleteObjectStore('history');
                        }
                        // Tambahkan object store untuk lagu piano
                        if (!db.objectStoreNames.contains('piano_songs')) {
                           db.createObjectStore('piano_songs', { keyPath: 'id', autoIncrement: true });
                        }

                        db.createObjectStore('chat_sessions', { keyPath: 'id', autoIncrement: true });
                        const messagesStore = db.createObjectStore('chat_messages', { keyPath: 'id', autoIncrement: true });
                        messagesStore.createIndex('sessionId', 'sessionId', { unique: false });
                    }
        };
    }
    initDB();

    // --- Event Listeners ---
    inputForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const query = expressionEl.value.trim();
        if (query) {
            processUserInput(query);
            expressionEl.value = '';
            expressionEl.style.height = 'auto';
            expressionEl.focus(); // Optional: keep focus on the input
        }
    });
    chatContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('example-link')) {
            e.preventDefault();
            const query = e.target.textContent;
            expressionEl.value = query;
            expressionEl.focus();
            processUserInput(query);
        }
    });
    chatContainer.addEventListener('click', (e) => {
        const button = e.target.closest('.example-prompt-button');
        if (button) {
            e.preventDefault();
            const query = button.querySelector('.font-semibold').textContent.trim();
            expressionEl.value = query;
            expressionEl.focus();
            processUserInput(query);
        }
    });
    historyToggleBtn.addEventListener('click', () => {
        historySidebar.classList.toggle('-translate-x-full');
        if (!historySidebar.classList.contains('-translate-x-full')) {
            loadHistoryToSidebar();
        }
    });
    document.addEventListener('click', (e) => {
        if (!historySidebar.contains(e.target) && !historyToggleBtn.contains(e.target) && !historySidebar.classList.contains('-translate-x-full')) {
            historySidebar.classList.add('-translate-x-full');
        }
    });
    ttsToggleBtn.addEventListener('click', () => {
        isTtsEnabled = !isTtsEnabled;
        localStorage.setItem('isTtsEnabled', isTtsEnabled);
        updateTtsButton();
        if (!isTtsEnabled) speechSynthesis.cancel(); // Hentikan suara jika dinonaktifkan
    });
    newChatBtn.addEventListener('click', () => {
        startNewChat();
        historySidebar.classList.add('-translate-x-full');
    });

    // --- Web Speech API ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'id-ID';
        recognition.interimResults = false;

        micBtn.addEventListener('click', () => {
            if (micBtn.classList.contains('listening')) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        recognition.onstart = () => micBtn.classList.add('listening');
        recognition.onend = () => micBtn.classList.remove('listening');
        recognition.onerror = (event) => {
            console.error('Speech recognition error', event.error);
            micBtn.classList.remove('listening');
        };
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            expressionEl.value = transcript;
            processUserInput(transcript);
        };
    } else {
        micBtn.style.display = 'none';
    }

    // --- Core Chat Functions ---
    function addMessageToUI(sender, content, messageId = `msg-${Date.now()}`) {
        let bubble;
        const icon = sender === 'notification' ? 'ðŸ””' : 'AI';
        const bgColor = sender === 'notification' ? 'bg-yellow-500' : 'bg-indigo-500';
        if (sender === 'user') { 
            bubble = `<div class="message-bubble feature-fade-in flex justify-end"><div class="bg-indigo-600 rounded-xl p-4 max-w-lg text-white dark:text-indigo-100">${escapeHtml(content)}</div></div>`;
        } else {
            bubble = `<div id="${messageId}" class="message-bubble feature-fade-in flex gap-3"><div class="w-8 h-8 rounded-full ${bgColor} flex-shrink-0 flex items-center justify-center font-bold text-white dark:text-indigo-100">${icon}</div><div class="ai-message rounded-xl p-4 max-w-full prose dark:prose-invert">${content}</div></div>`; // content is already marked.parse'd
        }
        chatContainer.insertAdjacentHTML('beforeend', bubble);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return messageId;
    }
    function addThinkingMessage(content) {
        const id = `thinking-${Date.now()}`; 
        const bubble = `<div id="${id}" class="message-bubble feature-fade-in flex gap-3"><div class="w-8 h-8 rounded-full bg-purple-500 flex-shrink-0 flex items-center justify-center font-bold text-white dark:text-purple-100">🤔</div><div class="ai-message thinking-message rounded-xl p-4 max-w-full prose dark:prose-invert">${marked.parse(content)}</div></div>`;
        chatContainer.insertAdjacentHTML('beforeend', bubble);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return id;
    }

    // --- Deep Think Feature ---
    function getDynamicThinkingMessage(query) {
        const q = query.toLowerCase();

        // Kumpulan 13+ pesan "berpikir" yang dikategorikan
        const messages = {
            creative: [
                "Mengumpulkan inspirasi kreatif...",
                "Menyiapkan kanvas imajinasi untuk Anda...",
            ],
            technical: [
                "Membuka dokumentasi teknis dan meracik kode...",
                "Mengompilasi logika dan algoritma...",
                "Membangun struktur kode untuk Anda...",
            ],
            data: [
                "Menghitung angka-angka dan menganalisis data...",
                "Memvisualisasikan pola dari informasi yang diberikan...",
            ],
            knowledge: [
                "Menelusuri arsip pengetahuan digital...",
                "Menghubungkan titik-titik informasi untuk Anda...",
            ],
            game: [
                "Menyiapkan papan permainan...",
                "Mengocok dadu keberuntungan...",
            ],
            general: [
                "Memproses informasi Anda...",
                "Sedang berpikir sejenak...",
            ]
        };

        // Logika untuk memilih kategori berdasarkan kata kunci
        if (/\b(gambar|puisi|cerita|desain|kreatif)\b/.test(q)) return messages.creative[Math.floor(Math.random() * messages.creative.length)];
        if (/\b(kode|koding|python|javascript|html|css|fungsi|program)\b/.test(q)) return messages.technical[Math.floor(Math.random() * messages.technical.length)];
        if (/\b(grafik|analisis|data|hitung|statistik)\b/.test(q)) return messages.data[Math.floor(Math.random() * messages.data.length)];
        if (/\b(siapa|apa|kapan|mengapa|bagaimana|jelaskan|wikipedia|search|cari)\b/.test(q)) return messages.knowledge[Math.floor(Math.random() * messages.knowledge.length)];
        if (/\b(game|main|bermain|tictactoe|ludo|dadu|2048)\b/.test(q)) return messages.game[Math.floor(Math.random() * messages.game.length)];
        
        // Jika tidak ada kata kunci yang cocok, pilih dari kategori umum
        return messages.general[Math.floor(Math.random() * messages.general.length)];
    }

    async function updateMessage(id, newContent, isFinal = true) {
        const msgEl = document.getElementById(id);
        if (msgEl) {
            const aiMsg = msgEl.querySelector('.ai-message');
            if (aiMsg) {
                if (aiMsg.classList.contains('thinking-message')) {
                    aiMsg.classList.remove('thinking-message');
                    const iconEl = msgEl.querySelector('.bg-purple-500');
                    if(iconEl) {
                        iconEl.className = iconEl.className.replace('bg-purple-500', 'bg-indigo-500');
                        iconEl.textContent = 'AI';
                    }
                }
                // PERBAIKAN: Hapus kelas 'prose' jika konten berisi tombol agar bisa diklik
                if (newContent.includes('<button')) {
                    aiMsg.classList.remove('prose', 'dark:prose-invert');
                } else if (!aiMsg.classList.contains('prose')) {
                    aiMsg.classList.add('prose', 'dark:prose-invert');
                }
                aiMsg.innerHTML = newContent;
                if (isFinal && currentSessionId) {
                    // --- Fitur AI Adaptif: Simpan ke memori ---
                    const lastQuery = window.lastUserQuery || '';
                    if (lastQuery) {
                        saveToMemory(lastQuery, newContent);
                    }

                    speakText(newContent); // Panggil TTS di sini
                    await saveMessageToDB('ai', newContent, currentSessionId);
                }
            }
        }
    }
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // --- Fitur AI Adaptif (Personal Adaptive AI) ---
    function saveToMemory(question, answer) {
        let memory = JSON.parse(localStorage.getItem("ai_brain")) || [];
        // Hapus markdown dari jawaban untuk memori yang lebih bersih
        const cleanAnswer = answer.replace(/<[^>]*>/g, ' ').replace(/(\*\*|__|\*|_|`)/g, '');
        memory.push({ question, answer: cleanAnswer });
        // Batasi memori hingga 39 interaksi terakhir untuk menjaga efisiensi
        if (memory.length > 39) {
            memory = memory.slice(memory.length - 39);
        }
        localStorage.setItem("ai_brain", JSON.stringify(memory));
    }


    // --- Chat History & Session Management ---
    async function ensureSession(query) {
        if (currentSessionId) return currentSessionId;

        return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const title = query.length > 40 ? query.substring(0, 37) + '...' : query;
            const session = { title: title, timestamp: Date.now() };
            const tx = db.transaction('chat_sessions', 'readwrite');
            const request = tx.objectStore('chat_sessions').add(session);
            request.onsuccess = (event) => {
                currentSessionId = event.target.result;
                resolve(currentSessionId);
            };
            request.onerror = (event) => reject("Failed to create session: " + event.target.error);
        });
    }

    async function saveMessageToDB(sender, content, sessionId) {
        return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const message = { sessionId, sender, content, timestamp: Date.now() };
            const tx = db.transaction('chat_messages', 'readwrite');
            const request = tx.objectStore('chat_messages').add(message);
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject("Failed to save message: " + event.target.error);
        });
    }

    function startNewChat() {
        currentSessionId = null;
        chatContainer.innerHTML = ''; // Clear UI
        // Add back the welcome message
        chatContainer.insertAdjacentHTML('beforeend', `
            <div id="welcome-message" class="message-bubble flex gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex-shrink-0 flex items-center justify-center font-bold text-white dark:text-indigo-100">AI</div>
                <div class="ai-message rounded-xl p-4 max-w-full prose dark:prose-invert">
                    <p>Selamat datang di versi Ultimate! Saya adalah gabungan dari semua fitur terbaik.</p>
                    <p>Kini Anda bisa melakukan kalkulasi matematika, bermain game, menggunakan utilitas canggih, hingga menyimpan file rahasia Anda. Coba gunakan suara Anda dengan menekan tombol mikrofon!</p>
                    <p>Ketik <a href="#" class="example-link font-semibold">panduan</a> untuk melihat semua yang bisa saya lakukan sekarang.</p>
                </div>
            </div>
            <div id="example-prompts" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4 px-12">
                <button class="example-prompt-button">
                    <div class="font-semibold">Jadwal Sholat</div>
                    <div class="text-sm text-indigo-500 dark:text-indigo-400">Lihat waktu sholat berdasarkan lokasimu</div>
                </button>
                <button class="example-prompt-button">
                    <div class="font-semibold">Game Lempar Dadu</div>
                    <div class="text-sm text-indigo-500 dark:text-indigo-400">Coba keberuntunganmu melempar dadu</div>
                </button>
            </div>
        `);
        expressionEl.focus();
    }

    function loadHistoryToSidebar() {
        const historyList = document.getElementById('history-list');
        if (!db || !historyList) return;

        const tx = db.transaction('chat_sessions', 'readonly');
        const store = tx.objectStore('chat_sessions');
        const request = store.getAll();

        request.onsuccess = () => {
            const sessions = request.result.sort((a, b) => b.timestamp - a.timestamp);
            if (sessions.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-4">Tidak ada riwayat chat.</p>';
            } else {
                historyList.innerHTML = sessions.slice(0, 50).map(session => `
                    <div class="group flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800" onclick="loadChatSession(${session.id})">
                        <span class="text-sm text-gray-700 dark:text-gray-300 truncate" title="${escapeHtml(session.title)}">${escapeHtml(session.title)}</span>
                        <button onclick="event.stopPropagation(); deleteChatSession(${session.id});" title="Hapus Chat" class="opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-400 p-1">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `).join('');
            }
        };
        request.onerror = () => historyList.innerHTML = '<p class="text-red-500 p-4">Gagal memuat riwayat.</p>';
    }

    window.loadChatSession = (sessionId) => {
        if (!db) return;
        const tx = db.transaction('chat_messages', 'readonly');
        const index = tx.objectStore('chat_messages').index('sessionId');
        const request = index.getAll(sessionId);

        request.onsuccess = () => {
            const messages = request.result.sort((a, b) => a.timestamp - b.timestamp);
            chatContainer.innerHTML = ''; // Clear current chat
            messages.forEach(msg => addMessageToUI(msg.sender, msg.content));
            currentSessionId = sessionId;
            historySidebar.classList.add('-translate-x-full');
        };
        request.onerror = () => alert("Gagal memuat chat.");
    }

    window.deleteChatSession = (sessionId) => {
        if (!db || !confirm("Anda yakin ingin menghapus riwayat chat ini?")) return;

        // Delete messages
        const msgTx = db.transaction('chat_messages', 'readwrite');
        const msgStore = msgTx.objectStore('chat_messages');
        const msgIndex = msgStore.index('sessionId');
        const msgRequest = msgIndex.openCursor(IDBKeyRange.only(sessionId));
        msgRequest.onsuccess = (event) => {
            const cursor = event.target.result;
            if (cursor) {
                cursor.delete();
                cursor.continue();
            }
        };

        // Delete session
        const sessionTx = db.transaction('chat_sessions', 'readwrite');
        sessionTx.objectStore('chat_sessions').delete(sessionId);
        sessionTx.oncomplete = () => {
            if (currentSessionId === sessionId) {
                startNewChat();
            }
            loadHistoryToSidebar(); // Refresh sidebar
        };
    }

    // --- History Import/Export ---
    window.exportChatHistory = async () => {
        if (!db) return alert("Database tidak siap.");
        try {
            const sessions = await new Promise((resolve, reject) => {
                const req = db.transaction('chat_sessions', 'readonly').objectStore('chat_sessions').getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
            const messages = await new Promise((resolve, reject) => {
                const req = db.transaction('chat_messages', 'readonly').objectStore('chat_messages').getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });

            const exportData = {
                version: 3,
                exportedAt: new Date().toISOString(),
                sessions,
                messages
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_chat_history_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Riwayat chat berhasil diekspor!");
        } catch (error) {
            alert(`Gagal mengekspor riwayat: ${error.message}`);
        }
    };

    window.importChatHistory = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm("PERINGATAN: Ini akan MENGHAPUS semua riwayat chat yang ada dan menggantinya dengan data dari file. Lanjutkan?")) {
            event.target.value = ''; // Reset file input
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.version || !data.sessions || !data.messages) {
                    throw new Error("Format file tidak valid.");
                }

                const sessionTx = db.transaction('chat_sessions', 'readwrite');
                await sessionTx.objectStore('chat_sessions').clear();
                for (const session of data.sessions) {
                    sessionTx.objectStore('chat_sessions').put(session);
                }

                const messageTx = db.transaction('chat_messages', 'readwrite');
                await messageTx.objectStore('chat_messages').clear();
                for (const message of data.messages) {
                    messageTx.objectStore('chat_messages').put(message);
                }

                alert("Riwayat chat berhasil diimpor! Memuat ulang...");
                loadHistoryToSidebar();
                startNewChat();
            } catch (error) {
                alert(`Gagal mengimpor: ${error.message}`);
            } finally {
                event.target.value = ''; // Reset file input
            }
        };
        reader.readAsText(file);
    };

    window.clearAllChatHistory = async () => {
        if (!db || !confirm("ANDA YAKIN? Semua riwayat chat akan dihapus secara permanen dan tidak bisa dikembalikan.")) return;
        try {
            await db.transaction('chat_sessions', 'readwrite').objectStore('chat_sessions').clear();
            await db.transaction('chat_messages', 'readwrite').objectStore('chat_messages').clear();
            alert("Semua riwayat chat telah dihapus.");
            startNewChat();
            loadHistoryToSidebar();
        } catch (error) {
            alert(`Gagal menghapus riwayat: ${error.message}`);
        }
    };

    // --- Main Input Processor ---
    async function processUserInput(query, isSystemTrigger = false) { // Menjadi async
        if (waitingForApiKey) {
            window.lastUserQuery = query; // Simpan query terakhir
            addMessageToUI('user', '********');
            localStorage.setItem(`${waitingForApiKey}_api_key`, query); 
            const modelName = waitingForApiKey.charAt(0).toUpperCase() + waitingForApiKey.slice(1); 
            updateMessage(addThinkingMessage(`Menyimpan...`), marked.parse(`✅ **API Key ${modelName} berhasil disimpan!**`));
            waitingForApiKey = null;
            return;
        }

        if (!isSystemTrigger) {
            window.lastUserQuery = query; // Simpan query terakhir
            const sessionId = await ensureSession(query);
            addMessageToUI('user', query);
            await saveMessageToDB('user', query, sessionId);
        }

        // Cek toggle Deep Research
        const deepResearchToggle = document.getElementById('deep-research-toggle'); 
        if (deepResearchToggle && deepResearchToggle.checked) {
            searchWithSerper(query);
            return; // Hentikan eksekusi lebih lanjut
        }

        // Cek jika query adalah nama model, dan jika ya, panggil model tersebut
        const modelPrefixMatch = query.match(/^(falcon:|gemini:|claude:|deepseek:|chatgpt:)/i);
        if (!modelPrefixMatch) {
            // Jika tidak ada prefix, dan model aktif adalah model lokal, tangani
            if (['webllm', 'tinylama', 'qwen'].includes(activeModel)) {
                handleLocalModelQuery(query, activeModel); return;
            }
            const activeModelFunction = window[`query${activeModel.charAt(0).toUpperCase() + activeModel.slice(1)}`];
            if (activeModelFunction) {
                activeModelFunction(query);
                return;
            }
        }

        const thinkingId = addThinkingMessage(getDynamicThinkingMessage(query));
        
        // Hide example prompts after first user input
        const examplePrompts = document.getElementById('example-prompts');
        if (examplePrompts) {
            examplePrompts.style.display = 'none';
        }

        await new Promise(resolve => setTimeout(resolve, 300));
        const response = await calculateExpression(query); // Menambahkan await
        let responseContent;
        if (response && response.error) {
            // Jika perintah tidak dikenali, teruskan ke model AI aktif
            const activeModelFunction = window[`query${activeModel.charAt(0).toUpperCase() + activeModel.slice(1)}`];
            if (activeModelFunction) {
                document.getElementById(thinkingId)?.remove(); // Hapus pesan "berpikir" dari fitur internal
                activeModelFunction(query); // Panggil model AI
                return;
            }
            responseContent = marked.parse(`❌ **Error:** ${response.error}`);
        } else {
            responseContent = response.result; // Result is already formatted (HTML or Markdown)
        }
        updateMessage(thinkingId, responseContent);
    }

    // --- Lazy Feature Loading ---
    function createFeaturePlaceholder(title, description, functionName, ...args) {
        const placeholderId = `placeholder-${Date.now()}`;
        // Mengonversi argumen menjadi string yang aman untuk disisipkan ke dalam HTML
        const argsString = args.map(arg => {
            if (typeof arg === 'string') return `'${arg.replace(/'/g, "\\'")}'`;
            return JSON.stringify(arg);
        }).join(',');

        return `
            <div id="${placeholderId}" class="feature-container bg-gray-100 dark:bg-gray-800 p-6 rounded-lg text-center">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">${title}</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 my-3">${description}</p>
                <button onclick="window.loadFeature('${placeholderId}', '${functionName}', ${argsString})" class="interactive-button">
                    🚀 Gunakan Fitur
                </button>
            </div>
        `;
    }

    // --- Command Router ---



   async function calculateExpression(query) {
        const cleanQuery = query.trim().toLowerCase();

        // --- Perintah Download Model Lokal ---
        const downloadMatch = cleanQuery.match(/^download model (gemma|qwen|tinylama|tinylamma)/i);
        if (downloadMatch) {
            let modelType = downloadMatch[1];
            if (modelType === 'gemma') modelType = 'webllm'; // Gemma adalah nama alias untuk WebLLM
            if (modelType === 'tinylamma') modelType = 'tinylama'; // Koreksi typo

            const config = window.modelConfigs[modelType];
            if (window.localModels[config.id]) {
                return { result: marked.parse(`✅ **Model ${config.name} sudah terunduh dan siap digunakan.**`) };
            }
            handleLocalModelDownloadCommand(modelType);
            return { result: null }; // Respons akan ditangani secara asinkron
        }

        // Periksa perintah spesifik 'di mana saya' terlebih dahulu untuk menghindari konflik regex.
        if (cleanQuery === 'di mana saya?' || cleanQuery === 'lokasi saya') return { result: createMyLocationMap() };

        // --- Peningkatan Logika Peta & Lokasi ---
        const mapQueryMatch = query.match(/^(?:di mana|tunjukkan|lokasi|peta untuk)\s+(.+)/i);
        if (mapQueryMatch) {
            const location = mapQueryMatch[1].trim();
            return { result: createGlobalInteractiveMap(location) };
        }

        // Pro Features
        if (cleanQuery === 'panduan' || cleanQuery === 'help') return { result: createHelpGuide() };
        if (cleanQuery.startsWith('peta:') || cleanQuery.startsWith('map:')) return { result: createGlobalInteractiveMap(query.substring(query.indexOf(':') + 1).trim()) };
        if (cleanQuery === 'peta global' || cleanQuery === 'map global') return { result: createGlobalInteractiveMap('world') };
        if (cleanQuery === 'buka file rahasia') return { result: createFileManagerInterface() };
        if (cleanQuery === 'riwayat') return { result: viewHistory() };

                const timeCapsuleMatch = query.match(/^(?:waktu|ingatkan):\s*(.*?)\s*\|\s*(.*)/is);
        if (timeCapsuleMatch) return { result: setTimeCapsule(timeCapsuleMatch[1].trim(), timeCapsuleMatch[2].trim()) };
        if (cleanQuery === 'chat waktu dulu') return { result: viewTimeCapsules() }; 

        const apiKeyMatch = cleanQuery.match(/^apikey\s+(chatgpt|gemini|claude|deepseek|falcon)$/);
        if (apiKeyMatch) {
            waitingForApiKey = apiKeyMatch[1];
            const modelName = apiKeyMatch[1].charAt(0).toUpperCase() + apiKeyMatch[1].slice(1); 
            return { result: marked.parse(`🔑 **Masukkan API key untuk ${modelName}:**`) };
        }

        // Creative & Productivity Features 
        if (cleanQuery.includes('quote') || cleanQuery.includes('kutipan') || cleanQuery.includes('motivasi')) return { result: createRandomQuoteDisplay() };
        if (cleanQuery.includes('kalender')) return { result: createCalendarView() };
        if (cleanQuery.includes('password manager') || cleanQuery.includes('kelola password')) return { result: createPasswordManager() };
        if (cleanQuery.includes('password') || cleanQuery.includes('kata sandi')) return { result: createPasswordGenerator() };        if (cleanQuery.includes('gambar') || cleanQuery.includes('drawing')) return { result: createFeaturePlaceholder('🎨 Kanvas Gambar', 'Siapkan kanvas untuk Anda menggambar.', 'createDrawingCanvas') };
        if (cleanQuery.includes('koding') || cleanQuery.includes('coding')) return { result: createCodingArea() };

        // Interactive Utilities 
        if (cleanQuery.includes('jadwal solat') || cleanQuery.includes('prayer time')) return { result: createLocationBasedPrayerSchedule() };
        if (cleanQuery.includes('kode qr')) return { result: createInteractiveQRCodeGenerator() };
        if (cleanQuery.includes('analisis warna')) return { result: createInteractiveColorAnalyzer() };

                // New API-based Utilities
                if (cleanQuery.startsWith('cuaca') || cleanQuery.startsWith('weather')) return { result: createWeatherForecast(query.substring(query.indexOf(' ')).trim()) };
                if (cleanQuery.startsWith('sunrise') || cleanQuery.startsWith('sunset')) return { result: createSunriseSunset(query.substring(query.indexOf(' ')).trim()) };
                if (cleanQuery.includes('gempa')) return { result: createEarthquakeInfo() };
                if (cleanQuery.startsWith('pokemon')) return { result: createPokemonInfo(query.substring(query.indexOf(' ')).trim()) };
                if (cleanQuery.startsWith('negara') || cleanQuery.startsWith('country')) return { result: createCountryInfo(query.substring(query.indexOf(' ')).trim()) };

        if (cleanQuery.includes('kepribadian acak')) return { result: createInteractivePersonalityGenerator() };
        if (cleanQuery.includes('grafik') || cleanQuery.includes('chart')) return { result: createInteractiveChart() };

        // Search & Organization 
        if (cleanQuery.includes('wikipedia')) return { result: createWikipediaSearch() };
        if (cleanQuery.includes('notepad')) return { result: handleNotepadRequest(cleanQuery) };        if (cleanQuery.includes('todo') || cleanQuery.includes('list') || cleanQuery.includes('trello')) return { result: createFeaturePlaceholder('📋 Papan Tugas', 'Atur pekerjaan Anda dengan papan tugas bergaya Trello.', 'createTrelloInterface') };        if (cleanQuery.startsWith('chatgpt:')) { queryChatGPT(query.substring(8).trim()); return { result: null }; }        if (cleanQuery.startsWith('gemini:')) { queryGemini(query.substring(7).trim()); return { result: null }; }        if (cleanQuery.startsWith('claude:')) { queryClaude(query.substring(7).trim()); return { result: null }; }        if (cleanQuery.startsWith('deepseek:')) { queryDeepSeek(query.substring(9).trim()); return { result: null }; }

        // Time & Date 
        if (cleanQuery.includes('waktu sekarang') || cleanQuery.includes('jam sekarang')) return { result: createCurrentTimeDisplay() };
        if (cleanQuery.includes('bulan sekarang') || cleanQuery.includes('bulan apa')) return { result: createCurrentMonthDisplay() };
        if (cleanQuery.includes('tanggal hari ini') || cleanQuery.includes('tanggal sekarang')) return { result: createCurrentDateDisplay() };

        // Games 
        if (cleanQuery.includes('lempar dadu') || cleanQuery.includes('bermain dadu') || cleanQuery.includes('game lempar dadu')) return { result: createDiceGame() };
        if (cleanQuery.includes('bermain piano')) return { result: createPiano() };
        if (cleanQuery.includes('mengedit nada piano')) return { result: createPianoEditor() };        if (cleanQuery.includes('bermain 2048') || cleanQuery.includes('game 2048')) return { result: createFeaturePlaceholder('🎮 Game 2048', 'Geser dan gabungkan angka untuk mencapai 2048.', 'create2048Game') };
        if (cleanQuery.includes('tictactoe') || cleanQuery.includes('tic tac toe')) return { result: createTicTacToeGame() };
        if (cleanQuery.includes('main ludo')) return { result: createLudoGame() };
        if (cleanQuery.includes('scan file') || cleanQuery.includes('pindai file')) return { result: await createFileScanner() };
        if (cleanQuery.includes('olahraga') || cleanQuery.includes('sports')) return { result: await createSportsTracker() };
        // Trip feature
        if (cleanQuery.startsWith('perjalanan ke:')) return { result: createTripInterface(query.substring(14).trim()) };

        // AI Model Router
        if (cleanQuery.startsWith('falcon:')) { queryFalconAI(query.substring(7).trim()); return { result: null }; }
        if (cleanQuery.startsWith('webllm:')) { handleLocalModelQuery(query.substring(7).trim(), 'webllm'); return { result: null }; }
        if (cleanQuery.startsWith('tinylama:')) { handleLocalModelQuery(query.substring(9).trim(), 'tinylama'); return { result: null }; }
        if (cleanQuery.startsWith('qwen:')) { handleLocalModelQuery(query.substring(5).trim(), 'qwen'); return { result: null }; }
        if (cleanQuery.startsWith('search:') || cleanQuery.startsWith('cari:')) {
            searchWithSerper(query.substring(query.indexOf(':') + 1).trim());
            return { result: null }; // Indicate that the response will be handled asynchronously
        }
        if (cleanQuery.startsWith('set serper key:')) {
            const key = query.substring(15).trim();
            if (key) {
                localStorage.setItem('serper_api_key', key); 
                return { result: marked.parse(`✅ **API Key Serper berhasil disimpan!**\n\nSekarang Anda bisa menggunakan fitur pencarian dengan:\n\`search: [pertanyaan Anda]\``) };
            } else {
                return { error: "Format: set serper key: [API_KEY_ANDA]" };
            }
        }

        // Math Libraries Router
        const nerdamerKeywords = ['solve', 'diff', 'integrate'];
        const bigNumberKeywords = ['bignumber', 'presisi tinggi'];

        if (nerdamerKeywords.some(k => cleanQuery.startsWith(k))) {
            try {
                return { result: marked.parse(`✅ **Hasil Nerdamer:** \`\`\`\n${nerdamer(query).toString()}\n\`\`\``) };
            } catch (e) {
                console.error("Nerdamer Error:", e);
                return { error: `Gagal memproses dengan Nerdamer: ${e.message}` };
            }
        }

        if (bigNumberKeywords.some(k => cleanQuery.includes(k))) {
            if (typeof BigNumber === 'undefined') {
                return { error: "Pustaka BigNumber.js belum siap. Coba lagi sesaat." };
            }
            try {
                // Contoh penggunaan: "bignumber: 0.1 + 0.2"
                const expression = query.substring(query.indexOf(':') + 1).trim();
                const result = new BigNumber(math.evaluate(expression));
                return { result: marked.parse(`✅ **Hasil BigNumber.js (Presisi Tinggi):** \`\`\`\n${result.toString()}\n\`\`\``) };
            } catch (e) {
                return { error: `Gagal memproses dengan BigNumber.js: ${e.message}` };
            }
        }

        // Jika bukan perintah simbolik, coba evaluasi dengan Math.js untuk kalkulasi numerik
        try {
            const result = math.evaluate(query);
            return { result: marked.parse(`✅ **Hasil Math.js:** \`\`\`\n${math.format(result, { precision: 14 })}\n\`\`\``) };
        } catch (e) {
            // Jika semua gagal, anggap sebagai perintah tidak dikenali
        }
        
        return { error: "Perintah tidak dikenali. Ketik 'panduan' untuk bantuan." };
    }

    // --- Piano Feature ---
    let audioContext;
    let activeOscillators = {};
    let pianoSettings = JSON.parse(localStorage.getItem('pianoSettings')) || {
        waveform: 'sine',
        attack: 0.05,
        release: 0.2
    };
    let pianoRecordingState = {
        isRecording: false,
        startTime: 0,
        currentRecording: []
    };

    const noteFrequencies = {
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 
        'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88, 'C5': 523.25
    };

    function playNote(note) {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        const freq = noteFrequencies[note];
        if (!freq || activeOscillators[note]) return;

        if (pianoRecordingState.isRecording) {
            const time = Date.now() - pianoRecordingState.startTime;
            pianoRecordingState.currentRecording.push({ note, time });
        }

        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.type = pianoSettings.waveform;
        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);

        gainNode.connect(audioContext.destination);
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + pianoSettings.attack);

        oscillator.connect(gainNode);
        oscillator.start();

        activeOscillators[note] = { oscillator, gainNode };
    }

    function stopNote(note) {
        const osc = activeOscillators[note];
        if (osc) {
            const releaseTime = audioContext.currentTime + pianoSettings.release;
            osc.gainNode.gain.linearRampToValueAtTime(0, releaseTime);
            osc.oscillator.stop(releaseTime + 0.01);
            delete activeOscillators[note];
        }
    }

    function createPiano() {
        const pianoId = `piano-${Date.now()}`;
        const keys = [
            { note: 'C4', type: 'white' }, { note: 'C#4', type: 'black' }, { note: 'D4', type: 'white' }, { note: 'D#4', type: 'black' }, { note: 'E4', type: 'white' }, { note: 'F4', type: 'white' }, { note: 'F#4', type: 'black' }, { note: 'G4', type: 'white' }, { note: 'G#4', type: 'black' }, { note: 'A4', type: 'white' }, { note: 'A#4', type: 'black' }, { note: 'B4', type: 'white' }, { note: 'C5', type: 'white' }
        ];

        const whiteKeysHtml = keys
            .filter(key => key.type === 'white')
            .map(key => `<div class="piano-key white" data-note="${key.note}">${key.note.slice(0,-1)}</div>`)
            .join('');

        const blackKeysHtml = keys
            .filter(key => key.type === 'black')
            .map(key => `<div class="piano-key black" data-note="${key.note}">${key.note.slice(0,-1)}</div>`)
            .join('');

        setTimeout(() => initializePiano(pianoId), 100);

        return `
            <div class="feature-container text-black dark:text-white bg-gray-200 dark:bg-gray-900" id="${pianoId}">
                <h3 class="text-xl font-bold mb-4 text-center">🎹 Piano Interaktif</h3>
                <div class="piano-container"><div class="piano-keys">${whiteKeysHtml}${blackKeysHtml}</div></div>
                <div class="flex flex-wrap justify-center items-center gap-4 mt-4">
                    <button id="record-btn-${pianoId}" onclick="window.togglePianoRecording('${pianoId}')" class="interactive-button">🔴 Rekam</button>
                    <div class="flex items-center gap-2">
                        <label for="volume-slider-${pianoId}" class="text-sm">🔊</label>
                        <input type="range" id="volume-slider-${pianoId}" min="0" max="1" step="0.1" value="0.5" 
                               oninput="window.changePianoVolume(this.value)" 
                               class="w-24 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    </div>
                    <button onclick="window.playPianoRecording('${pianoId}')" class="interactive-button">▶️ Mainkan</button>
                    <button onclick="window.savePianoRecording()" class="interactive-button bg-green-600 hover:bg-green-700">💾 Simpan Lagu</button>
                </div>
                <div id="saved-songs-container-${pianoId}" class="mt-4">
                    <h4 class="text-md font-semibold mb-2">🎶 Lagu Tersimpan</h4>
                    <div id="saved-songs-list-${pianoId}" class="space-y-2 max-h-40 overflow-y-auto p-2 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        Memuat lagu...
                    </div>
                </div>
            </div>
        `;
    }

    window.changePianoVolume = (volume) => {
        pianoSettings.volume = parseFloat(volume);
        // Note: This only affects future notes. Existing `playNote` would need modification
        // to adjust gain on the fly if we wanted real-time volume change on held notes.
        // For now, this is sufficient.
    }

    window.togglePianoRecording = (pianoId) => {
        const recordBtn = document.getElementById(`record-btn-${pianoId}`);
        pianoRecordingState.isRecording = !pianoRecordingState.isRecording;

        if (pianoRecordingState.isRecording) {
            pianoRecordingState.currentRecording = [];
            pianoRecordingState.startTime = Date.now();
            recordBtn.textContent = '■ Berhenti';
            recordBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        } else {
            recordBtn.textContent = '🔴 Rekam';
            recordBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            if (pianoRecordingState.currentRecording.length > 0) {
                alert(`Rekaman selesai! ${pianoRecordingState.currentRecording.length} nada direkam. Klik 'Mainkan' untuk memutar ulang.`);
            }
        }
    };

    window.playPianoRecording = (pianoId, recording = null) => {
        const songToPlay = recording || pianoRecordingState.currentRecording;
        if (songToPlay.length === 0) {
            alert("Tidak ada rekaman untuk dimainkan.");
            return;
        }

        songToPlay.forEach(noteEvent => {
            setTimeout(() => {
                const keyEl = document.querySelector(`#${pianoId} .piano-key[data-note="${noteEvent.note}"]`);
                playNote(noteEvent.note);
                if (keyEl) keyEl.classList.add('active');

                setTimeout(() => {
                    stopNote(noteEvent.note);
                    if (keyEl) keyEl.classList.remove('active');
                }, 300); // Durasi nada saat playback
            }, noteEvent.time);
        });
    };

    window.savePianoRecording = () => {
        if (pianoRecordingState.currentRecording.length === 0) {
            alert("Tidak ada yang direkam untuk disimpan.");
            return;
        }
        const songName = prompt("Beri nama lagu Anda:", `Lagu ${moment().format('HH:mm')}`);
        if (!songName || !db) return;

        const songData = { name: songName, recording: pianoRecordingState.currentRecording, createdAt: Date.now() };
        const tx = db.transaction('piano_songs', 'readwrite');
        tx.objectStore('piano_songs').add(songData);
        tx.oncomplete = () => {
            alert(`Lagu "${songName}" berhasil disimpan!`);
            loadSavedPianoSongs();
        };
    };

    function loadSavedPianoSongs() {
        const listContainer = document.querySelector('[id^="saved-songs-list-"]');
        if (!listContainer || !db) return;

        const tx = db.transaction('piano_songs', 'readonly');
        const request = tx.objectStore('piano_songs').getAll();
        request.onsuccess = () => {
            const songs = request.result.sort((a, b) => b.createdAt - a.createdAt);
            if (songs.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500">Belum ada lagu yang disimpan.</p>';
            } else {
                listContainer.innerHTML = songs.map(song => `
                    <div class="flex items-center justify-between bg-gray-200 dark:bg-gray-700 p-2 rounded text-sm">
                        <span>${escapeHtml(song.name)} <em class="text-xs text-gray-500 dark:text-gray-400">- ${moment(song.createdAt).fromNow()}</em></span>
                        <div class="flex gap-2">
                           <button onclick='window.playPianoRecording(this.closest("[id^=piano-]").id, ${JSON.stringify(song.recording)})' class="text-green-500 hover:text-green-400">▶️</button>
                           <button onclick="window.deletePianoSong(${song.id})" class="text-red-500 hover:text-red-400">🗑️</button>
                        </div>
                    </div>`).join('');
            }
        };
    }

    window.deletePianoSong = (songId) => {
        if (!confirm("Hapus lagu ini?") || !db) return;
        const tx = db.transaction('piano_songs', 'readwrite');
        tx.objectStore('piano_songs').delete(songId);
        tx.oncomplete = loadSavedPianoSongs;
    };

    function initializePiano(pianoId) {
        const pianoEl = document.getElementById(pianoId);
        if (!pianoEl) return;
        pianoEl.querySelectorAll('.piano-key').forEach(key => {
            const note = key.dataset.note;
            const start = (e) => { e.preventDefault(); playNote(note); key.classList.add('active'); };
            const end = (e) => { e.preventDefault(); stopNote(note); key.classList.remove('active'); };

            key.addEventListener('mousedown', start);
            key.addEventListener('mouseup', end);
            key.addEventListener('mouseleave', end);
            key.addEventListener('touchstart', start, { passive: false });
            key.addEventListener('touchend', end, { passive: false });
        });
        loadSavedPianoSongs(); // Muat lagu saat piano diinisialisasi
    }

    function createPianoEditor() {
        pianoSettings.waveform = prompt("Pilih bentuk gelombang suara (waveform):\nsine, square, sawtooth, triangle", pianoSettings.waveform) || pianoSettings.waveform;
        localStorage.setItem('pianoSettings', JSON.stringify(pianoSettings));
        return marked.parse(`✅ **Nada Piano Diubah!**\n\nBentuk gelombang suara piano sekarang diatur ke \`${pianoSettings.waveform}\`. Coba mainkan lagi dengan perintah \`bermain piano\`.`);
    }

    // --- ENHANCED MAP & PRAYER SCHEDULE ---
    function createGlobalInteractiveMap(location = '') {
        const mapId = `map-${Date.now()}`;
        const searchTerm = location === 'world' ? '' : (location || '');
        
        const html = `
            <div class="p-6 rounded-lg text-black">
                <h3 class="text-xl font-bold mb-4">🌍 Peta Global Interaktif</h3>
                <div class="mb-4 flex gap-2">
                    <input type="text" id="map-search-${mapId}" placeholder="Cari lokasi di seluruh dunia..." 
                           class="interactive-input flex-1" value="${escapeHtml(location)}">
                    <button onclick="searchMapLocation('${mapId}')" class="interactive-button">🔍 Cari</button>
                    <button onclick="getCurrentLocation('${mapId}')" class="interactive-button">📍 Lokasi Saya</button>
                    <button onclick="window.startTripFromMap('${mapId}')" class="interactive-button bg-green-600 hover:bg-green-700">🚀 Mulai Perjalanan</button>
                </div>
                <div id="${mapId}" class="map-container"></div>
                <div class="mt-4 grid grid-cols-3 gap-2">
                    <button onclick="goToLocation('${mapId}', 'Jakarta, Indonesia')" class="interactive-button text-sm">🇮🇩 Jakarta</button>
                    <button onclick="goToLocation('${mapId}', 'New York, USA')" class="interactive-button text-sm">🇺🇸 New York</button>
                    <button onclick="goToLocation('${mapId}', 'Tokyo, Japan')" class="interactive-button text-sm">🇯🇵 Tokyo</button>
                    <button onclick="goToLocation('${mapId}', 'London, UK')" class="interactive-button text-sm">🇬🇧 London</button>
                    <button onclick="goToLocation('${mapId}', 'Paris, France')" class="interactive-button text-sm">🇫🇷 Paris</button>
                    <button onclick="goToLocation('${mapId}', 'Sydney, Australia')" class="interactive-button text-sm">🇦🇺 Sydney</button>
                </div>
                <div id="map-info-${mapId}" class="mt-4 text-sm"></div>
            </div>
        `;

        setTimeout(() => {
            try {
                const map = L.map(mapId, {
                    center: [0, 0],
                    zoom: 2,
                    zoomControl: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    keyboard: true
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                window.activeMaps[mapId] = { map, markers: [] };

                if (searchTerm && searchTerm !== 'world') {
                    searchMapLocation(mapId, searchTerm);
                }

                // Add click event to get coordinates
                map.on('click', function(e) {
                    const lat = e.latlng.lat.toFixed(6);
                    const lng = e.latlng.lng.toFixed(6);
                    const infoDiv = document.getElementById(`map-info-${mapId}`);
                    if (infoDiv) {
                        infoDiv.innerHTML = `<div class="bg-blue-600 p-2 rounded">📍 Koordinat: ${lat}, ${lng}</div>`;
                    }
                });

            } catch (error) {
                console.error('Error creating map:', error);
                document.getElementById(mapId).innerHTML = '<p class="text-red-400">Gagal memuat peta. Coba muat ulang halaman.</p>';
            }
        }, 100);

        return html;
    }

    function createMyLocationMap() {
        const mapId = `map-${Date.now()}`;
        const html = `
            <div class="p-6 rounded-lg text-black">
                <h3 class="text-xl font-bold mb-4">📍 Lokasi Anda Saat Ini</h3>
                <div id="${mapId}" class="map-container"></div>
                <div id="map-info-${mapId}" class="mt-4 text-sm">Meminta izin lokasi dan mencari...</div>
            </div>
        `;
        setTimeout(() => getCurrentLocation(mapId, true), 100); // `true` untuk reverse geocode
        return html;
    }

    window.searchMapLocation = async function(mapId, customLocation = null) {
        const searchInput = document.getElementById(`map-search-${mapId}`);
        const query = customLocation || searchInput?.value;
        
        if (!query) return;

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const data = await response.json();
            
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                
                const mapData = window.activeMaps[mapId];
                if (mapData) {
                    // Clear existing markers
                    mapData.markers.forEach(marker => mapData.map.removeLayer(marker));
                    mapData.markers = [];
                    
                    // Add new marker
                    const marker = L.marker([lat, lng]).addTo(mapData.map)
                        .bindPopup(`<b>${result.display_name}</b>`)
                        .openPopup();
                    
                    mapData.markers.push(marker);
                    mapData.map.setView([lat, lng], 10);
                    
                    const infoDiv = document.getElementById(`map-info-${mapId}`);
                    const locationDescription = `Ditemukan: ${result.display_name}`;
                    if (infoDiv) {
                        infoDiv.innerHTML = `<div class="bg-green-600 p-2 rounded">✅ ${locationDescription}</div>`;
                    }
                    // Baca deskripsi lokasi dengan suara
                    speakText(locationDescription);
                }
            } else {
                const infoDiv = document.getElementById(`map-info-${mapId}`);
                if (infoDiv) {
                    infoDiv.innerHTML = `<div class="bg-red-600 p-2 rounded">❌ Lokasi tidak ditemukan</div>`;
                }
                speakText(`Maaf, lokasi untuk ${query} tidak ditemukan.`);
            }
        } catch (error) {
            console.error('Error searching location:', error);
        }
    };

    window.getCurrentLocation = function(mapId, shouldReverseGeocode = false) {
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    const mapData = window.activeMaps[mapId];
                    if (mapData) {
                        // Clear existing markers
                        mapData.markers.forEach(marker => mapData.map.removeLayer(marker));
                        mapData.markers = [];
                        
                        // Add current location marker
                        const marker = L.marker([lat, lng]).addTo(mapData.map)
                            .bindPopup('<b>📍 Lokasi Anda</b>')
                            .openPopup();
                        
                        mapData.markers.push(marker);
                        mapData.map.setView([lat, lng], 12);
                        
                        const infoDiv = document.getElementById(`map-info-${mapId}`);
                        const locationText = `Lokasi Anda saat ini berada di koordinat ${lat.toFixed(4)}, ${lng.toFixed(4)}.`;
                        if (infoDiv) infoDiv.innerHTML = `<div class="bg-blue-600 p-2 rounded">📍 ${locationText}</div>`;

                        if (shouldReverseGeocode) {
                            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                                .then(res => res.json())
                                .then(data => {
                                    const address = data.display_name || "Alamat tidak diketahui";
                                    const fullDescription = `${locationText} Diperkirakan berada di sekitar ${address}.`;
                                    if (infoDiv) infoDiv.innerHTML = `<div class="bg-blue-600 p-2 rounded">📍 ${fullDescription}</div>`;
                                    speakText(fullDescription);
                                })
                                .catch(() => speakText(locationText)); // Baca koordinat jika geocode gagal
                        } else {
                            speakText(locationText);
                        }

                    }
                },
                (error) => {
                    const infoDiv = document.getElementById(`map-info-${mapId}`);
                    if (infoDiv) {
                        infoDiv.innerHTML = `<div class="bg-red-600 p-2 rounded">❌ Gagal mendapatkan lokasi: ${error.message}</div>`;
                    }
                }
            );
        } else {
            const infoDiv = document.getElementById(`map-info-${mapId}`);
            if (infoDiv) {
                infoDiv.innerHTML = `<div class="bg-red-600 p-2 rounded">❌ Geolocation tidak didukung browser</div>`;
            }
        }
    };

    window.goToLocation = function(mapId, location) {
        const searchInput = document.getElementById(`map-search-${mapId}`);
        if (searchInput) searchInput.value = location;
        searchMapLocation(mapId, location);
    };

    window.startTripFromMap = function(mapId) {
        const searchInput = document.getElementById(`map-search-${mapId}`);
        const destination = searchInput.value.trim();
        if (!destination) {
            alert('Silakan masukkan tujuan perjalanan di kotak pencarian terlebih dahulu.');
            return;
        }
        // Panggil fungsi yang membuat UI perjalanan
        const tripHtml = createTripInterface(destination);
        addMessageToUI('ai', tripHtml);
    };
    // --- LOCATION-BASED PRAYER SCHEDULE ---
    function createLocationBasedPrayerSchedule() {
        const scheduleId = `prayer-${Date.now()}`;
        
        const html = `
            <div class="p-4 rounded-lg text-white">
                <h3 class="text-xl font-bold mb-4">🕌 Jadwal Sholat</h3>
                <div class="mb-4 flex gap-2">
                    <button onclick="getPrayerByLocation('${scheduleId}')" class="interactive-button bg-sky-600 hover:bg-sky-700">📍 Lokasi Saya</button>
                    <input type="text" id="city-input-${scheduleId}" placeholder="Atau ketik nama kota..." class="interactive-input flex-1">
                    <button onclick="getPrayerByCity('${scheduleId}')" class="interactive-button">🔍 Cari</button>
                </div>
                <div id="prayer-result-${scheduleId}" class="text-center py-8">
                    📍 Klik tombol di atas untuk mendapatkan jadwal sholat
                </div>
                <div id="location-info-${scheduleId}" class="mt-4 text-sm"></div>
            </div>
        `;

        return html;
    }

    window.getPrayerByLocation = function(scheduleId) {
        const resultDiv = document.getElementById(`prayer-result-${scheduleId}`);
        const locationDiv = document.getElementById(`location-info-${scheduleId}`);
        
        resultDiv.innerHTML = '<div class="text-sky-400">🔄 Mendapatkan lokasi Anda...</div>';
        
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    try {
                        // Get city name from coordinates
                        const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                        const geoData = await geoResponse.json();
                        const cityName = geoData.address?.city || geoData.address?.town || geoData.address?.village || 'Unknown';
                        
                        locationDiv.innerHTML = `<div class="bg-sky-800 p-2 rounded text-sky-200">📍 Lokasi: ${cityName} (${lat.toFixed(4)}, ${lng.toFixed(4)})</div>`;
                        
                        // Get prayer times using Aladhan API
                        const today = new Date();
                        const dateStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                        
                        const prayerResponse = await fetch(`https://api.aladhan.com/v1/timings/${dateStr}?latitude=${lat}&longitude=${lng}&method=20`);
                        const prayerData = await prayerResponse.json();
                        
                        if (prayerData.code === 200) {
                            displayPrayerTimes(scheduleId, prayerData.data, cityName);
                        } else {
                            resultDiv.innerHTML = '<div class="text-red-400">❌ Gagal mendapatkan jadwal sholat</div>';
                        }
                        
                    } catch (error) {
                        console.error('Error getting prayer times:', error);
                        resultDiv.innerHTML = '<div class="text-red-400">❌ Terjadi kesalahan saat mengambil data</div>';
                    }
                },
                (error) => {
                    resultDiv.innerHTML = `<div class="text-red-400">❌ Gagal mendapatkan lokasi: ${error.message}</div>`;
                    locationDiv.innerHTML = '<div class="bg-red-800 p-2 rounded text-red-200">❌ Akses lokasi ditolak</div>';
                }
            );
        } else {
            resultDiv.innerHTML = '<div class="text-red-400">❌ Geolocation tidak didukung browser</div>';
        }
    };

    window.getPrayerByCity = async function(scheduleId) {
        const cityInput = document.getElementById(`city-input-${scheduleId}`);
        const city = cityInput?.value.trim();
        
        if (!city) return;
        
        const resultDiv = document.getElementById(`prayer-result-${scheduleId}`);
        const locationDiv = document.getElementById(`location-info-${scheduleId}`);
        
        resultDiv.innerHTML = `<div class="text-sky-400">🔄 Mencari jadwal untuk ${escapeHtml(city)}...</div>`;
        
        try {
            // Get coordinates from city name
            const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
            const geoData = await geoResponse.json();
            
            if (geoData && geoData.length > 0) {
                const lat = parseFloat(geoData[0].lat);
                const lng = parseFloat(geoData[0].lon);
                
                locationDiv.innerHTML = `<div class="bg-green-800 p-2 rounded text-green-200">📍 Ditemukan: ${geoData[0].display_name}</div>`;
                
                // Get prayer times
                const today = new Date();
                const dateStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                
                const prayerResponse = await fetch(`https://api.aladhan.com/v1/timings/${dateStr}?latitude=${lat}&longitude=${lng}&method=20`);
                const prayerData = await prayerResponse.json();
                
                if (prayerData.code === 200) {
                    displayPrayerTimes(scheduleId, prayerData.data, city);
                } else {
                    resultDiv.innerHTML = '<div class="text-red-400">❌ Gagal mendapatkan jadwal sholat</div>';
                }
            } else {
                resultDiv.innerHTML = '<div class="text-red-400">❌ Kota tidak ditemukan</div>';
                locationDiv.innerHTML = '<div class="bg-red-800 p-2 rounded text-red-200">❌ Lokasi tidak ditemukan</div>';
            }
            
        } catch (error) {
            console.error('Error getting prayer times:', error);
            resultDiv.innerHTML = '<div class="text-red-400">❌ Terjadi kesalahan saat mengambil data</div>';
        }
    };

    function displayPrayerTimes(scheduleId, data, cityName) {
        const resultDiv = document.getElementById(`prayer-result-${scheduleId}`);
        const timings = data.timings;
        const date = data.date.readable;
        
        const prayerNames = {
            'Fajr': '🌅 Subuh',
            'Sunrise': '🌅 Syuruq', 
            'Dhuhr': '🌞 Dzuhur',
            'Asr': '🌇 Ashar',
            'Maghrib': '🌆 Maghrib',
            'Isha': '🌙 Isya'
        };
        
        let html = `
            <div class="text-center mb-4 text-white">
                <h4 class="text-lg font-bold">${cityName}</h4>
                <p class="text-sm text-slate-300">${date}</p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        `;
        
        Object.entries(prayerNames).forEach(([key, name]) => {
            if (timings[key]) {
                html += `
                    <div class="bg-slate-700 p-3 rounded-lg text-center text-white shadow-md">
                        <div class="text-sm font-medium text-slate-300">${name}</div>
                        <div class="text-2xl font-bold tracking-wider">${timings[key]}</div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        resultDiv.innerHTML = html;
    }

    // --- ZENQUOTES INTEGRATION ---
    function createRandomQuoteDisplay() {
        const quoteId = `quote-${Date.now()}`;
        
        const html = `
            <div class="p-6 rounded-lg text-white">
                <h3 class="text-xl font-bold mb-4">💎 Quote Inspiratif</h3>
                <div id="quote-content-${quoteId}" class="text-center py-8">
                    <div class="text-blue-400">🔄 Mengambil quote inspiratif...</div>
                </div>
                <div class="flex gap-2 mt-4 justify-center">
                    <button onclick="getRandomQuote('${quoteId}')" class="interactive-button">🎲 Quote Baru</button>
                    <button onclick="saveQuoteToFavorites('${quoteId}')" class="interactive-button">💾 Simpan</button> 
                    <button onclick="shareQuote('${quoteId}')" class="interactive-button">📤 Bagikan</button>
                </div>
                <div id="quote-favorites-${quoteId}" class="mt-4">
                    <h4 class="text-sm font-semibold mb-2">📚 Quote Favorit:</h4>
                    <div id="favorites-list-${quoteId}" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        `;

        // Auto-load first quote
        setTimeout(() => getRandomQuote(quoteId), 100);
        setTimeout(() => loadFavoriteQuotes(quoteId), 200);

        return html;
    }

    window.getRandomQuote = async function(quoteId) {
        const contentDiv = document.getElementById(`quote-content-${quoteId}`);
        
        // The ZenQuotes API was causing unwanted redirects. 
        // Switched to a local fallback to prevent this security issue.
        // The original try-catch block is now replaced with a direct call to the fallback.
        
        // try {
        //     ... (original ZenQuotes fetch logic was here) ...
        // } catch (error) {

            // Fallback to local inspirational quotes
            console.log('Using local fallback quotes to avoid external API issues.');
            const fallbackQuotes = [
                { q: "Sebuah perjalanan seribu mil dimulai dengan satu langkah.", a: "Lao Tzu" },
                { q: "Sukses adalah kemampuan untuk bergerak dari satu kegagalan ke kegagalan lain tanpa kehilangan semangat.", a: "Winston Churchill" },
                { q: "Satu-satunya cara untuk melakukan pekerjaan yang luar biasa adalah dengan mencintai apa yang Anda lakukan.", a: "Steve Jobs" },
                { q: "Masa depan milik mereka yang percaya pada keindahan mimpi mereka.", a: "Eleanor Roosevelt" },
                { q: "Jangan menunggu kesempatan. Ciptakanlah.", a: "George Bernard Shaw" },
                { q: "Keberanian bukan berarti tidak takut, tetapi menghadapi ketakutan itu.", a: "Nelson Mandela" },
                { q: "Pendidikan adalah senjata paling kuat yang bisa Anda gunakan untuk mengubah dunia.", a: "Nelson Mandela" },
                { q: "Hidup adalah 10% apa yang terjadi pada Anda dan 90% bagaimana Anda meresponsnya.", a: "Charles R. Swindoll" }
            ];
            
            const randomQuote = fallbackQuotes[Math.floor(Math.random() * fallbackQuotes.length)];
            displayQuote(quoteId, randomQuote.q, randomQuote.a, 'Local Collection');
        // } // End of original catch block
    };

    function displayQuote(quoteId, text, author, source) {
        const contentDiv = document.getElementById(`quote-content-${quoteId}`);
        
        const html = `
            <div class="quote-display">
                <div class="text-4xl mb-4 text-center text-indigo-300">"</div>
                <blockquote class="text-xl italic text-slate-200 mb-4 leading-relaxed text-center">
                    "${text}"
                </blockquote>
                <div class="text-right mt-4">
                    <cite class="font-semibold">— ${author}</cite>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Source: ${source}</div>
                </div>
            </div>
        `;
        
        contentDiv.innerHTML = html;
        
        // Store current quote for saving/sharing
        window.currentQuote = { text, author, source };
    }

    window.saveQuoteToFavorites = function(quoteId) {
        if (!window.currentQuote) return;
        
        let favorites = JSON.parse(localStorage.getItem('favoriteQuotes') || '[]');
        const newQuote = {
            id: Date.now(),
            ...window.currentQuote,
            savedAt: new Date().toLocaleDateString('id-ID')
        };
        
        // Check if already exists
        const exists = favorites.some(q => q.text === newQuote.text);
        if (exists) {
            alert('Quote ini sudah ada di favorit!');
            return;
        }
        
        favorites.unshift(newQuote);
        if (favorites.length > 10) favorites = favorites.slice(0, 10); // Keep only 10 favorites
        
        localStorage.setItem('favoriteQuotes', JSON.stringify(favorites));
        loadFavoriteQuotes(quoteId);
        
        // Show success message
        const contentDiv = document.getElementById(`quote-content-${quoteId}`);
        const originalContent = contentDiv.innerHTML;
        contentDiv.innerHTML = '<div class="text-green-400 text-center py-4">✅ Quote berhasil disimpan ke favorit!</div>';
        setTimeout(() => contentDiv.innerHTML = originalContent, 2000);
    };

    window.shareQuote = function(quoteId) {
        if (!window.currentQuote) return;
        
        const shareText = `"${window.currentQuote.text}" — ${window.currentQuote.author}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Quote Inspiratif',
                text: shareText
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Quote berhasil disalin ke clipboard!');
            }).catch(() => {
                // Create temporary textarea for copying
                const textarea = document.createElement('textarea');
                textarea.value = shareText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Quote berhasil disalin ke clipboard!');
            });
        }
    };

    function loadFavoriteQuotes(quoteId) {
        const favoritesDiv = document.getElementById(`favorites-list-${quoteId}`);
        const favorites = JSON.parse(localStorage.getItem('favoriteQuotes') || '[]');
        
        if (favorites.length === 0) {
            favoritesDiv.innerHTML = '<div class="text-sm">Belum ada quote favorit</div>';
            return;
        }
        
        const html = favorites.map(quote => `
            <div class="bg-slate-700 p-2 rounded text-sm text-slate-200">
                <div class="italic">"${quote.text.substring(0, 80)}${quote.text.length > 80 ? '...' : ''}"</div>
                <div class="text-xs mt-1">— ${quote.author}</div>
                <div class="flex justify-between items-center mt-1">
                    <span class="text-gray-500 dark:text-gray-400 text-xs">${quote.savedAt}</span>
                    <button onclick="removeFavoriteQuote(${quote.id}, '${quoteId}')" class="text-red-400 hover:text-red-300 text-xs">🗑️</button>
                </div>
            </div>
        `).join('');
        
        favoritesDiv.innerHTML = html;
    }

    window.removeFavoriteQuote = function(quoteId, containerId) {
        let favorites = JSON.parse(localStorage.getItem('favoriteQuotes') || '[]');
        favorites = favorites.filter(q => q.id !== quoteId);
        localStorage.setItem('favoriteQuotes', JSON.stringify(favorites));
        loadFavoriteQuotes(containerId);
    };

    // --- ENHANCED PASSWORD MANAGER ---
    function createPasswordManager() {
        const managerId = `password-mgr-${Date.now()}`;
        
        const html = `
            <div class="p-6 rounded-lg text-white">
                <h3 class="text-xl font-bold mb-4">🔒 Password Manager Aman</h3>
                
                <!-- Master Password -->
                <div id="master-password-${managerId}" class="mb-6">
                    <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded mb-3">
                        <p class="text-yellow-100 text-sm">⚠️ Masukkan master password untuk mengakses data:</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" id="master-pwd-${managerId}" placeholder="Master Password" class="interactive-input flex-1">
                        <button onclick="unlockPasswordManager('${managerId}')" class="interactive-button">🔓 Buka</button>
                        <button onclick="setMasterPassword('${managerId}')" class="interactive-button">🔑 Set Master</button>
                    </div>
                </div>
                
                <!-- Password Manager Interface (Hidden Initially) -->
                <div id="password-interface-${managerId}" style="display: none;">
                    <!-- Add New Password -->
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded mb-4">
                        <h4 class="text-lg font-semibold text-black mb-3">➕ Tambah Password Baru</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="pwd-website-${managerId}" placeholder="Website/Aplikasi" class="interactive-input">
                            <input type="text" id="pwd-username-${managerId}" placeholder="Username/Email" class="interactive-input">
                            <input type="password" id="pwd-password-${managerId}" placeholder="Password" class="interactive-input">
                            <input type="text" id="pwd-notes-${managerId}" placeholder="Catatan (opsional)" class="interactive-input">
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="generateRandomPassword('${managerId}')" class="interactive-button">🎲 Generate</button>
                            <button onclick="savePassword('${managerId}')" class="interactive-button">💾 Simpan</button>
                        </div>
                    </div>
                    
                    <!-- Search -->
                    <div class="mb-4">
                        <input type="text" id="search-passwords-${managerId}" placeholder="Cari password..." class="interactive-input" oninput="searchPasswords('${managerId}')">
                    </div>
                    
                    <!-- Password List -->
                    <div id="password-list-${managerId}" class="space-y-3 max-h-80 overflow-y-auto">
                        <div class="text-center">Loading passwords...</div>
                    </div>
                    
                    <!-- Security Actions -->
                    <div class="mt-4 flex gap-2">
                        <button onclick="exportPasswords('${managerId}')" class="interactive-button text-sm">📥 Export</button>
                        <button onclick="importPasswords('${managerId}')" class="interactive-button text-sm">📤 Import</button>
                        <button onclick="clearAllPasswords('${managerId}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">🗑️ Clear All</button>
                    </div>
                </div>
            </div>
        `;
        
        return html;
    }

    // Simple encryption/decryption (for demo purposes)
    function simpleEncrypt(text, key) {
        let result = '';
        for (let i = 0; i < text.length; i++) {
            result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return btoa(result);
    }

    function simpleDecrypt(encryptedText, key) {
        const text = atob(encryptedText);
        let result = '';
        for (let i = 0; i < text.length; i++) {
            result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return result;
    }

    window.setMasterPassword = function(managerId) {
        const masterPwd = document.getElementById(`master-pwd-${managerId}`).value;
        if (masterPwd.length < 6) {
            alert('Master password harus minimal 6 karakter!');
            return;
        }
        localStorage.setItem('masterPasswordHash', btoa(masterPwd));
        alert('Master password berhasil di-set!');
    };

    window.unlockPasswordManager = function(managerId) {
        const masterPwd = document.getElementById(`master-pwd-${managerId}`).value;
        const storedHash = localStorage.getItem('masterPasswordHash');
        
        if (!storedHash) {
            alert('Belum ada master password. Klik "Set Master" untuk membuat.');
            return;
        }
        
        if (btoa(masterPwd) === storedHash) {
            document.getElementById(`master-password-${managerId}`).style.display = 'none';
            document.getElementById(`password-interface-${managerId}`).style.display = 'block';
            window.currentMasterKey = masterPwd;
            loadPasswords(managerId);
        } else {
            alert('Master password salah!');
        }
    };

    window.generateRandomPassword = function(managerId) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        for (let i = 0; i < 16; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById(`pwd-password-${managerId}`).value = password;
    };

    window.savePassword = function(managerId) {
        const website = document.getElementById(`pwd-website-${managerId}`).value;
        const username = document.getElementById(`pwd-username-${managerId}`).value;
        const password = document.getElementById(`pwd-password-${managerId}`).value;
        const notes = document.getElementById(`pwd-notes-${managerId}`).value;
        
        if (!website || !username || !password) {
            alert('Website, username, dan password harus diisi!');
            return;
        }
        
        const passwordData = {
            id: Date.now(),
            website,
            username,
            password: simpleEncrypt(password, window.currentMasterKey),
            notes: notes ? simpleEncrypt(notes, window.currentMasterKey) : '',
            createdAt: new Date().toLocaleDateString('id-ID')
        };
        
        let passwords = JSON.parse(localStorage.getItem('savedPasswords') || '[]');
        passwords.unshift(passwordData);
        localStorage.setItem('savedPasswords', JSON.stringify(passwords));
        
        // Clear form
        document.getElementById(`pwd-website-${managerId}`).value = '';
        document.getElementById(`pwd-username-${managerId}`).value = '';
        document.getElementById(`pwd-password-${managerId}`).value = '';
        document.getElementById(`pwd-notes-${managerId}`).value = '';
        
        loadPasswords(managerId);
        alert('Password berhasil disimpan!');
    };

    function loadPasswords(managerId) {
        const passwords = JSON.parse(localStorage.getItem('savedPasswords') || '[]');
        const listDiv = document.getElementById(`password-list-${managerId}`);
        
        if (passwords.length === 0) {
            listDiv.innerHTML = '<div class="text-center text-slate-400">Belum ada password tersimpan</div>';
            return;
        }
        
        const html = passwords.map(pwd => {
            const decryptedPassword = simpleDecrypt(pwd.password, window.currentMasterKey);
            const decryptedNotes = pwd.notes ? simpleDecrypt(pwd.notes, window.currentMasterKey) : '';
            
            return `
                <div class="bg-slate-700 p-3 rounded text-slate-200">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-semibold">${pwd.website}</h5>
                            <p class="text-sm">${pwd.username}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <input type="password" value="${decryptedPassword}" readonly class="interactive-input text-sm flex-1" id="pwd-field-${pwd.id}">
                                <button onclick="togglePasswordVisibility('${pwd.id}')" class="text-blue-400 hover:text-blue-300 text-sm">👁️</button>
                                <button onclick="copyToClipboard('${decryptedPassword}')" class="text-green-400 hover:text-green-300 text-sm">📋</button>
                            </div>
                            ${decryptedNotes ? `<p class="text-gray-500 dark:text-gray-400 text-xs mt-1">${decryptedNotes}</p>` : ''}
                            <p class="text-gray-400 dark:text-gray-500 text-xs mt-1">Dibuat: ${pwd.createdAt}</p>
                        </div>
                        <button onclick="deletePassword('${pwd.id}', '${managerId}')" class="text-red-400 hover:text-red-300 ml-3">🗑️</button>
                    </div>
                </div>
            `;
        }).join('');
        
        listDiv.innerHTML = html;
    }

    window.togglePasswordVisibility = function(id) {
        const field = document.getElementById(`pwd-field-${id}`);
        field.type = field.type === 'password' ? 'text' : 'password';
    };

    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Password berhasil disalin!');
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Password berhasil disalin!');
        });
    };

    window.deletePassword = function(id, managerId) {
        if (confirm('Hapus password ini?')) {
            let passwords = JSON.parse(localStorage.getItem('savedPasswords') || '[]');
            passwords = passwords.filter(p => p.id != id);
            localStorage.setItem('savedPasswords', JSON.stringify(passwords));
            loadPasswords(managerId);
        }
    };

    window.searchPasswords = function(managerId) {
        const query = document.getElementById(`search-passwords-${managerId}`).value.toLowerCase();
        const passwords = JSON.parse(localStorage.getItem('savedPasswords') || '[]');
        const filtered = passwords.filter(p => 
            p.website.toLowerCase().includes(query) || 
            p.username.toLowerCase().includes(query)
        );
        
        const listDiv = document.getElementById(`password-list-${managerId}`);
        
        if (filtered.length === 0) {
            listDiv.innerHTML = '<div class="text-center text-slate-400">Tidak ada password yang cocok</div>';
            return;
        }
        
        // Re-render filtered results (similar to loadPasswords but with filtered data)
        const html = filtered.map(pwd => {
            const decryptedPassword = simpleDecrypt(pwd.password, window.currentMasterKey);
            const decryptedNotes = pwd.notes ? simpleDecrypt(pwd.notes, window.currentMasterKey) : '';
            
            return `
                <div class="bg-slate-700 p-3 rounded text-slate-200">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-semibold">${pwd.website}</h5>
                            <p class="text-sm">${pwd.username}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <input type="password" value="${decryptedPassword}" readonly class="interactive-input text-sm flex-1" id="pwd-field-${pwd.id}">
                                <button onclick="togglePasswordVisibility('${pwd.id}')" class="text-blue-400 hover:text-blue-300 text-sm">👁️</button>
                                <button onclick="copyToClipboard('${decryptedPassword}')" class="text-green-400 hover:text-green-300 text-sm">📋</button>
                            </div>
                            ${decryptedNotes ? `<p class="text-gray-500 dark:text-gray-400 text-xs mt-1">${decryptedNotes}</p>` : ''}
                            <p class="text-gray-400 dark:text-gray-500 text-xs mt-1">Dibuat: ${pwd.createdAt}</p>
                        </div>
                        <button onclick="deletePassword('${pwd.id}', '${managerId}')" class="text-red-400 hover:text-red-300 ml-3">🗑️</button>
                    </div>
                </div>
            `;
        }).join('');
        
        listDiv.innerHTML = html;
    };

    // --- SERPER API INTEGRATION ---
    async function searchWithSerper(query) {
        const thinkingId = addThinkingMessage(`Mencari informasi tentang: "${escapeHtml(query)}" menggunakan AI search...`);
        
        // Check search limit
        const today = new Date().toDateString();
        const searchData = JSON.parse(localStorage.getItem('serperSearchData') || '{}');
        
        if (searchData.date !== today) {
            searchData.date = today;
            searchData.count = 0;
        }
        
        if (searchData.count >= 6) {
            updateMessage(thinkingId, marked.parse(`❌ **Batas Pencarian Harian Tercapai**\n\nAnda telah menggunakan 6 pencarian hari ini. Coba lagi besok!\n\n*Reset: setiap hari pada 00:00*`));
            return;
        }
        
        // SECURITY WARNING: API key should be moved to server-side in production
        // For demo purposes only - in production, use environment variables or server proxy
        let apiKey = localStorage.getItem('serper_api_key');
        
        if (!apiKey) {
            // Gunakan kunci demo jika tidak ada yang diatur oleh pengguna
            apiKey = '020f3353222d8452dd004affdca0b73a843c85ea';
        }
        
        try {
            const response = await fetch('https://google.serper.dev/search', {
                method: 'POST',
                headers: {
                    'X-API-KEY': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    q: query,
                    gl: 'id',
                    hl: 'id', // Bahasa hasil
                    num: 8 // Mengambil 8 hasil dari API
                })
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Update search count
            searchData.count++;
            localStorage.setItem('serperSearchData', JSON.stringify(searchData));
            
            // Format results
            let resultText = `**🔍 Hasil Pencarian untuk: "${query}"**\n\n`;
            
            if (data.answerBox) {
                resultText += `**🎯 Jawaban Langsung:**\n${data.answerBox.answer || data.answerBox.snippet}\n\n`;
            }
            
            if (data.organic && data.organic.length > 0) {
                // Menampilkan hingga 6 hasil organik secara individual dengan detail lebih banyak
                data.organic.slice(0, 6).forEach((result, index) => {
                    resultText += `\n---\n\n`; // Garis pemisah
                    resultText += `### ${index + 1}. ${result.title}\n\n`;
                    resultText += `> ${result.snippet}\n\n`; // Deskripsi utama (biasanya 2-3 baris)

                    // Tambahkan sitelinks jika ada untuk memperpanjang konten
                    if (result.sitelinks && result.sitelinks.length > 0) {
                        resultText += `**Tautan Terkait:**\n`;
                        result.sitelinks.slice(0, 3).forEach(sitelink => { // Tampilkan hingga 3 sitelinks
                            resultText += `*   ${sitelink.title}\n`;
                        });
                        resultText += `\n`;
                    }

                    resultText += `**Sumber:** ${result.link}\n`; // Tautan ke sumber
                });
            } else {
                resultText += "Tidak ada hasil organik yang ditemukan.";
            }
            
            if (data.relatedSearches && data.relatedSearches.length > 0) {
                resultText += `**🔍 Pencarian Terkait:**\n`;
                data.relatedSearches.slice(0, 3).forEach(search => {
                    resultText += `• ${search.query}\n`;
                });
            }
            
            resultText += `\n---\n*Pencarian tersisa hari ini: ${6 - searchData.count}/6*`;
            
            updateMessage(thinkingId, marked.parse(resultText));
            
        } catch (error) {
            console.error('Serper API Error:', error);
            if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                addMessageToUI('notification', marked.parse('Mohon coba lagi, jaringan Anda mungkin bermasalah.'));
            }
            updateMessage(thinkingId, marked.parse(`❌ **Error Pencarian:**\n\nTerjadi kesalahan saat melakukan pencarian: ${error.message}\n\nCoba lagi dalam beberapa saat.`));
        }
    }

    window.triggerCommand = (command, promptUser = false) => {
        if (promptUser) {
            const commandPrefix = command.includes(':') ? command.substring(0, command.indexOf(':') + 1) : command.split(' ')[0];
            const defaultValue = command.substring(commandPrefix.length).trim();
            const userInput = prompt(promptUser, defaultValue);
            if (userInput === null) return; // User cancelled prompt
            command = `${commandPrefix} ${userInput}`;
        }
        expressionEl.value = command;
        processUserInput(command.trim(), true); // true indicates a system trigger
    };
    window.loadFeature = (placeholderId, functionName, ...args) => {
        const placeholder = document.getElementById(placeholderId);
        if (!placeholder) return;
    
        // Panggil fungsi asli untuk membuat HTML fitur
        const featureHtml = window[functionName](...args);
    
        // Ganti placeholder dengan HTML fitur yang sebenarnya
        placeholder.outerHTML = featureHtml;
    };

    // --- FEATURE IMPLEMENTATIONS ---

    function getUniversalAIContext() {
        return `
        Anda adalah asisten AI serbaguna yang ahli dalam berbagai bidang, termasuk pemrograman dan pembuatan teks kreatif. Anda terintegrasi dalam sebuah aplikasi web dengan fitur-fitur berikut.

        **Memori Percakapan (Gunakan untuk konteks dan personalisasi):**
        Berikut adalah beberapa interaksi terakhir dengan pengguna. Gunakan ini untuk memahami alur percakapan dan memberikan jawaban yang lebih relevan.
        ---
        ${(JSON.parse(localStorage.getItem("ai_brain")) || []).map(mem => `Pengguna: "${mem.question}"\nAnda: "${mem.answer}"`).join('\n')}
        ---

        **Konteks Aplikasi (Gunakan untuk menjawab pertanyaan tentang kemampuan aplikasi):**
        - 'panduan': Menampilkan panduan lengkap.
        - 'peta: [lokasi]': Menampilkan peta.
        - 'buka file rahasia': Pengelola file pribadi. 
        - 'waktu: [kapan] | [pesan]': Mengatur pengingat.
        - 'jadwal solat': Fitur Islami.
        - 'cuaca', 'gempa', 'pokemon', 'negara': Informasi dari API.
        - 'search: [query]': Pencarian web dengan AI.
        - Berbagai game seperti 'tictactoe', 'main ludo', dll.
        - Berbagai utilitas seperti 'kalender', 'password manager', 'koding', 'notepad', 'todo list'.
 
        **Instruksi Peran:**
        1.  **Jika permintaan terkait KODING:** Bertindaklah sebagai programmer ahli. Berikan jawaban yang jelas, contoh kode dalam blok markdown, dan penjelasan yang mendalam.
        2.  **Jika permintaan terkait PEMBUATAN TEKS (puisi, cerita, lirik):** Bertindaklah sebagai penulis kreatif.
        3.  **Jika permintaan terkait FITUR APLIKASI:** Gunakan "Konteks Aplikasi" di atas untuk menjelaskan apa yang bisa Anda lakukan. Jangan berhalusinasi tentang fitur yang tidak ada.
        4.  **Untuk permintaan lainnya:** Jawablah sebagai asisten umum yang informatif dan membantu.
        `;
    }

    function getAppFeaturesContext() {
        // Fungsi ini membuat "contekan" tentang fitur aplikasi untuk diberikan ke AI.
        return `
        Anda adalah asisten AI yang terintegrasi dalam sebuah aplikasi web. Berikut adalah daftar fitur yang Anda miliki. Gunakan informasi ini untuk menjawab pertanyaan pengguna tentang kemampuan Anda.

        **Fitur Utama & Utilitas:**
        - 'panduan': Menampilkan panduan lengkap semua perintah.
        - 'peta: [lokasi]': Menampilkan peta interaktif dari lokasi yang diminta.
        - 'buka file rahasia': Membuka pengelola file pribadi yang aman di browser.
        - 'waktu: [kapan] | [pesan]': Mengatur pengingat atau pesan untuk masa depan (misal: 'waktu: 10 menit | minum kopi').
        - 'chat waktu dulu': Melihat semua pesan masa depan yang telah tiba.
        - 'jadwal solat': Menampilkan jadwal sholat otomatis berdasarkan lokasi atau kota.
        - 'peta global': Menampilkan peta dunia interaktif dengan pencarian lokasi.
        - 'buat kode qr': Membuat QR code dari teks atau URL.
        - 'analisis warna': Menganalisis kode warna (HEX/RGB).
        - 'cuaca [kota]': Menampilkan prakiraan cuaca dari Open-Meteo.
        - 'gempa': Menampilkan data gempa terbaru dari BMKG.
        - 'pokemon [nama]': Menampilkan data Pokémon dari PokéAPI.
        - 'negara [nama]': Menampilkan data negara dari REST Countries API.
        - 'wikipedia': Mencari artikel di Wikipedia.
        - 'falcon: [pertanyaan]': Bertanya langsung ke model Falcon AI (yaitu Anda sendiri).
        - 'kutipan motivasi': Menampilkan quote inspiratif acak dari ZenQuotes.

        **Kreativitas & Produktivitas:**
        - 'kutipan motivasi': Menampilkan quote inspiratif acak dari ZenQuotes dengan fitur simpan.
        - 'gambar': Membuka kanvas untuk menggambar.
        - 'password manager': Pengelola password aman dengan enkripsi.
        - 'buat kata sandi': Membuat password yang kuat dan acak.
        - 'kalender': Menampilkan kalender 35 hari.
        - 'koding': Menyediakan area untuk menulis dan menyalin kode.
        - 'notepad [1-4]': Menyimpan catatan di 4 slot berbeda.
        - 'todo list': Mengelola daftar tugas.

        **Game & Hiburan:**
        - 'tictactoe': Bermain game Tic-Tac-Toe melawan AI.
        - 'lempar dadu': Melempar dadu virtual.
        - 'main 2048': Bermain game puzzle 2048. 
        `;
    }
    async function queryFalconAI(prompt) {
        const thinkingId = addThinkingMessage(`Menghubungi Falcon AI untuk: "${escapeHtml(prompt)}"...`);
                const apiKey = localStorage.getItem('falcon_api_key');
        if (!apiKey) { 
                    updateMessage(thinkingId, marked.parse(`❌ **Error Falcon AI:** API Key tidak ditemukan. Anda bisa mengatur API Key dengan perintah \`apikey falcon\`.`));
                    return;
        }

        // Gabungkan konteks fitur dengan pertanyaan pengguna
        const fullPrompt = `${getUniversalAIContext()}\n\nPertanyaan Pengguna: "${prompt}"\n\nJawaban Anda:`;

                const makeRequest = async (retryCount = 0) => {
                    try { 
                        const response = await fetch(
                            "https://api-inference.huggingface.co/models/tiiuae/falcon-7b-instruct",
                            {
                                headers: {
                                    "Authorization": `Bearer ${apiKey}`,
                                    "Content-Type": "application/json"
                                },
                                method: "POST",
                                body: JSON.stringify({"inputs": fullPrompt, "parameters": {"max_new_tokens": 350, "return_full_text": false, "temperature": 0.7}}),
                            }
                        );

                        if (!response.ok) {
                            const errorBody = await response.text();
                            let errorData = {};
                            try {
                                errorData = JSON.parse(errorBody);
                            } catch (e) {
                                // Biarkan errorData kosong jika parsing gagal
                            }

                            // Jika model sedang loading, coba lagi setelah beberapa detik
                            if (errorData.error && errorData.error.includes("is currently loading") && retryCount < 1) {
                                updateMessage(thinkingId, marked.parse(`Model AI sedang disiapkan (ini bisa memakan waktu ~20 detik). Mencoba lagi secara otomatis...`));
                                await new Promise(resolve => setTimeout(resolve, 20000)); // Tunggu 20 detik
                                return makeRequest(retryCount + 1);
                            }

                            throw new Error(`Gagal menghubungi Falcon AI. Status: ${response.status}. Pesan: ${errorBody}`);
                        }

                        const result = await response.json();
                        const generatedText = result[0]?.generated_text || "Tidak ada respons teks yang valid dari Falcon AI.";
                        updateMessage(thinkingId, marked.parse(`**🪶 Hasil dari Falcon AI:**\n\n${generatedText}`));
                    } catch (error) {
                        if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                            addMessageToUI('notification', marked.parse('Mohon coba lagi, jaringan Anda mungkin bermasalah.'));
                        }
                        updateMessage(thinkingId, marked.parse(`❌ **Error Falcon AI:** ${error.message}.`));
                    }
                };

                await makeRequest();
    }
            
    // --- WebLLM (Local AI) - Unified Loader & Query Functions --- //
    window.localModels = {}; // Cache untuk menyimpan instance model yang sudah dimuat
    window.modelConfigs = {
        'webllm': { id: "gemma-2b-it-q4f16_1-MLC", name: "Gemma (Google)", emoji: "🧠", size: "1.4 GB" },
        'tinylama': { id: "TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC", name: "TinyLlama", emoji: "🦙", size: "0.6 GB" },
        'qwen': { id: "Qwen2-0.5B-Instruct-q4f16_1-MLC", name: "Qwen (Alibaba)", emoji: "🐉", size: "0.3 GB" }
    };

    function createLocalModelDownloaderUI(prompt, thinkingId) {
        const promptData = escapeHtml(JSON.stringify(prompt));
        let buttonsHtml = '';
        for (const key in window.modelConfigs) {
            const config = window.modelConfigs[key];
            const configData = escapeHtml(JSON.stringify(config));
            buttonsHtml += `<button onclick="window.startLocalModelDownload(${promptData}, '${key}', ${configData}, '${thinkingId}')" class="interactive-button">${config.emoji} Unduh ${config.name} (${config.size})</button>`;
        }

        const content = `
            <div class="prose dark:prose-invert">
                <h3 class="text-xl font-bold mb-2">Unduh Model AI Lokal</h3>
                <p class="text-sm text-gray-400 mb-4">Model AI akan berjalan sepenuhnya di browser Anda. Pilih model untuk diunduh. Proses ini hanya perlu dilakukan sekali.</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 justify-center mt-4">
                ${buttonsHtml}
            </div>
            <div id="progress-container-${thinkingId}" class="mt-4" style="display: none;">
                <div class="progress-bar-container" style="width: 100%;">
                    <div id="progress-bar-${thinkingId}" class="progress-bar" style="width: 0%;">0%</div>
                </div>
                <p id="progress-text-${thinkingId}" class="text-center text-sm mt-2 text-gray-400"></p>
            </div>
        `;
        updateMessage(thinkingId, content, false);
    }

    function handleLocalModelDownloadCommand(modelType) {
        const config = window.modelConfigs[modelType];
        const prompt = `Perintah unduh untuk model ${config.name}`;
        const thinkingId = addThinkingMessage(`Mempersiapkan unduhan untuk model ${config.name}...`);
        // Langsung panggil fungsi yang memulai unduhan
        window.startLocalModelDownload(prompt, modelType, config, thinkingId);
    }

    async function handleLocalModelQuery(prompt, modelType) {
        const config = window.modelConfigs[modelType];
        if (window.localModels[config.id]) {
            // Model sudah dimuat, langsung jalankan query
            queryLocalModel(prompt, modelType);
        } else {
            // Model belum dimuat, tampilkan UI unduhan
            const thinkingId = addThinkingMessage(`Memeriksa model AI lokal...`);
            createLocalModelDownloaderUI(prompt, thinkingId);
        }
    }

    window.startLocalModelDownload = async (prompt, modelType, modelConfig, thinkingId) => {
        // Sembunyikan tombol-tombol
        document.querySelectorAll(`#${thinkingId} .interactive-button`).forEach(btn => btn.style.display = 'none');
        // Tampilkan progress bar
        document.getElementById(`progress-container-${thinkingId}`).style.display = 'block';

        await queryLocalModel(prompt, modelType, thinkingId);
    }

    async function loadLocalModel(modelId, modelConfig, thinkingId) {
        // Wait for the WebLLM library to be fully ready. This is the robust fix.
        await webLLMReadyPromise;

        if (window.localModels[modelId]) {
            return window.localModels[modelId];
        }

        try {
            const chat = new webllm.ChatModule();
            
            let downloadedBytes = 0;
            let totalBytes = 0;

            const initProgressCallback = (report) => {
                const progressPercentage = (report.progress * 100).toFixed(0);
                const progressBar = document.getElementById(`progress-bar-${thinkingId}`);
                const progressText = document.getElementById(`progress-text-${thinkingId}`);
                if (progressBar && progressText) {
                    progressBar.style.width = `${report.progress * 100}%`;
                    progressBar.textContent = `${Math.floor(report.progress * 100)}%`;
                    progressText.innerHTML = `${report.text}<br><span class="text-gray-500">${(report.downloaded / 1024 / 1024).toFixed(2)} MB / ${(report.total / 1024 / 1024).toFixed(2)} MB</span>`;
                }
            };
            
            await chat.reload(modelId, undefined, { init: initProgressCallback });

            window.localModels[modelId] = chat;
            return chat;
        } catch (error) {
            const progressText = document.getElementById(`progress-text-${thinkingId}`);
            if(progressText) progressText.innerHTML = `<span class="text-red-400">❌ Error: ${error.message}. Pastikan browser Anda mendukung WebGPU.</span>`;
            throw error; // Lemparkan error agar pemanggilan selanjutnya berhenti
        }
    }

    async function queryLocalModel(prompt, modelType, thinkingId = null) {
        const modelConfig = window.modelConfigs[modelType];
        const modelId = modelConfig.id;
        
        if (!thinkingId) {
            thinkingId = addThinkingMessage(`Menyiapkan model AI lokal (${modelConfig.name})...`);
        }

        try {
            const chat = await loadLocalModel(modelId, modelConfig, thinkingId);

            const fullReply = await chat.generate(prompt, (step, message) => {
                updateMessage(thinkingId, marked.parse(`**${modelConfig.emoji} Hasil dari ${modelConfig.name}:**\n\n${message}`), false);
            });

            // Final update dengan konten penuh
            updateMessage(thinkingId, marked.parse(`**${modelConfig.emoji} Hasil dari ${modelConfig.name}:**\n\n${fullReply}`));
        } catch (error) {
            // Error sudah ditangani di loadLocalModel, jadi tidak perlu update message lagi di sini.
            console.error(`Gagal menjalankan query untuk ${modelConfig.name}:`, error);
        }
    }

            // --- ChatGPT (OpenAI) ---
            async function queryChatGPT(prompt) {
                const thinkingId = addThinkingMessage(`Menghubungi ChatGPT untuk: "${escapeHtml(prompt)}"...`);
                const apiKey = localStorage.getItem('chatgpt_api_key');
                if (!apiKey) {
                    updateMessage(thinkingId, marked.parse(`❌ **Error ChatGPT:** API Key tidak ditemukan. Atur dengan perintah \`apikey chatgpt\`.`));
                    return;
                }
                try {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: [{ role: "system", content: getUniversalAIContext() }, { role: "user", content: prompt }],
                            max_tokens: 350,
                        }),
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Gagal menghubungi ChatGPT. Status: ${response.status}. Pesan: ${errorBody}`);
                    }
                    const result = await response.json();
                    const generatedText = result.choices[0]?.message?.content || "Tidak ada respons teks yang valid dari ChatGPT.";
                    updateMessage(thinkingId, marked.parse(`**🤖 Hasil dari ChatGPT:**\n\n${generatedText}`));
                } catch (error) {
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        addMessageToUI('notification', marked.parse('Mohon coba lagi, jaringan Anda mungkin bermasalah.'));
                    }
                    updateMessage(thinkingId, marked.parse(`❌ **Error ChatGPT:** ${error.message}.`));
                }
            }

            // --- Gemini (Google) ---
            async function queryGemini(prompt) {
                const thinkingId = addThinkingMessage(`Menghubungi Gemini untuk: "${escapeHtml(prompt)}"...`);
                const apiKey = localStorage.getItem('gemini_api_key');
                if (!apiKey) {
                    updateMessage(thinkingId, marked.parse(`❌ **Error Gemini:** API Key tidak ditemukan. Atur dengan perintah \`apikey gemini\`.`));
                    return;
                }
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            contents: [{ role: "user", parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: getUniversalAIContext() }] }
                        }), 
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Gagal menghubungi Gemini. Status: ${response.status}. Pesan: ${errorBody}`);
                    }
                    const result = await response.json();
                    const generatedText = result.candidates[0]?.content?.parts[0]?.text || "Tidak ada respons teks yang valid dari Gemini.";
                    updateMessage(thinkingId, marked.parse(`**✨ Hasil dari Gemini:**\n\n${generatedText}`));
                } catch (error) {
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        addMessageToUI('notification', marked.parse('Mohon coba lagi, jaringan Anda mungkin bermasalah.'));
                    }
                    updateMessage(thinkingId, marked.parse(`❌ **Error Gemini:** ${error.message}.`));
                }
            }

            // --- Claude (Anthropic) ---
            async function queryClaude(prompt) {
                const thinkingId = addThinkingMessage(`Menghubungi Claude untuk: "${escapeHtml(prompt)}"...`);
                const apiKey = localStorage.getItem('claude_api_key');
                if (!apiKey) {
                    updateMessage(thinkingId, marked.parse(`❌ **Error Claude:** API Key tidak ditemukan. Atur dengan perintah \`apikey claude\`.`));
                    return;
                }
                try {
                    // Note: Anthropic API requires a proxy to be called from the browser due to CORS.
                    // Menggunakan proxy sederhana untuk mengatasi masalah CORS.
                    const response = await fetch("https://corsproxy.io/?https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "x-api-key": apiKey,
                            "anthropic-version": "2023-06-01",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ 
                            model: "claude-3-5-sonnet-20240620",
                            system: getUniversalAIContext(),
                            max_tokens: 350,
                            messages: [{ role: "user", content: fullPrompt }]
                        }),
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Gagal menghubungi Claude. Status: ${response.status}. Pesan: ${errorBody}`);
                    }
                    const result = await response.json();
                    const generatedText = result.content[0]?.text || "Tidak ada respons teks yang valid dari Claude.";
                    updateMessage(thinkingId, marked.parse(`**✍️ Hasil dari Claude:**\n\n${generatedText}`));
                } catch (error) {
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        addMessageToUI('notification', marked.parse('Mohon coba lagi, jaringan Anda mungkin bermasalah.'));
                    }
                    updateMessage(thinkingId, marked.parse(`❌ **Error Claude:** ${error.message}. Mungkin memerlukan proxy CORS.`));
                }
            }

            // --- DeepSeek (Hugging Face) ---
            async function queryDeepSeek(prompt) {
                const thinkingId = addThinkingMessage(`Menghubungi DeepSeek Coder untuk: "${escapeHtml(prompt)}"...`);
                const apiKey = localStorage.getItem('deepseek_api_key');
                if (!apiKey) {
                    updateMessage(thinkingId, marked.parse(`❌ **Error DeepSeek:** API Key tidak ditemukan. Atur dengan perintah \`apikey deepseek\`.`));
                    return;
                }
                
                const makeRequest = async (retryCount = 0) => {
                    try {
                        const response = await fetch("https://api-inference.huggingface.co/models/deepseek-ai/DeepSeek-V2-Chat", {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                            body: JSON.stringify({ 
                                inputs: {
                                    messages: [{ role: "system", content: getUniversalAIContext() }, { role: "user", content: prompt }]
                                },
                                parameters: { max_new_tokens: 350, return_full_text: false, temperature: 0.7 } 
                            }),
                        });
                        if (!response.ok) {
                            const errorBody = await response.text();
                            const errorData = JSON.parse(errorBody);
                            if (errorData.error && errorData.error.includes("is currently loading") && retryCount < 1) {
                                updateMessage(thinkingId, marked.parse(`Model DeepSeek sedang disiapkan (ini bisa memakan waktu ~20 detik). Mencoba lagi secara otomatis...`));
                                await new Promise(resolve => setTimeout(resolve, 20000));
                                return makeRequest(retryCount + 1);
                            }
                            throw new Error(`Gagal menghubungi DeepSeek. Status: ${response.status}. Pesan: ${errorBody}`);
                        }
                        const result = await response.json();
                        const generatedText = result[0]?.generated_text || "Tidak ada respons teks yang valid dari DeepSeek.";
                        updateMessage(thinkingId, marked.parse(`**💻 Hasil dari DeepSeek Coder:**\n\n${generatedText}`));
                    } catch (error) {
                        if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                            addMessageToUI('notification', marked.parse('Mohon coba lagi, jaringan Anda mungkin bermasalah.'));
                        }
                        updateMessage(thinkingId, marked.parse(`❌ **Error DeepSeek:** ${error.message}.`));
                    }
                };

                await makeRequest();
            }

    function createHelpGuide() {
        return `<div class="feature-container">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">📚 Panduan & Navigasi Cepat</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Ini adalah daftar lengkap kemampuan saya. Klik tombol untuk langsung menggunakan fitur.</p>

            <div class="mb-6">
                <h4 class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 mb-3">🎮 Game & Hiburan</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <button onclick="triggerCommand('lempar dadu')" class="example-prompt-button"><div class="font-semibold">Lempar Dadu</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Lempar dadu virtual.</div></button>
                    <button onclick="triggerCommand('bermain piano')" class="example-prompt-button"><div class="font-semibold">Bermain Piano</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Mainkan piano interaktif.</div></button>
                    <button onclick="triggerCommand('bermain 2048')" class="example-prompt-button"><div class="font-semibold">Game 2048</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Mainkan game puzzle 2048.</div></button>
                    <button onclick="triggerCommand('tictactoe')" class="example-prompt-button"><div class="font-semibold">Tic Tac Toe</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Bermain Tic Tac Toe melawan AI.</div></button>
                    <button onclick="triggerCommand('main ludo')" class="example-prompt-button"><div class="font-semibold">Game Ludo</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Mainkan Ludo (versi demo).</div></button>
                    <button onclick="triggerCommand('kepribadian acak')" class="example-prompt-button"><div class="font-semibold">Kepribadian Acak</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Buat profil orang acak.</div></button>
                    <button onclick="triggerCommand('olahraga')" class="example-prompt-button"><div class="font-semibold">Pelacak Olahraga</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Lacak langkah, jarak, dan kecepatan.</div></button>
                    <button onclick="triggerCommand('scan file')" class="example-prompt-button"><div class="font-semibold">Pindai File</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Cek keamanan file dengan VirusTotal.</div></button>
                    <button onclick="triggerCommand('kutipan motivasi')" class="example-prompt-button"><div class="font-semibold">Kutipan Motivasi</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Dapatkan kutipan inspiratif.</div></button>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 mb-3">🚀 Produktivitas & Kreativitas</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <button onclick="triggerCommand('buka file rahasia')" class="example-prompt-button"><div class="font-semibold">File Rahasia</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Pengelola file pribadi & aman.</div></button>
                    <button onclick="triggerCommand('waktu: 10 menit | Ingatkan saya', 'Masukkan Durasi | Pesan')" class="example-prompt-button"><div class="font-semibold">Kapsul Waktu</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Setel pengingat untuk masa depan.</div></button>
                    <button onclick="triggerCommand('kalender')" class="example-prompt-button"><div class="font-semibold">Kalender</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Tampilkan kalender 35 hari.</div></button>
                    <button onclick="triggerCommand('password manager')" class="example-prompt-button"><div class="font-semibold">Password Manager</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Kelola password dengan aman.</div></button>
                    <button onclick="triggerCommand('koding')" class="example-prompt-button"><div class="font-semibold">Area Koding</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Editor kode dengan pratinjau.</div></button>
                    <button onclick="triggerCommand('notepad 1', 'Pilih slot Notepad (1-4)')" class="example-prompt-button"><div class="font-semibold">Notepad</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Simpan catatan cepat.</div></button>
                    <button onclick="triggerCommand('todo list')" class="example-prompt-button"><div class="font-semibold">Papan Tugas</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Atur tugas dengan papan Trello.</div></button>
                    <button onclick="triggerCommand('grafik')" class="example-prompt-button"><div class="font-semibold">Buat Grafik</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Visualisasikan data Anda.</div></button>
                    <button onclick="triggerCommand('gambar')" class="example-prompt-button"><div class="font-semibold">Kanvas Gambar</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Area untuk menggambar bebas.</div></button>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 mb-3">🛠️ Utilitas & Informasi</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <button onclick="triggerCommand('jadwal solat')" class="example-prompt-button"><div class="font-semibold">Jadwal Sholat</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Jadwal sholat berdasarkan lokasi.</div></button>
                    <button onclick="triggerCommand('peta: jakarta', 'Masukkan nama lokasi (contoh: jakarta)')" class="example-prompt-button"><div class="font-semibold">Peta Lokasi</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Cari lokasi di peta.</div></button>
                    <button onclick="triggerCommand('perjalanan ke: bandung', 'Masukkan tujuan perjalanan (contoh: bandung)')" class="example-prompt-button"><div class="font-semibold">Mulai Perjalanan</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Lacak perjalanan real-time.</div></button>
                    <button onclick="triggerCommand('buat kode qr')" class="example-prompt-button"><div class="font-semibold">Kode QR</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Buat QR code dari teks.</div></button>
                    <button onclick="triggerCommand('analisis warna')" class="example-prompt-button"><div class="font-semibold">Analisis Warna</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Analisis kode warna HEX/RGB.</div></button>
                    <button onclick="triggerCommand('cuaca jakarta', 'Masukkan nama kota (contoh: jakarta)')" class="example-prompt-button"><div class="font-semibold">Prakiraan Cuaca</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Lihat cuaca saat ini.</div></button>
                    <button onclick="triggerCommand('gempa')" class="example-prompt-button"><div class="font-semibold">Info Gempa</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Data gempa terbaru dari BMKG.</div></button>
                    <button onclick="triggerCommand('search: apa itu AI', 'Masukkan topik pencarian (contoh: apa itu AI)')" class="example-prompt-button"><div class="font-semibold">Pencarian AI</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Cari di web dengan AI (6x/hari).</div></button>
                    <button onclick="triggerCommand('wikipedia: Indonesia', 'Masukkan topik Wikipedia (contoh: Indonesia)')" class="example-prompt-button"><div class="font-semibold">Cari Wikipedia</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Cari artikel di Wikipedia.</div></button>
                    <button onclick="triggerCommand('pokemon pikachu', 'Masukkan nama Pokémon (contoh: pikachu)')" class="example-prompt-button"><div class="font-semibold">Info Pokémon</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Cari data Pokémon.</div></button>
                    <button onclick="triggerCommand('negara indonesia', 'Masukkan nama negara (contoh: indonesia)')" class="example-prompt-button"><div class="font-semibold">Info Negara</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Cari data tentang negara.</div></button>
                    <button onclick="triggerCommand('waktu sekarang')" class="example-prompt-button"><div class="font-semibold">Waktu Sekarang</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Lihat jam, tanggal, dan bulan.</div></button>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 mb-3">🧠 Model AI & Setup</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <button onclick="triggerCommand('falcon: jelaskan tentang fotosintesis', 'Tanyakan sesuatu pada Falcon AI')" class="example-prompt-button"><div class="font-semibold">Tanya Falcon AI</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Model AI general-purpose.</div></button>
                    <button onclick="triggerCommand('gemini: apa itu black hole', 'Tanyakan sesuatu pada Gemini')" class="example-prompt-button"><div class="font-semibold">Tanya Gemini</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Model AI dari Google.</div></button>
                    <button onclick="triggerCommand('deepseek: buat fungsi python untuk fibonacci', 'Minta kode pada DeepSeek')" class="example-prompt-button"><div class="font-semibold">Tanya DeepSeek</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Model AI khusus koding.</div></button>
                    <button onclick="triggerCommand('apikey gemini', 'Pilih model: gemini, falcon, dll.')" class="example-prompt-button"><div class="font-semibold">Set API Key</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Atur kunci API untuk model AI.</div></button>
                    <button onclick="triggerCommand('webllm: jelaskan apa itu webllm')" class="example-prompt-button"><div class="font-semibold">Tanya WebLLM</div><div class="text-sm text-indigo-500 dark:text-indigo-400">Model AI lokal di browser.</div></button>
                </div>
            </div>
        </div>`;
    }

    window.createInteractiveMap = (locationQuery = "Indonesia") => {
        const id = `map-${Date.now()}`;
        setTimeout(() => window.searchMapLocation(id, locationQuery), 100);
        return `
        <div class="feature-container">
             <h3 class="text-lg font-bold text-gray-900 dark:text-white">🗺️ Peta Interaktif Global (Multi-Lokasi)</h3>
             <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Cari beberapa lokasi dan lihat semuanya di satu peta. Peta akan menyesuaikan tampilan secara otomatis.</p>
             <div class="flex gap-2 mb-3">
                <input type="text" id="location-input-${id}" class="interactive-input flex-grow" placeholder="Contoh: Paris, Prancis">
                <button onclick="window.searchMapLocation('${id}', document.getElementById('location-input-${id}').value)" class="interactive-button">Tambah Lokasi</button>
                <button onclick="window.clearMapMarkers('${id}')" class="interactive-button bg-red-600 hover:bg-red-700">Bersihkan Peta</button>
            </div>
            <div id="map-container-${id}" class="map-container mt-4">Memuat peta...</div>
        </div>`;
    }
    window.searchMapLocation = async (id, query) => {
        const container = document.getElementById(`map-container-${id}`);
        if (!query) { container.innerHTML = "Lokasi tidak boleh kosong."; return; }
        container.innerHTML = `<div class="flex items-center justify-center h-full text-slate-400">Mencari "${escapeHtml(query)}"...</div>`;

                // Inisialisasi peta jika belum ada
                if (!window.activeMaps[id]) {
                    container.innerHTML = ''; // Kosongkan pesan "Memuat..."
                    const map = L.map(container).setView([0, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    window.activeMaps[id] = { map: map, markers: [] };
                }

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const data = await response.json();
            if (data.length === 0) throw new Error("Lokasi tidak ditemukan.");

            const { lat, lon, display_name } = data[0];
                    const mapData = window.activeMaps[id];

                    const marker = L.marker([lat, lon]).addTo(mapData.map).bindPopup(display_name).openPopup();
                    mapData.markers.push(marker);

                    if (mapData.markers.length > 1) {
                        const group = new L.featureGroup(mapData.markers);
                        mapData.map.fitBounds(group.getBounds().pad(0.2)); // pad(0.2) untuk memberi sedikit ruang
            } else {
                        mapData.map.setView([lat, lon], 13);
            }
                    container.innerHTML = ''; // Hapus pesan "Mencari..." setelah berhasil
        } catch (error) {
            container.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
        }
    }
            window.clearMapMarkers = (id) => {
                const mapData = window.activeMaps[id];
                if (mapData) {
                    mapData.markers.forEach(marker => mapData.map.removeLayer(marker));
                    mapData.markers = [];
                    mapData.map.setView([0, 0], 2); // Reset view ke tampilan global
                }
            }

            // --- Real-time Trip Functions ---
            function createTripInterface(destinationQuery) {
                const id = `trip-${Date.now()}`;
                setTimeout(() => window.startTrip(id, destinationQuery), 100);
                return `
                    <div class="feature-container text-white">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">🚀 Perjalanan Real-Time</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Melacak lokasi Anda menuju: <strong>${escapeHtml(destinationQuery)}</strong></p>
                        <div id="trip-status-${id}" class="mb-4 p-3 bg-gray-100 dark:bg-gray-900 rounded-lg text-center text-indigo-500 dark:text-indigo-300">
                            Mempersiapkan perjalanan...
                        </div>
                        <div id="map-container-${id}" class="map-container">Memuat peta perjalanan...</div>
                        <button onclick="window.stopTrip('${id}')" class="interactive-button bg-red-600 hover:bg-red-700 w-full mt-4">Hentikan Perjalanan</button>
                    </div>
                `;
            }

            window.startTrip = async (id, destinationQuery) => {
                const statusDiv = document.getElementById(`trip-status-${id}`);
                const mapContainer = document.getElementById(`map-container-${id}`);
                
                try {
                    // 1. Geocode destination
                    statusDiv.textContent = `Mencari lokasi tujuan: ${destinationQuery}...`;
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destinationQuery)}&limit=1`);
                    const data = await response.json();
                    if (data.length === 0) throw new Error("Tujuan tidak ditemukan.");
                    const destination = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), name: data[0].display_name };

                    // 2. Initialize map
                    const map = L.map(mapContainer).setView([0, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    
                    // Add destination marker
                    const destMarker = L.marker([destination.lat, destination.lng]).addTo(map).bindPopup(`<b>Tujuan:</b><br>${destination.name}`).openPopup();

                    // 3. Start watching user's position
                    statusDiv.textContent = "Mengaktifkan GPS untuk melacak lokasi Anda...";
                    if (!('geolocation' in navigator)) throw new Error("Geolocation tidak didukung oleh browser Anda.");

                    const watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const userCoords = { lat: position.coords.latitude, lng: position.coords.longitude };
                            const trip = window.tripState[id];
                            if (!trip) return; // Stop if trip was cancelled
                            const map = trip.map;
                            const destination = trip.destination;

                            // Update user marker
                            if (!trip.userMarker) {
                                trip.userMarker = L.circleMarker([userCoords.lat, userCoords.lng], { radius: 8, color: '#3b82f6', fillColor: '#60a5fa', fillOpacity: 1 }).addTo(map).bindPopup("Posisi Anda saat ini");
                            } else {
                                trip.userMarker.setLatLng([userCoords.lat, userCoords.lng]);
                            }

                            // Calculate and draw the real route only once on the first location update
                            if (!trip.routeLayer) {
                                statusDiv.innerHTML = `Menghitung rute jalan raya...`;
                                fetch(`https://router.project-osrm.org/route/v1/driving/${userCoords.lng},${userCoords.lat};${destination.lng},${destination.lat}?overview=full&geometries=geojson`)
                                    .then(res => res.json())
                                    .then(routeData => {
                                        if (routeData.routes && routeData.routes.length > 0) {
                                            const route = routeData.routes[0];
                                            const routeCoords = route.geometry.coordinates.map(c => [c[1], c[0]]); // Flip lng/lat to lat/lng for Leaflet

                                            // --- Simulasi Kemacetan ---
                                            const trafficColors = ['#16a34a', '#16a34a', '#facc15', '#ef4444']; // Green, Green, Yellow, Red
                                            const segmentLength = Math.floor(routeCoords.length / 15) || 1; // Bagi rute menjadi ~15 segmen
                                            const routeLayers = [];

                                            for (let i = 0; i < routeCoords.length - 1; i += segmentLength) {
                                                const segment = routeCoords.slice(i, i + segmentLength + 1);
                                                const randomColor = trafficColors[Math.floor(Math.random() * trafficColors.length)];
                                                const polyline = L.polyline(segment, { color: randomColor, weight: 6, opacity: 0.8 });
                                                routeLayers.push(polyline);
                                            }
                                            
                                            const routeLine = L.layerGroup(routeLayers).addTo(map);
                                            trip.routeLayer = routeLine; // Save the layer group
                                            // --- Akhir Simulasi ---

                                            // Fit map to the entire route
                                            map.fitBounds(routeLine.getBounds().pad(0.1));

                                            // Update status with real distance and duration
                                            const distanceKm = (route.distance / 1000).toFixed(2);
                                            const durationMinutes = Math.round(route.duration / 60);
                                            trip.totalDistance = distanceKm; // Simpan total jarak
                                            trip.totalDuration = durationMinutes; // Simpan total durasi
                                        } else {
                                            // Fallback to straight line if routing fails
                                            trip.routeLayer = L.polyline([[userCoords.lat, userCoords.lng], [destination.lat, destination.lng]], { color: 'red' }).addTo(map);
                                            map.fitBounds(L.latLngBounds([userCoords, destination]).pad(0.2));
                                        }
                                    });
                            }

                            // Real-time tracking and info update
                            if (trip.routeLayer) { // Hanya update jika rute sudah ada
                                map.panTo([userCoords.lat, userCoords.lng]); // Pusatkan peta pada pengguna
                                const remainingDistance = L.latLng(userCoords).distanceTo(L.latLng(destination));
                                statusDiv.innerHTML = `Jarak Tersisa: <strong>${(remainingDistance / 1000).toFixed(2)} km</strong> | Total: ${trip.totalDistance || '-'} km`;
                            }
                        },
                        (error) => {
                            statusDiv.textContent = `❌ Error GPS: ${error.message}`;
                            window.stopTrip(id); // Stop if there's an error
                        },
                        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
                    );

                    // Store trip state
                    window.tripState[id] = { watchId, map, destination, userMarker: null, routeLayer: null };

                } catch (error) {
                    statusDiv.textContent = `❌ Error: ${error.message}`;
                }
            };

            window.stopTrip = (id) => {
                const trip = window.tripState[id];
                if (trip && trip.watchId) {
                    navigator.geolocation.clearWatch(trip.watchId);
                    const statusDiv = document.getElementById(`trip-status-${id}`);
                    if (statusDiv) statusDiv.innerHTML = '<span class="text-red-400">Perjalanan dihentikan.</span>';
                    delete window.tripState[id];
                    console.log(`Trip ${id} stopped.`);
                }
            };


    function createFileManagerInterface() {
        const managerId = `secret-files-${Date.now()}`;
        return `
            <div class="feature-container p-6 rounded-lg text-white">
                <h3 class="text-xl font-bold mb-4">🗂️ Pengelola File Rahasia</h3>
                
                <!-- Password Prompt -->
                <div id="secret-files-password-${managerId}" class="mb-6">
                    <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded mb-3">
                        <p class="text-yellow-800 dark:text-yellow-200 text-sm">⚠️ Fitur ini dilindungi kata sandi. Masukkan kata sandi untuk mengakses.</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" id="secret-files-pwd-input-${managerId}" placeholder="Kata Sandi File Rahasia" class="interactive-input flex-1">
                        <button onclick="unlockSecretFiles('${managerId}')" class="interactive-button">🔓 Buka</button>
                        <button onclick="setSecretFilePassword('${managerId}')" class="interactive-button">🔑 Atur Kata Sandi</button>
                    </div>
                     <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Kata sandi minimal 11 karakter.</p>
                </div>
                
                <!-- File Manager UI (Hidden) -->
                <div id="secret-files-ui-${managerId}" style="display: none;">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">File Anda disimpan aman di IndexedDB browser.</p>
                    <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded-lg">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <label class="interactive-button bg-green-600 hover:bg-green-700 cursor-pointer flex-1 text-center">
                                <span>➕ Unggah File</span>
                                <input type="file" class="hidden" onchange="window.handleFileUpload(event, '${managerId}')">
                            </label>
                            <button onclick="exportSecretFiles()" class="interactive-button bg-blue-600 hover:bg-blue-700 flex-1">📥 Ekspor</button>
                            <label class="interactive-button bg-blue-600 hover:bg-blue-700 cursor-pointer flex-1 text-center">
                                <span>📤 Impor</span>
                                <input type="file" class="hidden" accept=".json" onchange="importSecretFiles(event, '${managerId}')">
                            </label>
                        </div>
                        <div id="secret-file-list-${managerId}" class="mt-4 space-y-2">Memuat file...</div>
                    </div>
                </div>
            </div>
        `;
    }
    window.handleFileUpload = (event, managerId) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const fileData = { name: file.name, type: file.type, size: file.size, content: e.target.result, timestamp: Date.now() };
            const tx = db.transaction('files', 'readwrite');
            tx.objectStore('files').add(fileData);
            tx.oncomplete = () => window.displaySecretFiles(managerId);
        };
        reader.readAsDataURL(file);
    }
    window.displaySecretFiles = (managerId) => {
        const fileListDiv = document.getElementById(`secret-file-list-${managerId}`);
        if (!fileListDiv) return;
        const request = db.transaction('files', 'readonly').objectStore('files').getAll();
        request.onsuccess = () => {
            const files = request.result;
            if (files.length === 0) {
                fileListDiv.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Tidak ada file yang disimpan.</p>'; return;
            }
            fileListDiv.innerHTML = files.map(file => `
                <div class="flex items-center justify-between bg-gray-200 dark:bg-gray-800 p-2 rounded">
                    <div>
                        <a href="${file.content}" download="${file.name}" class="text-indigo-400 hover:underline">${escapeHtml(file.name)}</a>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${(file.size / 1024).toFixed(2)} KB - Disimpan ${moment(file.timestamp).fromNow()}</p>
                    </div>
                    <button onclick="window.deleteSecretFile(${file.id}, '${managerId}')" class="text-red-500 hover:text-red-400 p-1">🗑️</button>
                </div>
            `).join('');
            fileListDiv.innerHTML += `<button onclick="clearAllSecretFiles('${managerId}')" class="w-full mt-4 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 p-2 rounded-md hover:bg-red-200 dark:hover:bg-red-800 text-sm">Hapus Semua File</button>`;
        };
    }
    window.deleteSecretFile = (id, managerId) => {
        const tx = db.transaction('files', 'readwrite');
        tx.objectStore('files').delete(id);
        tx.oncomplete = () => window.displaySecretFiles(managerId);
    }
    window.clearAllSecretFiles = async (managerId) => {
        if (!db || !confirm("ANDA YAKIN? Semua file rahasia akan dihapus permanen.")) return;
        try {
            await db.transaction('files', 'readwrite').objectStore('files').clear();
            alert("Semua file telah dihapus.");
            window.displaySecretFiles(managerId);
        } catch (error) {
            alert(`Gagal menghapus file: ${error.message}`);
        }
    };

    window.exportSecretFiles = async () => {
        if (!db) return alert("Database tidak siap.");
        try {
            const files = await new Promise((resolve, reject) => {
                const req = db.transaction('files', 'readonly').objectStore('files').getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
            const blob = new Blob([JSON.stringify({ type: 'ai-ultimate-files', files }, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_secret_files_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert("File rahasia berhasil diekspor!");
        } catch (error) {
            alert(`Gagal mengekspor file: ${error.message}`);
        }
    };

    window.importSecretFiles = (event, managerId) => {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm("Ini akan menambahkan file dari backup. File dengan nama yang sama mungkin akan terduplikasi. Lanjutkan?")) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data.type !== 'ai-ultimate-files' || !data.files) throw new Error("Format file backup tidak valid.");
                const tx = db.transaction('files', 'readwrite');
                for (const file of data.files) { tx.objectStore('files').put(file); }
                tx.oncomplete = () => {
                    alert(`${data.files.length} file berhasil diimpor!`);
                    window.displaySecretFiles(managerId);
                };
            } catch (error) { alert(`Gagal mengimpor: ${error.message}`); }
        };
        reader.readAsText(file);
    };

    window.setSecretFilePassword = (managerId) => {
        const pwdInput = document.getElementById(`secret-files-pwd-input-${managerId}`);
        const password = pwdInput.value;
        if (password.length < 11) {
            alert('Kata sandi harus terdiri dari minimal 11 karakter!');
            return;
        }
        localStorage.setItem('secretFilePasswordHash', btoa(password)); // Simple hashing for demo
        alert('Kata sandi untuk File Rahasia berhasil diatur!');
        pwdInput.value = '';
    };

    window.unlockSecretFiles = (managerId) => {
        const pwdInput = document.getElementById(`secret-files-pwd-input-${managerId}`);
        const storedHash = localStorage.getItem('secretFilePasswordHash');
        if (!storedHash) return alert('Anda belum mengatur kata sandi. Klik "Atur Kata Sandi" terlebih dahulu.');
        if (btoa(pwdInput.value) === storedHash) {
            document.getElementById(`secret-files-password-${managerId}`).style.display = 'none';
            document.getElementById(`secret-files-ui-${managerId}`).style.display = 'block';
            window.displaySecretFiles(managerId);
        } else {
            alert('Kata sandi salah!');
        }
    };

            function viewHistory() {
                if (!db) return marked.parse("❌ Database tidak tersedia.");
                const tx = db.transaction('history', 'readonly');
                const store = tx.objectStore('history');
                const request = store.getAll();

                request.onsuccess = () => {
                    const history = request.result.reverse(); // Tampilkan yang terbaru di atas
                    if (history.length === 0) {
                        updateMessage(addThinkingMessage("Membaca riwayat..."), marked.parse("### 📜 Riwayat Perintah\n\nTidak ada riwayat yang tersimpan."));
                    } else {
                        const content = history.slice(0, 20).map(item => `* **${moment(item.timestamp).fromNow()}:** \`${escapeHtml(item.query)}\``).join('\n');
                        updateMessage(addThinkingMessage("Membaca riwayat..."), marked.parse(`### 📜 Riwayat Perintah (20 terakhir)\n\n${content}`));
                    }
                };
                request.onerror = () => updateMessage(addThinkingMessage("Membaca riwayat..."), marked.parse("❌ Gagal membaca riwayat dari database."));
                return "Membaca riwayat..."; // Pesan sementara
            }

    function createCurrentTimeDisplay() {
        const id = `time-${Date.now()}`;
        setTimeout(() => window.updateCurrentTime(id), 100); // Panggil update setelah elemen dirender
        return `<div class="feature-container text-black" id="${id}"><h3 class="text-lg font-bold">⏱️ Waktu Sekarang</h3><div class="text-center py-6"><div class="text-4xl font-bold text-indigo-500 dark:text-indigo-300" id="current-time-${id}"></div><div class="text-lg" id="current-date-${id}"></div></div></div>`;
    }
    window.createTicTacToeGame = () => {
        const id = `tictactoe-${Date.now()}`;
        if (!window.ticTacToeStates) window.ticTacToeStates = {};
        // Inisialisasi state game dengan riwayat langkah
        window.ticTacToeStates[id] = { 
            board: Array(9).fill(null), 
            isGameOver: false,
            history: [] // Untuk menyimpan { board, move, player }
        }; 
        setTimeout(() => {
            const statusDiv = document.getElementById(`status-${id}`);
            if (statusDiv) statusDiv.textContent = 'Giliran Anda untuk memulai.';
        }, 100);

        let cells = Array.from({length: 9}, (_, i) => `<div class="tictactoe-cell flex justify-center items-center text-4xl" onclick="window.playerMove(${i}, '${id}')"></div>`).join('');
        return `
        <div class="feature-container text-center text-black" id="${id}"> 
            <h3 class="text-lg font-bold">⚔️ Tic Tac Toe vs AI (Pembelajar)</h3>
            <div id="status-${id}" class="my-2 h-6 font-semibold"></div>
            <div class="tictactoe-board">${cells}</div>
            <button onclick="window.resetTicTacToe('${id}')" class="interactive-button mt-2">Mulai Ulang</button>
        </div>`;
    }
    window.playerMove = (index, id) => {
        const state = window.ticTacToeStates[id];
        if (!state || state.isGameOver || state.board[index]) return;

        // Simpan langkah pemain
        state.history.push({ board: [...state.board], move: index, player: '❌' });
        state.board[index] = '❌';
        updateTicTacToeBoard(id);

        if (checkWinner(id)) return;

        document.getElementById(`status-${id}`).textContent = 'AI sedang berpikir...';
        setTimeout(() => { 
            const aiMoveIndex = getAIMove(id);
            if (aiMoveIndex !== -1) {
                // Simpan langkah AI
                state.history.push({ board: [...state.board], move: aiMoveIndex, player: '⭕' });
                state.board[aiMoveIndex] = '⭕';
            }
            updateTicTacToeBoard(id); 
            checkWinner(id); 
        }, 700); // Beri jeda agar terasa seperti berpikir
    }

    function getAIMove(id) {
        const state = window.ticTacToeStates[id];
        const board = state.board;
        const boardKey = board.join(',');

        const winningMoves = JSON.parse(localStorage.getItem('tictactoe_winning_moves') || '{}');
        const losingBlocks = JSON.parse(localStorage.getItem('tictactoe_losing_blocks') || '{}');

        // 1. Cek jika AI bisa menang sekarang
        for (let i = 0; i < 9; i++) {
            if (!board[i]) {
                board[i] = '⭕';
                if (isWinner(board, '⭕')) { board[i] = null; return i; }
                board[i] = null;
            }
        }

        // 2. Cek jika pemain bisa menang, lalu blok
        for (let i = 0; i < 9; i++) {
            if (!board[i]) {
                board[i] = '❌';
                if (isWinner(board, '❌')) { board[i] = null; return i; }
                board[i] = null;
            }
        }

        // 3. Gunakan strategi kemenangan yang dipelajari
        if (winningMoves[boardKey] !== undefined && !board[winningMoves[boardKey]]) {
            return winningMoves[boardKey];
        }

        // 4. Gunakan strategi blokir yang dipelajari
        if (losingBlocks[boardKey] !== undefined && !board[losingBlocks[boardKey]]) {
            return losingBlocks[boardKey];
        }

        // 5. Ambil posisi tengah jika kosong
        if (!board[4]) return 4;

        // 6. Ambil sudut jika kosong
        const corners = [0, 2, 6, 8].filter(i => !board[i]);
        if (corners.length > 0) return corners[Math.floor(Math.random() * corners.length)];

        // 7. Ambil sisi jika kosong
        const sides = [1, 3, 5, 7].filter(i => !board[i]);
        if (sides.length > 0) return sides[Math.floor(Math.random() * sides.length)];

        return -1; // Tidak ada langkah tersedia
    }

    function isWinner(board, player) {
        const winningCombos = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        return winningCombos.some(combo => combo.every(index => board[index] === player));
    }

    function checkWinner(id) {
        const state = window.ticTacToeStates[id];
        if (!state) return false;
        const statusDiv = document.getElementById(`status-${id}`);
        
        if (isWinner(state.board, '❌')) {
            state.isGameOver = true; statusDiv.textContent = `Anda Menang! AI belajar dari kekalahan ini.`; learnFromLoss(state.history); return true;
        } else if (isWinner(state.board, '⭕')) {
            state.isGameOver = true; statusDiv.textContent = `AI Menang! Strategi disimpan.`; learnFromWin(state.history); return true;
        }
        if (!state.board.includes(null)) {
            state.isGameOver = true; statusDiv.textContent = "Permainan Seri!"; return true;
        }
        statusDiv.textContent = `Giliran ${state.board.filter(Boolean).length % 2 === 0 ? 'Anda' : 'AI'}`;
        return false;
    }

    function learnFromWin(history) {
        const winningMoves = JSON.parse(localStorage.getItem('tictactoe_winning_moves') || '{}');
        history.forEach(step => {
            if (step.player === '⭕') {
                const boardKey = step.board.join(',');
                // Simpan langkah ini sebagai langkah yang baik untuk kondisi papan ini
                if (!winningMoves[boardKey]) {
                    winningMoves[boardKey] = step.move;
                }
            }
        });
        localStorage.setItem('tictactoe_winning_moves', JSON.stringify(winningMoves));
    }

    function learnFromLoss(history) {
        const losingBlocks = JSON.parse(localStorage.getItem('tictactoe_losing_blocks') || '{}');
        // Langkah terakhir adalah kemenangan pemain. Kita perlu melihat langkah AI sebelumnya.
        if (history.length < 2) return;

        const playerWinningMove = history[history.length - 1];
        const boardBeforePlayerWins = playerWinningMove.board;
        const movePlayerMadeToWin = playerWinningMove.move;

        // Kunci adalah kondisi papan SEBELUM pemain menang.
        // Nilai adalah langkah yang SEHARUSNYA diambil AI untuk memblokir.
        const boardKey = boardBeforePlayerWins.join(',');
        if (!losingBlocks[boardKey]) {
            losingBlocks[boardKey] = movePlayerMadeToWin;
        }
        
        localStorage.setItem('tictactoe_losing_blocks', JSON.stringify(losingBlocks));
    }

    function updateTicTacToeBoard(id) {
        const state = window.ticTacToeStates[id];
        if (!state) return;
        const boardEl = document.getElementById(id).querySelector('.tictactoe-board');
        Array.from(boardEl.children).forEach((cell, index) => {
            cell.textContent = state.board[index];
            if(state.board[index]) cell.classList.add('occupied', state.board[index]);
        });
    }
    window.resetTicTacToe = (id) => {
        const gameContainer = document.getElementById(id);
        gameContainer.outerHTML = createTicTacToeGame();
    };

            // --- Qibla Finder ---
            function createQiblaFinder() {
                const id = `qibla-${Date.now()}`;
                setTimeout(() => window.initQiblaFinder(id), 100);
                return `  
                <div class="feature-container text-center text-black" id="${id}">
                    <h3 class="text-lg font-bold text-white">🕋 Penunjuk Arah Kiblat</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Arahkan perangkat Anda. Jarum merah akan menunjuk ke arah Kiblat.</p>
                    <div id="qibla-permission-${id}" class="my-4">
                        <button onclick="window.initQiblaFinder('${id}')" class="interactive-button">Izinkan Akses Sensor & Lokasi</button>
                    </div>
                <div id="qibla-compass-container-${id}" class="qibla-compass" style="display:none;">
                        <div id="qibla-needle-${id}" class="qibla-needle"></div>
                    </div>
                    <div id="qibla-status-${id}" class="mt-4 text-sm text-indigo-300 h-6"></div>
                </div>`;
            }

            window.initQiblaFinder = (id) => {
                // Hentikan listener lain yang mungkin aktif
                if (window.activeOrientationHandler) window.removeEventListener('deviceorientation', window.activeOrientationHandler, true);
                const statusDiv = document.getElementById(`qibla-status-${id}`);
                if (!statusDiv) return;

                // 1. Check for secure context (HTTPS)
                if (window.location.protocol !== 'https:') {
                    statusDiv.innerHTML = `<p class="text-red-400"><b>Error:</b> Fitur ini memerlukan koneksi aman (HTTPS). Buka halaman ini melalui server web, bukan sebagai file lokal.</p>`;
                    document.getElementById(`qibla-permission-${id}`).style.display = 'none';
                    return;
                }

                // 2. Check for sensor support
                if (typeof DeviceOrientationEvent === 'undefined' || typeof DeviceOrientationEvent.requestPermission !== 'function') {
                     // For non-iOS browsers that might not have requestPermission
                     if (window.DeviceOrientationEvent) {
                        // Proceed, assuming permission is handled by the browser prompt
                     } else {
                        statusDiv.innerHTML = `<p class="text-red-400"><b>Error:</b> Perangkat Anda tidak mendukung sensor orientasi yang diperlukan.</p>`;
                        document.getElementById(`qibla-permission-${id}`).style.display = 'none';
                        return;
                     }
                }

                const compassContainer = document.getElementById(`qibla-compass-container-${id}`);
                const permissionBtn = document.getElementById(`qibla-permission-${id}`);
                statusDiv.textContent = 'Meminta izin akses sensor...';

                // 3. Request permissions
                Promise.all([
                    DeviceOrientationEvent.requestPermission ? DeviceOrientationEvent.requestPermission() : Promise.resolve('granted'),
                    new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject))
                ]).then(([orientationPerm, geoPosition]) => {
                    if (orientationPerm !== 'granted') {
                        throw new Error("Izin akses sensor orientasi ditolak.");
                    }

                    statusDiv.textContent = 'Izin diberikan. Menghitung arah kiblat...';
                    permissionBtn.style.display = 'none';
                    compassContainer.style.display = 'block';

                    const { latitude, longitude } = geoPosition.coords;
                    
                    const kaabaLat = 21.4225 * (Math.PI / 180);
                    const kaabaLon = 39.8262 * (Math.PI / 180);
                    const userLat = latitude * (Math.PI / 180);
                    const userLon = longitude * (Math.PI / 180);
                    const deltaLon = kaabaLon - userLon;
                    const y = Math.sin(deltaLon) * Math.cos(kaabaLat);
                    const x = Math.cos(userLat) * Math.sin(kaabaLat) - Math.sin(userLat) * Math.cos(kaabaLat) * Math.cos(deltaLon);
                    let qiblaDirection = (Math.atan2(y, x) * (180 / Math.PI) + 360) % 360;

                    statusDiv.textContent = `Lokasi ditemukan. Arah Kiblat: ${qiblaDirection.toFixed(2)}°`;

                    window.activeOrientationHandler = (event) => {
                        const heading = event.webkitCompassHeading || (360 - event.alpha);
                        const needle = document.getElementById(`qibla-needle-${id}`);
                        if (needle && heading !== null) {
                            needle.style.transform = `translateX(-50%) rotate(${qiblaDirection - heading}deg)`;
                        }
                    };
                    window.addEventListener('deviceorientation', window.activeOrientationHandler, true);

                }).catch(error => {
                    statusDiv.innerHTML = `<p class="text-red-400"><b>Error:</b> ${error.message}. Pastikan Anda mengizinkan akses lokasi dan sensor gerak.</p>`;
                });
            };

    window.createDrawingCanvas = () => {
        const id = `draw-${Date.now()}`;
        setTimeout(() => window.initializeCanvas(id), 100);
        return `
        <div class="feature-container text-white" id="${id}"> 
            <h3 class="text-lg font-bold">🎨 Kanvas Gambar Pro</h3>
            <div class="flex flex-wrap items-center gap-4 mb-3 bg-gray-100 dark:bg-gray-900 p-2 rounded-lg">
                <label>Warna: <input type="color" id="color-picker-${id}" value="#FFFFFF" onchange="window.changeDrawColor('${id}')"></label>
                <label>Ukuran: <input type="range" id="brush-size-${id}" min="1" max="50" value="5" class="w-24" onchange="window.changeDrawSize('${id}')"></label>
                <button onclick="window.setEraserMode('${id}')" class="interactive-button bg-gray-600 hover:bg-gray-500 text-sm p-2">Penghapus</button>
                <button onclick="window.clearCanvas('${id}')" class="interactive-button bg-red-600 hover:bg-red-700 text-sm p-2">Bersihkan</button>
                <a id="download-link-${id}" onclick="window.downloadCanvas('${id}')" class="interactive-button bg-green-600 hover:bg-green-700 text-sm p-2" download="gambar.png">Unduh</a>
            </div>
            <canvas id="canvas-${id}" class="bg-gray-200 dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 rounded-lg w-full cursor-crosshair" style="touch-action: none;"></canvas>
        </div>`;
    }
    window.downloadCanvas = (id) => {
        const canvas = document.getElementById(`canvas-${id}`);
        const link = document.getElementById(`download-link-${id}`);
        link.href = canvas.toDataURL('image/png');
    }

    // --- Time Capsule Feature ---
    function parseIndonesianDuration(when) {
        const duration = {};
        const patterns = {
            detik: /(\d+)\s*detik/i,
            menit: /(\d+)\s*menit/i,
            jam:   /(\d+)\s*jam/i,
            hari:  /(\d+)\s*hari/i,
            minggu: /(\d+)\s*minggu/i,
            bulan: /(\d+)\s*bulan/i,
            tahun: /(\d+)\s*tahun/i,
        };
        for (const key in patterns) {
            const match = when.match(patterns[key]);
            if (match) duration[key] = parseInt(match[1], 10);
        }
        return duration;
    }
    function setTimeCapsule(when, message) {
        try {
            const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
            const durationObject = parseIndonesianDuration(when);
            if (Object.keys(durationObject).length === 0) throw new Error("Format waktu tidak valid.");
            const targetTime = moment().add(durationObject).valueOf();
            capsules.push({ targetTime, message, id: Date.now() }); 
            localStorage.setItem('timeCapsules', JSON.stringify(capsules));
            return marked.parse(`✅ **Pesan Waktu Disimpan!** Akan tiba sekitar **${moment(targetTime).format('lll')}**.`);
        } catch (e) {
            return marked.parse(`❌ **Error:** Format waktu tidak valid. Gunakan format seperti '1 jam', '30 menit', atau '2 hari'.`);
        }
    }
    function viewTimeCapsules() {
        const arrived = JSON.parse(localStorage.getItem('arrivedCapsules') || '[]'); 
        if (arrived.length === 0) return marked.parse("📨 Tidak ada pesan masa lalu yang tiba.");
        const content = arrived.map(c => `**Dari ${moment(c.targetTime).fromNow()}:**\n> ${escapeHtml(c.message)}`).join('\n\n---\n\n');
        return marked.parse(`### ðŸ“¬ Pesan Dari Masa Lalu\n\n${content}`);
    }
    function checkTimeCapsules() {
        const capsules = JSON.parse(localStorage.getItem('timeCapsules') || '[]');
        const arrived = JSON.parse(localStorage.getItem('arrivedCapsules') || '[]');
        const now = Date.now();
        const remaining = [];
        let newArrival = false;
        capsules.forEach(c => {
            if (now >= c.targetTime) {
                arrived.unshift(c);
                newArrival = true;
            } else {
                remaining.push(c);
            }
        });
        if (newArrival) {
            localStorage.setItem('timeCapsules', JSON.stringify(remaining));
            localStorage.setItem('arrivedCapsules', JSON.stringify(arrived));
            addMessage('notification', marked.parse(`**🔔 Pesan Waktu Tiba!**<br>Sebuah pesan dari masa lalu baru saja tiba. Ketik <a href="#" class="example-link">chat waktu dulu</a> untuk melihatnya.`));
        }
    }

    // --- Ported Features ---
    function createCalendarView() {
        const today = moment();
        let calendarHtml = `<div class="grid grid-cols-7 gap-1 text-center text-sm">`;
        ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].forEach(day => { calendarHtml += `<div class="font-bold text-indigo-300">${day}</div>`; });
        for(let i = 0; i < 35; i++) {
            const day = moment().add(i, 'days');
            calendarHtml += `<div class="p-2 rounded-lg ${day.isSame(today, 'day') ? 'bg-indigo-600 text-white font-bold' : 'bg-gray-200 dark:bg-gray-700'}"><div class="text-xs">${day.format('MMM')}</div><div>${day.format('D')}</div></div>`;
        }
        calendarHtml += `</div>`;
        return `<div class="feature-container text-black"><h3 class="text-lg font-bold">🗓️ Kalender 35 Hari</h3><p class="text-sm mb-4">Menampilkan tanggal dari hari ini.</p>${calendarHtml}</div>`;
    }
    function createPasswordGenerator() {
        const id = `password-${Date.now()}`;
        return `
        <div class="feature-container text-white" id="${id}"> 
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">🔑 Generator Kata Sandi</h3>
            <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded-lg flex items-center gap-3 mb-4"><code id="password-result-${id}" class="text-lg text-green-600 dark:text-green-300 flex-grow break-all"></code><button onclick="window.copyToClipboard('password-result-${id}')" class="interactive-button text-sm p-2">Salin</button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="space-y-2"><label class="flex items-center gap-2"><input type="checkbox" id="upper-${id}" checked>Huruf Besar</label><label class="flex items-center gap-2"><input type="checkbox" id="lower-${id}" checked>Huruf Kecil</label><label class="flex items-center gap-2"><input type="checkbox" id="numbers-${id}" checked>Angka</label><label class="flex items-center gap-2"><input type="checkbox" id="symbols-${id}">Simbol</label></div><div><label>Panjang: <span id="length-label-${id}">16</span></label><input type="range" id="length-${id}" min="8" max="32" value="16" class="w-full" oninput="document.getElementById('length-label-${id}').textContent = this.value"></div></div>
            <button onclick="window.generatePassword('${id}')" class="interactive-button w-full mt-4">Buat Baru ðŸ”„</button>
        </div>`;
    }
    function createCodingArea() {
                const id = `code-editor-${Date.now()}`;
                const isDark = document.documentElement.classList.contains('dark');
                const bodyBg = isDark ? '#1f2937' : '#f9fafb';
                const textColor = isDark ? '#d1d5db' : '#111827';
                const h1Color = isDark ? '#a5b4fc' : '#4f46e5';

                const sampleCode = `<!-- Tulis kode HTML, CSS, dan JavaScript Anda di sini -->
<style>
  body { 
    font-family: sans-serif; 
    padding: 1rem;
    background-color: ${bodyBg};
    color: ${textColor};
  }
  h1 { color: ${h1Color}; }
  button { 
    background-color: #4f46e5; 
    color: white; 
    padding: 8px 16px; 
    border-radius: 6px;
    border: none;
  }
</style>
<h1>Halo Dunia dari Editor!</h1>
<p>Ini adalah pratinjau kode Anda. Klik tombol di bawah.</p>
<button onclick="alert('Tombol diklik!')">Klik Saya</button> 
`.trim();
        return `
                    <div class="feature-container text-black" id="${id}">
                        <h3 class="text-lg font-bold">💻 Area Koding dengan Pratinjau</h3>
                        <div class="flex justify-end mb-2 gap-2">
                            <button onclick="window.copyToClipboard('code-input-${id}')" class="interactive-button text-sm p-2">Salin Kode</button>
                            <button onclick="window.runCodePreview('${id}')" class="interactive-button bg-green-600 hover:bg-green-700 text-sm p-2">Jalankan Pratinjau</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-md font-semibold mb-2">Editor Kode</h4>
                                <textarea id="code-input-${id}" class="interactive-textarea w-full h-80 font-mono text-sm">${sampleCode}</textarea>
                            </div>
                            <div>
                                <h4 class="text-md font-semibold mb-2">Pratinjau</h4>
                                <iframe id="preview-frame-${id}" class="w-full h-80 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></iframe>
                            </div>
                        </div>
                    </div>
                `;
    }
    function createInteractivePrayerSchedule() {
        const id = `prayer-${Date.now()}`;
        return `<div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">🕌 Jadwal Sholat</h3><p class="text-sm mb-4">Masukkan kota di Indonesia untuk melihat jadwal sholat.</p><div class="flex gap-2"><input type="text" id="city-input-${id}" class="interactive-input flex-grow" value="Jakarta" placeholder="Contoh: Bandung"><button onclick="window.fetchPrayerTimes('${id}')" class="interactive-button">Cari</button></div><div id="result-${id}" class="mt-4"></div></div>`;
    }
    function createInteractiveQRCodeGenerator() {
        const id = `qr-${Date.now()}`;
        return `
        <div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">📱 Generator Kode QR</h3><p class="text-sm mb-4">Ketik teks untuk membuat QR code secara real-time.</p><input type="text" id="text-input-${id}" class="interactive-input" placeholder="Ketik teks Anda..." oninput="window.updateQRCode('${id}')"><div class="text-center mt-4"><canvas id="canvas-${id}"></canvas></div></div>`;
    }
    function createInteractiveColorAnalyzer() {
        const id = `color-${Date.now()}`;
        return `
        <div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">🎨 Analisis Warna</h3><p class="text-sm mb-4">Pilih warna atau ketik kodenya.</p><div class="flex items-center gap-4"><input type="color" id="picker-${id}" value="#5e35b1" oninput="window.updateColorAnalysis('${id}', this.value)" class="w-16 h-16 rounded-lg"><input type="text" id="text-${id}" value="#5e35b1" class="interactive-input flex-grow" oninput="window.updateColorAnalysis('${id}', this.value)"></div><div id="result-${id}" class="mt-4"></div></div>`;
    }
    function createInteractivePersonalityGenerator() {
        const id = `person-${Date.now()}`;
        return `
        <div class="feature-container text-black" id="${id}"><h3 class="text-lg font-bold">👤 Generator Kepribadian Acak</h3><div class="flex justify-between items-center mb-4"><p class="text-sm">Klik untuk membuat profil baru.</p><button onclick="window.regeneratePersonality('${id}')" class="interactive-button">Buat Lagi 🔄</button></div><div id="result-${id}" class="p-4 bg-gray-100 dark:bg-gray-900 rounded-lg"></div></div>`;
    }
    function createInteractiveChart() {
        const id = `chart-${Date.now()}`;
        return `
        <div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">📊 Grafik Interaktif</h3><p class="text-sm mb-4">Masukkan data 'Label: nilai1, nilai2, ...' per baris.</p><textarea class="interactive-textarea h-32" id="data-${id}">Pendapatan: 15, 22, 18, 25\nPengeluaran: 10, 14, 12, 15\nInvestasi: 5, 8, 11, 9\nLainnya: 3, 5, 4, 6</textarea><div class="flex gap-4 mt-3"><div class="flex-grow"><label class="text-sm">Label X-Axis (koma)</label><input type="text" id="labels-${id}" class="interactive-input" value="Q1, Q2, Q3, Q4"></div><div class="flex-grow"><label class="text-sm">Tipe Grafik</label><select id="type-${id}" class="interactive-select"><option value="bar">Bar</option><option value="line">Line</option><option value="pie">Pie</option></select></div><button onclick="window.updateUserChart('${id}')" class="interactive-button self-end">Buat</button></div><div class="mt-4 h-80"><canvas id="canvas-${id}"></canvas></div></div>`;
    }
    function createWikipediaSearch() {
        const id = `wikipedia-${Date.now()}`;
        return `
        <div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">🌐 Wikipedia Search</h3><p class="text-sm mb-4">Cari informasi dari Wikipedia.</p><div class="flex gap-2"><input type="text" id="search-input-${id}" class="interactive-input flex-grow" placeholder="Masukkan topik..."><button onclick="window.searchWikipedia('${id}')" class="interactive-button">Cari</button></div><div id="result-${id}" class="mt-4"></div></div>`;
    }
    function handleNotepadRequest(query) {
        const notepadMatch = query.match(/notepad\s*(\d+)/);
        const notepadNumber = notepadMatch ? parseInt(notepadMatch[1]) : 1;
        if (notepadNumber < 1 || notepadNumber > 4) return `<div class="feature-container text-red-400">❌ Error: Notepad hanya tersedia untuk slot 1-4.</div>`;
        return createNotepadInterface(notepadNumber);
    }
    function createNotepadInterface(notepadNumber) {
        const id = `notepad-${notepadNumber}-${Date.now()}`;
        const savedNote = localStorage.getItem(`notepad_${notepadNumber}`) || '';
        return `
        <div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">📝 Notepad ${notepadNumber}</h3><textarea id="note-content-${id}" class="interactive-textarea h-32" placeholder="Tulis catatan Anda...">${savedNote}</textarea><button onclick="window.saveNotepad('${id}', ${notepadNumber})" class="interactive-button bg-green-600 hover:bg-green-700 mt-2">Simpan</button><div id="response-${id}" class="mt-2 text-sm"></div></div>`;
            }            
            // --- Trello-like Board ---
            function createTrelloInterface() {
                const id = `trello-${Date.now()}`;
                setTimeout(() => window.initializeTrelloBoard(id), 100);
        return `
                    <div class="feature-container text-black" id="${id}">
                        <h3 class="text-lg font-bold mb-4">📋 Papan Tugas</h3>
                        <div class="trello-board" id="trello-board-${id}">
                            <!-- Kolom akan dirender oleh JavaScript -->
                        </div>
                    </div>
                `;
            }

            window.initializeTrelloBoard = (id) => {
                const board = document.getElementById(`trello-board-${id}`);
                if (!board) return;

                let data = JSON.parse(localStorage.getItem('trelloData')) || {
                    'todo': [{ id: `card-${Date.now()}`, text: 'Tugas pertama Anda' }],
                    'inprogress': [],
                    'done': []
                };

                const listTitles = { 'todo': '📝 To Do', 'inprogress': '⏳ In Progress', 'done': '✅ Done' };

                function saveData() {
                    localStorage.setItem('trelloData', JSON.stringify(data));
                }

                function renderBoard() {
                    board.innerHTML = '';
                    for (const listKey in listTitles) {
                        const listEl = document.createElement('div');
                        listEl.className = 'trello-list';
                        listEl.dataset.listId = listKey;
                        listEl.innerHTML = `<h4>${listTitles[listKey]}</h4><div class="trello-cards" id="cards-${listKey}-${id}"></div>`;
                        
                        const cardsContainer = listEl.querySelector('.trello-cards');
                        data[listKey].forEach(card => {
                            const cardEl = document.createElement('div');
                            cardEl.className = 'trello-card group p-3 rounded-lg cursor-grab shadow-sm';
                            cardEl.draggable = true;
                            cardEl.dataset.cardId = card.id;
                            cardEl.dataset.sourceList = listKey;
                            cardEl.innerHTML = `<span>${escapeHtml(card.text)}</span><span class="delete-card text-red-400 hover:text-red-300" onclick="window.deleteTrelloCard('${id}', '${listKey}', '${card.id}')">🗑️</span>`;
                            cardsContainer.appendChild(cardEl);
                        });

                        // Tombol untuk membersihkan list
                        const clearButton = document.createElement('button');
                        clearButton.className = 'interactive-button bg-red-800 hover:bg-red-700 text-xs p-1 w-full mt-2';
                        clearButton.textContent = 'Bersihkan List';
                        clearButton.onclick = () => {
                            if (confirm(`Anda yakin ingin menghapus semua kartu di list "${listTitles[listKey]}"?`)) {
                                data[listKey] = [];
                                saveData();
                                renderBoard();
                            }
                        };

                        if (listKey === 'todo') {
                            const addForm = document.createElement('form');
                            addForm.innerHTML = `
                                <input type="text" placeholder="+ Tambah kartu" class="interactive-input mt-2 text-sm">
                            `;
                            addForm.onsubmit = (e) => {
                                e.preventDefault();
                                const input = e.target.querySelector('input');
                                const text = input.value.trim();
                                if (text) {
                                    data.todo.push({ id: `card-${Date.now()}`, text });
                                    saveData();
                                    renderBoard();
                                }
                            };
                            listEl.appendChild(addForm);
                        }
                        listEl.appendChild(clearButton);
                        board.appendChild(listEl);
                    }
                }

                board.addEventListener('dragstart', e => {
                    if (e.target.classList.contains('trello-card')) {
                        e.target.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', e.target.dataset.cardId);
                        e.dataTransfer.setData('source-list', e.target.dataset.sourceList);
                    }
                });

                board.addEventListener('dragend', e => {
                    if (e.target.classList.contains('trello-card')) {
                        e.target.classList.remove('dragging');
                    }
                });

                board.addEventListener('dragover', e => {
                    e.preventDefault();
                });

                board.addEventListener('drop', e => {
                    e.preventDefault();
                    const cardId = e.dataTransfer.getData('text/plain');
                    const sourceListId = e.dataTransfer.getData('source-list');
                    const targetListEl = e.target.closest('.trello-list');

                    if (targetListEl) {
                        const targetListId = targetListEl.dataset.listId;
                        const cardIndex = data[sourceListId].findIndex(c => c.id === cardId);
                        if (cardIndex > -1) {
                            const [card] = data[sourceListId].splice(cardIndex, 1);
                            data[targetListId].push(card);
                            saveData();
                            renderBoard();
                        }
                    }
                });

                renderBoard();
            };

            window.deleteTrelloCard = (boardId, listKey, cardId) => {
                let data = JSON.parse(localStorage.getItem('trelloData'));
                if (data && data[listKey]) {
                    data[listKey] = data[listKey].filter(card => card.id !== cardId);
                    localStorage.setItem('trelloData', JSON.stringify(data));
                    // Re-initialize the specific board to re-render
                    window.initializeTrelloBoard(boardId);
                }
            };
    function createCurrentMonthDisplay() { const id = `month-${Date.now()}`; return `<div class="feature-container text-black" id="${id}"><h3 class="text-lg font-bold">📅 Bulan Ini</h3><div class="text-center py-6"><div class="text-3xl font-bold text-green-600 dark:text-green-300">${moment().format('MMMM YYYY')}</div><div class="text-lg">Hari dalam bulan ini: ${moment().daysInMonth()}</div></div></div>`; }
    function createCurrentDateDisplay() { const id = `date-${Date.now()}`; return `<div class="feature-container text-black" id="${id}"><h3 class="text-lg font-bold">🗓️ Tanggal Hari Ini</h3><div class="text-center py-6"><div class="text-3xl font-bold text-blue-600 dark:text-blue-300">${moment().format('dddd, DD MMMM YYYY')}</div><div class="text-lg">Hari ke-${moment().dayOfYear()} dalam setahun</div></div></div>`; }
    function createDiceGame() { const id = `dice-${Date.now()}`; return `<div class="feature-container text-center text-black" id="${id}"><h3 class="text-lg font-bold">🎲 Lempar Dadu</h3><div class="dice-visual mx-auto my-6 text-6xl" id="dice-face-${id}">⚀</div><div id="dice-result-${id}" class="text-2xl font-bold text-green-600 dark:text-green-400 mb-4"></div><button onclick="window.rollDice('${id}')" id="roll-btn-${id}" class="interactive-button w-full">Lempar!</button></div>`; }
    function create2048Game() {
        const id = `game2048-${Date.now()}`;
        return `<div class="feature-container text-center text-black dark:text-white" id="${id}"><h3 class="text-lg font-bold">🔢 Game 2048</h3><div class="flex justify-between items-center my-4"><div class="bg-gray-200 dark:bg-gray-700 rounded-lg px-4 py-2"><div>SKOR</div><div class="text-xl font-bold" id="score-${id}">0</div></div><button onclick="window.startNew2048Game('${id}')" class="interactive-button">Baru</button></div><div id="game-board-${id}" class="game-board-2048 mx-auto mb-4"></div><p class="text-sm">Gunakan tombol panah atau WASD</p><div id="game-status-${id}" class="mt-4"></div></div>`;
    }

    // --- API-based Utilities ---
    function createWeatherForecast(city) {
        if (!city) return { error: "Silakan masukkan nama kota. Contoh: `cuaca Jakarta`" };
        const id = `weather-${Date.now()}`;
        setTimeout(() => window.fetchWeather(id, city), 100);
        return `<div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">🌦️ Prakiraan Cuaca untuk ${escapeHtml(city)}</h3><div id="weather-result-${id}" class="mt-4 text-center">Memuat data cuaca...</div></div>`;
    }

    function createSunriseSunset(city) {
        if (!city) return { error: "Silakan masukkan nama kota. Contoh: `sunrise Jakarta`" };
        const id = `sun-${Date.now()}`;
        setTimeout(() => window.fetchSunriseSunset(id, city), 100);
        return `<div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">☀️ Terbit & Terbenam di ${escapeHtml(city)}</h3><div id="sun-result-${id}" class="mt-4 text-center">Memuat data...</div></div>`;
    }

    function createEarthquakeInfo() {
        const id = `earthquake-${Date.now()}`;
        setTimeout(() => window.fetchEarthquakeData(id), 100);
        return `<div class="feature-container text-black" id="${id}"><h3 class="text-lg font-bold">🌍 Info Gempa Terkini (BMKG)</h3><div id="earthquake-result-${id}" class="mt-4">Memuat data gempa...</div></div>`;
    }

    function createPokemonInfo(name) {
        if (!name) return { error: "Silakan masukkan nama Pokémon. Contoh: `pokemon pikachu`" };
        const id = `pokemon-${Date.now()}`;
        setTimeout(() => window.fetchPokemonData(id, name), 100);
        return `<div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">Pokédex: ${escapeHtml(name)}</h3><div id="pokemon-result-${id}" class="mt-4 text-center">Mencari di Pokédex...</div></div>`;
    }

    function createCountryInfo(name) {
        if (!name) return { error: "Silakan masukkan nama negara. Contoh: `negara indonesia`" };
        const id = `country-${Date.now()}`;
        setTimeout(() => window.fetchCountryData(id, name), 100);
        return `<div class="feature-container text-white" id="${id}"><h3 class="text-lg font-bold">Info Negara: ${escapeHtml(name)}</h3><div id="country-result-${id}" class="mt-4">Mencari data negara...</div></div>`;
    }

    // --- GLOBAL HELPER FUNCTIONS ---
    window.copyToClipboard = (elementId) => {
        const el = document.getElementById(elementId);
        const textToCopy = el.tagName === 'TEXTAREA' ? el.value : el.textContent;
        navigator.clipboard.writeText(textToCopy).then(() => alert('Teks disalin!'));
    }
    window.generatePassword = (id) => {
        const resultEl = document.getElementById(`password-result-${id}`);
        const length = document.getElementById(`length-${id}`).value;
        let charset = '';
        if (document.getElementById(`upper-${id}`).checked) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (document.getElementById(`lower-${id}`).checked) charset += 'abcdefghijklmnopqrstuvwxyz';
        if (document.getElementById(`numbers-${id}`).checked) charset += '0123456789';
        if (document.getElementById(`symbols-${id}`).checked) charset += '!@#$%^&*()';
        if (charset === '') { resultEl.textContent = 'Pilih min. 1 set karakter'; return; }
        resultEl.textContent = new Chance().string({ length, pool: charset });
    }
    window.fetchPrayerTimes = async (id) => { // Menggunakan Aladhan API yang lebih stabil
        const cityInput = document.getElementById(`city-input-${id}`);
        const city = cityInput.value.trim();
        const resultDiv = document.getElementById(`result-${id}`);
        if (!city) {
            resultDiv.innerHTML = `<p class="text-red-500">Nama kota tidak boleh kosong.</p>`;
            return;
        }
        resultDiv.innerHTML = `<p class="text-indigo-400">Mencari jadwal untuk ${escapeHtml(city)}...</p>`;
        try {
            // 1. Dapatkan koordinat dari nama kota menggunakan Nominatim (gratis & open-source)
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
            const geoData = await geoRes.json();
            if (!geoData || geoData.length === 0) throw new Error(`Kota "${city}" tidak ditemukan.`);
            const { lat, lon, display_name } = geoData[0];

            // 2. Dapatkan jadwal sholat dari Aladhan API menggunakan koordinat
            const prayerRes = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=ID&method=20`);
            const prayerData = await prayerRes.json();
            if (prayerData.code !== 200) throw new Error(prayerData.data || 'Gagal mengambil data sholat.');
            
            const timings = prayerData.data.timings;
            const prayerNames = { Fajr: 'Subuh', Dhuhr: 'Dzuhur', Asr: 'Ashar', Maghrib: 'Maghrib', Isha: 'Isya', Imsak: 'Imsak' };
            let tableRows = Object.keys(prayerNames).map(key => `<tr><td class="py-1">${prayerNames[key]}</td><td class="text-right font-semibold">${timings[key]}</td></tr>`).join('');
            resultDiv.innerHTML = `<h4 class="font-bold">${display_name}</h4><p class="text-sm text-gray-500 dark:text-gray-400">${prayerData.data.date.readable}</p><table class="w-full mt-2 text-left">${tableRows}</table>`;
        } catch (error) { resultDiv.innerHTML = `<p class="text-red-500">❌ Error: ${error.message}</p>`; }
    }
    window.updateQRCode = (id) => {
        const text = document.getElementById(`text-input-${id}`).value;
        const canvas = document.getElementById(`canvas-${id}`);
        const isDark = document.documentElement.classList.contains('dark'); // Re-check theme on update
        if (text.trim() === '') { canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); return; }
        new QRious({ element: canvas, value: text, size: 200, foreground: isDark ? '#FFFFFF' : '#111827', background: isDark ? '#1f2937' : '#f3f4f6', padding: 10 });
    }
    window.updateColorAnalysis = (id, colorValue) => {
        const textInput = document.getElementById(`text-${id}`), pickerInput = document.getElementById(`picker-${id}`), resultDiv = document.getElementById(`result-${id}`);
        if (!chroma.valid(colorValue)) { resultDiv.innerHTML = `<p class="text-yellow-400">Kode warna tidak valid.</p>`; return; }
        textInput.value = colorValue;
        pickerInput.value = colorValue;
        const color = chroma(colorValue);
        resultDiv.innerHTML = `<div class="grid grid-cols-2 gap-2 text-sm text-black"><div><strong>HEX:</strong> <code>${color.hex()}</code><br><strong>RGB:</strong> <code>${color.rgb().join(',')}</code></div><div><strong>Nama:</strong> ${color.name()}<br><strong>Suhu:</strong> ${color.temperature()}K</div></div>`;
    }
    window.regeneratePersonality = (id) => { const chance = new Chance(); document.getElementById(`result-${id}`).innerHTML = `<h4 class="text-xl font-bold text-indigo-500 dark:text-indigo-300">${chance.name()}</h4><ul class="mt-2 text-sm"><li><strong>Usia:</strong> ${chance.age()}</li><li><strong>Pekerjaan:</strong> ${chance.profession()}</li></ul>`; }
    window.updateUserChart = (id) => {
        const dataInput = document.getElementById(`data-${id}`).value, labelsInput = document.getElementById(`labels-${id}`).value, type = document.getElementById(`type-${id}`).value, ctx = document.getElementById(`canvas-${id}`).getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');
        const labels = labelsInput.split(',').map(l => l.trim()), datasets = dataInput.split('\n').map((line, i) => { const [label, dataStr] = line.split(':'), data = dataStr.split(',').map(n => parseFloat(n.trim())), colors = ['#4f46e5','#10b981','#f97316','#ef4444']; return { label, data, backgroundColor: colors[i % colors.length] + '80', borderColor: colors[i % colors.length] }; });
        if (window.activeCharts[id]) window.activeCharts[id].destroy();
        window.activeCharts[id] = new Chart(ctx, { type, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: isDark ? '#d1d5db' : '#374151' } } }, scales: type==='pie'?{}: { y: { ticks: { color: isDark ? '#9ca3af' : '#6b7280' }, grid: { color: isDark ? '#374151' : '#e5e7eb' } }, x: { ticks: { color: isDark ? '#9ca3af' : '#6b7280' }, grid: { color: isDark ? '#374151' : '#e5e7eb' } } } } });
    }
    window.searchWikipedia = async (id) => {
        const query = document.getElementById(`search-input-${id}`).value.trim();
        const resultDiv = document.getElementById(`result-${id}`);
        if (!query) return;
        resultDiv.innerHTML = `<p class="text-indigo-400">Mencari...</p>`;
        try {
            const res = await fetch(`https://id.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
            if (!res.ok) throw new Error(`Tidak ada hasil.`);
            const data = await res.json();
            resultDiv.innerHTML = `<div class="bg-gray-100 dark:bg-gray-900 rounded-lg p-4 text-black"><h4 class="text-xl font-bold mb-2">${data.title}</h4>${data.thumbnail ? `<img src="${data.thumbnail.source}" alt="${data.title}" class="w-24 h-24 rounded float-right ml-4">` : ''}<p>${data.extract}</p><a href="${data.content_urls.desktop.page}" target="_blank" class="text-blue-500 dark:text-blue-400">Baca Lengkap</a></div>`;
        } catch (error) { resultDiv.innerHTML = `<p class="text-red-500">❌ Error: ${error.message}</p>`; }
    }
    window.saveNotepad = (id, num) => { localStorage.setItem(`notepad_${num}`, document.getElementById(`note-content-${id}`).value); document.getElementById(`response-${id}`).innerHTML = `<p class="text-green-400">✅ Notepad ${num} disimpan!</p>`; }
    window.addTodoItem = (id) => { const input = document.getElementById(`manual-todo-${id}`), text = input.value.trim(); if (!text) return; const listNum = document.getElementById(`list-select-${id}`).value; const list = JSON.parse(localStorage.getItem(`todo_list_${listNum}`) || '[]'); list.push({ text, completed: false }); localStorage.setItem(`todo_list_${listNum}`, JSON.stringify(list)); document.getElementById(`todo-result-${id}`).innerHTML = `<p class="text-green-400">âœ… Item ditambahkan!</p>`; input.value = ''; window.showTodoListUI(listNum); }
    window.showTodoListUI = (listNum) => { addMessage('ai', showTodoList(parseInt(listNum))); }
    window.toggleTodoItem = (listNum, index, isChecked) => { const list = JSON.parse(localStorage.getItem(`todo_list_${listNum}`) || '[]'); if (list[index]) { list[index].completed = isChecked; localStorage.setItem(`todo_list_${listNum}`, JSON.stringify(list)); } }
    window.deleteTodoItem = (listNum, index) => { const list = JSON.parse(localStorage.getItem(`todo_list_${listNum}`) || '[]'); list.splice(index, 1); localStorage.setItem(`todo_list_${listNum}`, JSON.stringify(list)); window.showTodoListUI(listNum); }
    window.clearTodoList = (listNum) => { localStorage.setItem(`todo_list_${listNum}`, JSON.stringify([])); window.showTodoListUI(listNum); }
    window.updateCurrentTime = (id) => { const el = document.getElementById(`current-time-${id}`); if (!el) return; const now = moment(); el.textContent = now.format('HH:mm:ss'); document.getElementById(`current-date-${id}`).textContent = now.format('dddd, DD MMMM YYYY'); setTimeout(() => window.updateCurrentTime(id), 1000); }
    window.rollDice = (id) => {
        const btn = document.getElementById(`roll-btn-${id}`);
        if (btn.disabled) return;
        btn.disabled = true;
        const diceEmojis = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];
        const faceEl = document.getElementById(`dice-face-${id}`);
        const interval = setInterval(() => { faceEl.textContent = diceEmojis[Math.floor(Math.random() * 6)]; }, 80);
        setTimeout(() => {
            clearInterval(interval); const final = Math.floor(Math.random() * 6); faceEl.textContent = diceEmojis[final]; document.getElementById(`dice-result-${id}`).textContent = `Hasil: ${final + 1}`; btn.disabled = false;
        }, 1000);
    }

    // --- API Fetcher Functions ---
    window.fetchWeather = async (id, city) => {
        const resultDiv = document.getElementById(`weather-result-${id}`);
        if (!resultDiv) return;
        try {
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
            const geoData = await geoRes.json();
            if (geoData.length === 0) throw new Error(`Kota "${city}" tidak ditemukan.`);
            const { lat, lon } = geoData[0];
            const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);
            const weatherData = await weatherRes.json();
            const current = weatherData.current;
            const daily = weatherData.daily;
            const weatherCodes = {0:"Cerah",1:"Cerah",2:"Berawan",3:"Mendung",45:"Kabut",48:"Kabut",51:"Gerimis",53:"Gerimis",55:"Gerimis",61:"Hujan",63:"Hujan",65:"Hujan Lebat",80:"Hujan",81:"Hujan",82:"Hujan Lebat",95:"Badai"};
            resultDiv.innerHTML = `<div class="bg-slate-800 p-4 rounded-lg text-center"><p class="text-5xl font-bold">${current.temperature_2m}°C</p><p class="mt-2 text-lg">${weatherCodes[current.weather_code] || 'Tidak diketahui'}</p><p class="text-sm mt-2 text-slate-400">Harian: ${daily.temperature_2m_min[0]}°C / ${daily.temperature_2m_max[0]}°C</p></div>`;
        } catch (error) { resultDiv.innerHTML = `<p class="text-red-400">❌ Error: ${error.message}</p>`; }
    };

    window.fetchSunriseSunset = async (id, city) => {
        const resultDiv = document.getElementById(`sun-result-${id}`);
        if (!resultDiv) return;
        try {
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
            const geoData = await geoRes.json();
            if (geoData.length === 0) throw new Error(`Kota "${city}" tidak ditemukan.`);
            const { lat, lon } = geoData[0];
            const sunRes = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&formatted=0`);
            const sunData = await sunRes.json();
            if (sunData.status !== 'OK') throw new Error('Gagal mengambil data matahari.');
            const sunrise = moment.utc(sunData.results.sunrise).local().format('HH:mm');
            const sunset = moment.utc(sunData.results.sunset).local().format('HH:mm');
            resultDiv.innerHTML = `<div class="grid grid-cols-2 gap-4"><div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg"><p class="text-2xl">🌅</p><p>Terbit: <strong>${sunrise}</strong></p></div><div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg"><p class="text-2xl">🌇</p><p>Terbenam: <strong>${sunset}</strong></p></div></div>`;
        } catch (error) { resultDiv.innerHTML = `<p class="text-red-400">❌ Error: ${error.message}</p>`; }
    };

    window.fetchEarthquakeData = async (id) => {
        const resultDiv = document.getElementById(`earthquake-result-${id}`);
        if (!resultDiv) return;
        try {
            const res = await fetch('https://data.bmkg.go.id/DataMKG/TEWS/autogempa.json');
            const data = await res.json();
            const gempa = data.Infogempa.gempa;
            resultDiv.innerHTML = `
                <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg">
                    <p><strong>Waktu:</strong> ${gempa.Jam}, ${gempa.Tanggal}</p>
                    <p><strong>Magnitudo:</strong> ${gempa.Magnitude} SR</p>
                    <p><strong>Lokasi:</strong> ${gempa.Wilayah}</p>
                    <p><strong>Potensi:</strong> ${gempa.Potensi}</p>
                </div>
            `;
        } catch (error) { resultDiv.innerHTML = `<p class="text-red-400">❌ Error: ${error.message}</p>`; }
    };

    window.fetchPokemonData = async (id, name) => {
        const resultDiv = document.getElementById(`pokemon-result-${id}`);
        if (!resultDiv) return;
        try {
            const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${name.toLowerCase()}`);
            if (!res.ok) throw new Error(`Pokémon "${name}" tidak ditemukan.`);
            const data = await res.json();
            const types = data.types.map(t => t.type.name).join(', ');
            resultDiv.innerHTML = `
                <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg flex flex-col items-center">
                    <img src="${data.sprites.front_default}" alt="${data.name}" class="w-32 h-32">
                    <h4 class="text-xl font-bold capitalize text-black">${data.name}</h4>
                    <p class="text-sm text-black">Tipe: ${types}</p>
                    <p class="text-sm text-black">Tinggi: ${data.height / 10} m | Berat: ${data.weight / 10} kg</p>
                </div>
            `;
        } catch (error) { resultDiv.innerHTML = `<p class="text-red-400">❌ Error: ${error.message}</p>`; }
    };

    window.fetchCountryData = async (id, name) => {
        const resultDiv = document.getElementById(`country-result-${id}`);
        if (!resultDiv) return;
        try {
            const res = await fetch(`https://restcountries.com/v3.1/name/${name}?fullText=true`);
            if (!res.ok) throw new Error(`Negara "${name}" tidak ditemukan.`);
            const data = await res.json();
            const country = data[0];
            resultDiv.innerHTML = `
                <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg text-black"><h4 class="text-xl font-bold">${country.name.common} ${country.flag}</h4><p><strong>Ibu Kota:</strong> ${country.capital[0]}</p><p><strong>Populasi:</strong> ${country.population.toLocaleString('id-ID')}</p><p><strong>Region:</strong> ${country.region}</p></div>
            `;
        } catch (error) { resultDiv.innerHTML = `<p class="text-red-400">❌ Error: ${error.message}</p>`; }
    };

    window.setupDiceVisual = (id, num) => { const face = document.getElementById(`dice-face-${id}`); if (!face) return; face.innerHTML = ''; const p = {1:['e'],2:['a','b'],3:['a','e','b'],4:['a','c','d','b'],5:['a','c','e','d','b'],6:['a','c','f','g','d','b']}; face.style.gridTemplateAreas = (num === 6) ? '"a . c" "f . g" "d . b"' : '"a . c" ". e ." "d . b"'; p[num].forEach(a => { const d = document.createElement('div'); d.className = `dice-dot ${a}`; face.appendChild(d); }); }
    let gameStates = {};
    window.initializeGame2048 = (id) => { gameStates[id] = { board: Array(4).fill(0).map(() => Array(4).fill(0)), score: 0, gameEnded: false }; window.addRandomTile2048(id); window.addRandomTile2048(id); window.updateDisplay2048(id); window.setupKeyboard2048(id); }
    window.startNew2048Game = (id) => { window.initializeGame2048(id); document.getElementById(`game-status-${id}`).innerHTML = ''; }
    window.addRandomTile2048 = (id) => { const s = gameStates[id]; const e = []; for (let r=0;r<4;r++) for (let c=0;c<4;c++) if (s.board[r][c]===0) e.push({r,c}); if(e.length>0){const cell=e[Math.floor(Math.random()*e.length)]; s.board[cell.r][cell.c] = Math.random()<0.9?2:4;}}
    window.updateDisplay2048 = (id) => { const s = gameStates[id], b = document.getElementById(`game-board-${id}`); if (!b) return; b.innerHTML = ''; s.board.forEach(r => r.forEach(v => { const t = document.createElement('div'); t.className = 'tile-2048'; if (v !== 0) { t.textContent = v; t.classList.add(`tile-2048-${v}`); } b.appendChild(t); })); const scoreEl = document.getElementById(`score-${id}`); if (scoreEl) scoreEl.textContent = s.score; }
    window.setupKeyboard2048 = (id) => { const h = (e) => { if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; if (!gameStates[id] || gameStates[id].gameEnded) return; let m = false; switch (e.key) { case 'ArrowLeft': case 'a': m = window.move2048(id, 'left'); break; case 'ArrowRight': case 'd': m = window.move2048(id, 'right'); break; case 'ArrowUp': case 'w': m = window.move2048(id, 'up'); break; case 'ArrowDown': case 's': m = window.move2048(id, 'down'); break; } if (m) { e.preventDefault(); setTimeout(() => { window.addRandomTile2048(id); window.updateDisplay2048(id); window.checkGameState2048(id); }, 100); } }; document.removeEventListener('keydown', gameStates[id]?.keyHandler); gameStates[id].keyHandler = h; document.addEventListener('keydown', h); }
    window.move2048 = (id, dir) => { const s = gameStates[id]; const bCopy = s.board.map(r=>[...r]); const rot = b => b[0].map((_, i)=>b.map(r=>r[i]).reverse()); const slide = r => {let a = r.filter(v=>v); for(let i=0;i<a.length-1;i++){if(a[i]===a[i+1]){a[i]*=2;s.score+=a[i];a.splice(i+1,1);}} return a.concat(Array(4-a.length).fill(0));}; if(dir==='left')s.board=s.board.map(slide); if(dir==='right')s.board=s.board.map(r=>slide(r.reverse()).reverse()); if(dir==='up'){let b=rot(s.board); b=b.map(slide); s.board=rot(rot(rot(b)));} if(dir==='down'){let b=rot(s.board); b=b.map(r=>slide(r.reverse()).reverse()); s.board=rot(rot(rot(b)));} return JSON.stringify(bCopy)!==JSON.stringify(s.board); }
    window.checkGameState2048 = (id) => { const s = gameStates[id]; let canMove = false, hasEmpty = false; for(let r=0;r<4;r++)for(let c=0;c<4;c++){if(s.board[r][c]===0)hasEmpty=true; if(r<3&&s.board[r][c]===s.board[r+1][c])canMove=true; if(c<3&&s.board[r][c]===s.board[r][c+1])canMove=true;} if(!hasEmpty&&!canMove){s.gameEnded=true; document.getElementById(`game-status-${id}`).innerHTML = `<div class="bg-red-900 text-red-200 p-2 rounded">Game Over!</div>`;}}
    window.initializeCanvas = (id) => { const canvas = document.getElementById(`canvas-${id}`); if (!canvas) return; const ctx = canvas.getContext('2d'); canvas.width = canvas.parentElement.clientWidth; canvas.height = 400; if (!window.canvasStates) window.canvasStates = {}; window.canvasStates[id] = { drawing: false, color: '#FFFFFF', size: 5, lastX: 0, lastY: 0, isEraser: false }; const state = window.canvasStates[id]; const getPos = (evt) => { const rect = canvas.getBoundingClientRect(), event = evt.touches ? evt.touches[0] : evt; return { x: event.clientX - rect.left, y: event.clientY - rect.top }; }; const startDrawing = (e) => { e.preventDefault(); state.drawing = true; [state.lastX, state.lastY] = [getPos(e).x, getPos(e).y]; }; const stopDrawing = (e) => { e.preventDefault(); state.drawing = false; }; const draw = (e) => { if (!state.drawing) return; e.preventDefault(); const pos = getPos(e); ctx.beginPath(); ctx.moveTo(state.lastX, state.lastY); ctx.lineTo(pos.x, pos.y); const isDark = document.documentElement.classList.contains('dark'); ctx.strokeStyle = state.isEraser ? (isDark ? '#374151' : '#e5e7eb') : state.color; ctx.lineWidth = state.size; ctx.lineCap = 'round'; ctx.stroke(); [state.lastX, state.lastY] = [pos.x, pos.y]; }; canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mousemove', draw); canvas.addEventListener('touchstart', startDrawing, { passive: false }); canvas.addEventListener('touchend', stopDrawing, { passive: false }); canvas.addEventListener('touchmove', draw, { passive: false }); };
    window.changeDrawColor = (id) => { const state = window.canvasStates[id]; if (state) { state.color = document.getElementById(`color-picker-${id}`).value; state.isEraser = false; } };
    window.changeDrawSize = (id) => { const state = window.canvasStates[id]; if (state) state.size = document.getElementById(`brush-size-${id}`).value; };
    window.setEraserMode = (id) => { const state = window.canvasStates[id]; if (state) state.isEraser = true; };
    window.clearCanvas = (id) => { const canvas = document.getElementById(`canvas-${id}`); if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); };
            window.runCodePreview = (id) => {
                const code = document.getElementById(`code-input-${id}`).value;
                const iframe = document.getElementById(`preview-frame-${id}`);
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open(); iframeDoc.write(code); iframeDoc.close();
            };

    // --- Initial Triggers & Checks ---
    setTimeout(() => {
        updateActiveModelUI();
        document.querySelectorAll('.feature-container').forEach(el => {
            const id = el.id;
            if (id.startsWith('prayer-')) window.fetchPrayerTimes(id);
            if (id.startsWith('qr-')) window.updateQRCode(id);
            if (id.startsWith('color-')) window.updateColorAnalysis(id, '#5e35b1');
            if (id.startsWith('person-')) window.regeneratePersonality(id);
            if (id.startsWith('chart-')) window.updateUserChart(id);
            if (id.startsWith('time-')) window.updateCurrentTime(id);
            if (id.startsWith('dice-')) window.setupDiceVisual(id, 1);
            if (id.startsWith('game2048-')) window.startNew2048Game(id);
            if (id.startsWith('password-')) window.generatePassword(id);
                    if (id.startsWith('weather-')) window.fetchWeather(id, el.querySelector('h3').textContent.split('untuk ')[1]);
                    if (id.startsWith('sun-')) window.fetchSunriseSunset(id, el.querySelector('h3').textContent.split('di ')[1]);
                    if (id.startsWith('earthquake-')) window.fetchEarthquakeData(id);
                    if (id.startsWith('pokemon-')) window.fetchPokemonData(id, el.querySelector('h3').textContent.split(': ')[1]);
                    if (id.startsWith('code-editor-')) window.runCodePreview(id);
            if (id.startsWith('draw-')) window.initializeCanvas(id);
            if (id.startsWith('piano-')) window.initializePiano(id);
        });
    }, 500); // Increased delay to ensure all elements are ready

    // --- Sports Tracker ---
    function createSportsTracker() {
        const id = `sports-tracker-${Date.now()}`;
        setTimeout(() => window.initSportsTracker(id), 100);
        return `
            <div class="feature-container text-white" id="${id}">
                <h3 class="text-lg font-bold mb-4">🏃‍♂️ Pelacak Aktivitas Olahraga</h3>
                <div id="sports-permission-${id}" class="mb-4">
                    <p class="text-sm text-yellow-300 mb-2">Fitur ini memerlukan izin untuk mengakses sensor gerak dan lokasi perangkat Anda.</p>
                    <button onclick="window.requestSportsPermissions('${id}')" class="interactive-button">Berikan Izin</button>
                </div>
                <div id="sports-main-${id}" style="display: none;">
                    <div class="flex gap-4 mb-4">
                        <button id="sports-start-btn-${id}" onclick="window.startSportsTracker('${id}')" class="interactive-button bg-green-600 hover:bg-green-700 flex-1">Mulai</button>
                        <button id="sports-stop-btn-${id}" onclick="window.stopSportsTracker('${id}')" class="interactive-button bg-red-600 hover:bg-red-700 flex-1" disabled>Hentikan</button>
                    </div>
                    <div class="sports-tracker-grid">
                        <div class="sport-card">
                            <h4>👟 Langkah</h4>
                            <div id="steps-value-${id}" class="sport-value">0</div>
                        </div>
                        <div class="sport-card">
                            <h4>🔥 Guncangan</h4>
                            <div id="shakes-value-${id}" class="sport-value">0</div>
                        </div>
                        <div class="sport-card">
                            <h4>🧭 Kompas</h4>
                            <div class="qibla-compass mx-auto !w-24 !h-24 !border-2">
                                <div id="sports-needle-${id}" class="qibla-needle !border-b-[50px] !top-2" style="transform-origin: 50% 48px;"></div>
                            </div>
                            <div id="heading-value-${id}" class="text-sm mt-2">0°</div>
                        </div>
                        <div class="sport-card">
                            <h4>📍 Jarak</h4>
                            <div id="distance-value-${id}" class="sport-value">0.00</div>
                            <div class="sport-unit">km</div>
                        </div>
                        <div class="sport-card">
                            <h4>⚡ Kecepatan</h4>
                            <div id="speed-value-${id}" class="sport-value">0.0</div>
                            <div class="sport-unit">km/jam</div>
                        </div>
                        <div class="sport-card">
                            <h4>🗺️ Peta Mini</h4>
                            <div id="sports-map-${id}" class="h-24 w-full rounded-md bg-gray-700"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    window.sportsTrackerStates = {};

    window.requestSportsPermissions = (id) => {
        const statusDiv = document.getElementById(`sports-permission-${id}`);
        statusDiv.innerHTML = `<p class="text-sm text-yellow-300">Meminta izin...</p>`;

        Promise.all([
            DeviceOrientationEvent.requestPermission ? DeviceOrientationEvent.requestPermission() : Promise.resolve('granted'),
            DeviceMotionEvent.requestPermission ? DeviceMotionEvent.requestPermission() : Promise.resolve('granted'),
            new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true }))
        ]).then(() => {
            statusDiv.style.display = 'none';
            document.getElementById(`sports-main-${id}`).style.display = 'block';
        }).catch(error => {
            statusDiv.innerHTML = `<p class="text-sm text-red-400">Izin ditolak. Fitur tidak dapat digunakan. Error: ${error.message}</p>`;
        });
    };

    window.initSportsTracker = (id) => {
        window.sportsTrackerStates[id] = {
            isActive: false,
            steps: 0,
            shakes: 0,
            distance: 0,
            lastPosition: null,
            geoWatchId: null,
            lastShakeTime: 0,
            lastStepTime: 0,
            map: null,
            path: null,
            userMarker: null
        };
    };

    window.startSportsTracker = (id) => {
        const state = window.sportsTrackerStates[id];
        if (state.isActive) return;
        state.isActive = true;

        document.getElementById(`sports-start-btn-${id}`).disabled = true;
        document.getElementById(`sports-stop-btn-${id}`).disabled = false;

        // Reset counters
        state.steps = 0; state.shakes = 0; state.distance = 0; state.lastPosition = null;
        document.getElementById(`steps-value-${id}`).textContent = '0';
        document.getElementById(`shakes-value-${id}`).textContent = '0';
        document.getElementById(`distance-value-${id}`).textContent = '0.00';
        document.getElementById(`speed-value-${id}`).textContent = '0.0';

        // Init Map
        if (!state.map) {
            state.map = L.map(`sports-map-${id}`).setView([0, 0], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(state.map);
        }
        if (state.path) state.map.removeLayer(state.path);
        state.path = L.polyline([], { color: 'blue' }).addTo(state.map);

        // Motion Listener
        window.addEventListener('devicemotion', (e) => handleDeviceMotion(e, id));
        // Orientation Listener
        window.addEventListener('deviceorientation', (e) => handleDeviceOrientation(e, id));
        // Geolocation Listener
        state.geoWatchId = navigator.geolocation.watchPosition((pos) => handleGeolocation(pos, id), (err) => console.error(err), { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    };

    window.stopSportsTracker = (id) => {
        const state = window.sportsTrackerStates[id];
        if (!state.isActive) return;
        state.isActive = false;

        document.getElementById(`sports-start-btn-${id}`).disabled = false;
        document.getElementById(`sports-stop-btn-${id}`).disabled = true;

        window.removeEventListener('devicemotion', (e) => handleDeviceMotion(e, id));
        window.removeEventListener('deviceorientation', (e) => handleDeviceOrientation(e, id));
        if (state.geoWatchId) navigator.geolocation.clearWatch(state.geoWatchId);
    };

    function handleDeviceMotion(event, id) { /* ... logic ... */ }
    function handleDeviceOrientation(event, id) { /* ... logic ... */ }
    function handleGeolocation(position, id) { /* ... logic ... */ }

    // --- Ludo Game ---
    function createLudoGame() {
        const id = `ludo-game-${Date.now()}`;
        setTimeout(() => window.initLudoGame(id), 100);
        return `
            <div class="feature-container text-center text-black dark:text-white" id="${id}">
                <h3 class="text-lg font-bold">🎲 Game Ludo</h3>
                <div id="ludo-status-${id}" class="ludo-status my-2">Memulai permainan...</div>
                <div id="ludo-board-${id}" class="ludo-board"></div>
                <div class="ludo-dice-container mt-4 justify-center">
                    <div id="ludo-dice-${id}" class="ludo-dice bg-white">0</div>
                    <button id="ludo-roll-btn-${id}" class="interactive-button" onclick="window.rollLudoDice('${id}')">Lempar Dadu</button>
                </div>
            </div>
        `;
    }

    // --- Ludo Game - Enhanced Logic ---
    window.initLudoGame = (id) => {
        const boardEl = document.getElementById(`ludo-board-${id}`);
        const status = document.getElementById(`ludo-status-${id}`);
        const diceEl = document.getElementById(`ludo-dice-${id}`);
        const rollBtn = document.getElementById(`ludo-roll-btn-${id}`);
        if (!boardEl || !status || !diceEl || !rollBtn) return;

        const colors = ['red', 'blue', 'yellow', 'green'];
        const turnOrder = ['red', 'green', 'yellow', 'blue'];
        const startPositions = { red: 0, green: 13, yellow: 26, blue: 39 };
        const homeEntrances = { red: 50, green: 11, yellow: 24, blue: 37 }; // Position before entering home path
        const path = Array.from({ length: 52 }, (_, i) => i);
        const safeSpots = [0, 8, 13, 21, 26, 34, 39, 47];

        let gameState = {
            turnIndex: 0,
            diceVal: 0,
            rolled: false,
            players: {}
        };

        colors.forEach(color => {
            gameState.players[color] = {
                tokens: Array(4).fill(null).map((_, i) => ({ id: `${color}-${i}`, pos: -1, state: 'home' })), // pos -1: home, 0-51: path, 52-56: home path, 57: finished
                isAI: color !== 'red'
            };
        });

        const renderBoard = () => {
            boardEl.innerHTML = `
                <div class="ludo-home-area red"><div class="ludo-home-inner" id="home-red-${id}"></div></div>
                <div class="ludo-path-top"></div>
                <div class="ludo-home-area green"><div class="ludo-home-inner" id="home-green-${id}"></div></div>
                <div class="ludo-path-middle"></div>
                <div class="ludo-center"></div>
                <div class="ludo-path-middle"></div>
                <div class="ludo-home-area blue"><div class="ludo-home-inner" id="home-blue-${id}"></div></div>
                <div class="ludo-path-bottom"></div>
                <div class="ludo-home-area yellow"><div class="ludo-home-inner" id="home-yellow-${id}"></div></div>
            `;

            // Clear old tokens before rendering new ones
            boardEl.querySelectorAll('.ludo-token').forEach(t => t.remove());

            for (const color of colors) {
                const player = gameState.players[color];
                const homeContainer = document.getElementById(`home-${color}-${id}`);
                homeContainer.innerHTML = ''; // Clear home area

                player.tokens.forEach(token => {
                    const tokenEl = document.createElement('div');
                    tokenEl.id = `token-${token.id}`;
                    tokenEl.className = `ludo-token token-${color}`;
                    
                    if (token.state === 'home') {
                        homeContainer.appendChild(tokenEl);
                    } else {
                        // This is a simplified positioning logic for demonstration
                        // A real implementation would have a precise map of cell coordinates
                        let top = 0, left = 0;
                        const pos = token.pos;
                        const cell_size = 26;

                        if (pos >= 0 && pos <= 4) { top = 6 * cell_size; left = (pos) * cell_size; }
                        else if (pos >= 5 && pos <= 10) { top = (10 - pos) * cell_size; left = 5 * cell_size; }
                        else if (pos >= 11 && pos <= 12) { top = 0; left = (pos - 5) * cell_size; }
                        else if (pos >= 13 && pos <= 17) { top = (pos - 12) * cell_size; left = 7 * cell_size; }
                        else if (pos >= 18 && pos <= 23) { top = 5 * cell_size; left = (pos - 11) * cell_size; }
                        else if (pos >= 24 && pos <= 25) { top = (pos - 18) * cell_size; left = 12 * cell_size; }
                        else if (pos >= 26 && pos <= 30) { top = 7 * cell_size; left = (38 - pos) * cell_size; }
                        else if (pos >= 31 && pos <= 36) { top = (pos - 24) * cell_size; left = 8 * cell_size; }
                        else if (pos >= 37 && pos <= 38) { top = 12 * cell_size; left = (44 - pos) * cell_size; }
                        else if (pos >= 39 && pos <= 43) { top = (50 - pos) * cell_size; left = 6 * cell_size; }
                        else if (pos >= 44 && pos <= 49) { top = 8 * cell_size; left = (50 - pos) * cell_size; }
                        else if (pos >= 50 && pos <= 51) { top = (51 - pos) * cell_size; left = 0; }
                        // Home path positioning
                        else if (pos >= 100 && pos < 106) { // Red home path
                            top = 7 * cell_size; left = (pos - 100 + 1) * cell_size;
                        }
                        else if (pos >= 200 && pos < 206) { // Green home path
                            top = (pos - 200 + 1) * cell_size; left = 7 * cell_size;
                        }
                        else if (pos >= 300 && pos < 306) { // Yellow home path
                            top = 7 * cell_size; left = (11 - (pos - 300)) * cell_size;
                        }
                        else if (pos >= 400 && pos < 406) { // Blue home path
                            top = (11 - (pos - 400)) * cell_size; left = 7 * cell_size;
                        }

                        tokenEl.style.top = `${top}px`;
                        tokenEl.style.left = `${left}px`;
                        boardEl.appendChild(tokenEl);
                    }
                });
            }
        };

        const nextTurn = () => {
            gameState.rolled = false;
            gameState.turnIndex = (gameState.turnIndex + 1) % 4;
            const currentPlayerColor = turnOrder[gameState.turnIndex];
            status.textContent = `Giliran ${currentPlayerColor}`;
            status.style.color = `var(--token-${currentPlayerColor})`;
            rollBtn.disabled = gameState.players[currentPlayerColor].isAI;

            if (gameState.players[currentPlayerColor].isAI) {
                setTimeout(aiTurn, 1500);
            }
        };

        const rollDice = () => {
            if (gameState.rolled) return;
            gameState.rolled = true;
            rollBtn.disabled = true;
            diceEl.classList.add('rolling');

            const roll = Math.floor(Math.random() * 6) + 1;
            setTimeout(() => {
                diceEl.classList.remove('rolling');
                diceEl.textContent = roll;
                gameState.diceVal = roll;
                handlePostRoll();
            }, 500);
        };

        const handlePostRoll = () => {
            const playerColor = turnOrder[gameState.turnIndex];
            const player = gameState.players[playerColor];
            const movableTokens = getMovableTokens(player, gameState.diceVal);

            if (movableTokens.length === 0) {
                status.textContent = `Tidak ada gerakan valid untuk ${playerColor}.`;
                setTimeout(nextTurn, 1500);
                return;
            }

            if (player.isAI) {
                // AI logic
                const bestMove = movableTokens[Math.floor(Math.random() * movableTokens.length)]; // Simplistic AI: move a random possible token
                moveToken(bestMove);
            } else {
                // Player logic
                status.textContent = `Anda dapat ${gameState.diceVal}. Pilih token untuk bergerak.`;
                movableTokens.forEach(token => {
                    const tokenEl = document.getElementById(`token-${token.id}`);
                    tokenEl.classList.add('movable');
                    tokenEl.onclick = () => moveToken(token);
                });
            }
        };

        const getMovableTokens = (player, diceVal) => {
            const movable = [];
            player.tokens.forEach(token => {
                if (token.state === 'finished') return;
                if (token.state === 'home' && diceVal === 6) { 
                    movable.push(token);
                } else if (token.state === 'path' || token.state === 'home_path') {
                    const color = token.id.split('-')[0];
                    const entrance = homeEntrances[color];
                    const currentPos = token.pos;
                    // Check if move overshoots home
                    if (currentPos > 51) { // in home path
                        if (currentPos + diceVal <= (colors.indexOf(color) * 100 + 5)) movable.push(token);
                    } else if (currentPos <= entrance && currentPos + diceVal > entrance) { // entering home path
                        const homePathPos = (colors.indexOf(color) * 100) + (currentPos + diceVal - entrance -1);
                        if (homePathPos <= (colors.indexOf(color) * 100 + 5)) movable.push(token);
                    } else { movable.push(token); }
                }
            });
            return movable;
        };

        const moveToken = (tokenToMove) => {
            // Clear highlights and clicks
            document.querySelectorAll('.movable').forEach(el => {
                el.classList.remove('movable');
                el.onclick = null;
            });

            const playerColor = tokenToMove.id.split('-')[0];
            const player = gameState.players[playerColor];
            const token = player.tokens.find(t => t.id === tokenToMove.id);

            if (token.state === 'home' && gameState.diceVal === 6) {
                token.state = 'path';
                token.pos = startPositions[playerColor];
            } else if (token.state === 'path' || token.state === 'home_path') {
                const entrance = homeEntrances[playerColor];
                const homeBase = colors.indexOf(playerColor) * 100;

                if (token.pos > 51) { // Already in home path
                    token.pos += gameState.diceVal;
                } else if (token.pos <= entrance && token.pos + gameState.diceVal > entrance) { // Entering home path
                    token.pos = homeBase + (token.pos + gameState.diceVal - entrance - 1);
                    token.state = 'home_path';
                } else { // Normal move
                    token.pos = (token.pos + gameState.diceVal) % 52;
                }

                if (token.pos === homeBase + 5) {
                    token.state = 'finished';
                    token.pos = -2; // Mark as finished
                }
            }
            
            // Capture logic
            // ...

            renderBoard(); // Re-render the board with new token positions

            if (gameState.diceVal !== 6) {
                nextTurn();
            } else { // Roll again on 6
                status.textContent = `Anda dapat 6, lempar dadu lagi!`;
                gameState.rolled = false;
                rollBtn.disabled = false;
            }
        };

        const aiTurn = () => {
            status.textContent = `Giliran AI ${turnOrder[gameState.turnIndex]}...`;
            rollDice();
        };

        window.rollLudoDice = (id) => rollDice();
        nextTurn(); // Start the first turn
        renderBoard();
    };

    // --- Latency/Ping Checker ---
    function checkLatency() {
        const pingDisplay = document.getElementById('ping-display');
        if (!pingDisplay) return;

        const startTime = performance.now();
        // Menggunakan gambar kecil dari Cloudflare dengan cache-busting untuk pengukuran
        fetch('https://www.cloudflare.com/favicon.ico?t=' + Date.now(), { method: 'HEAD', mode: 'no-cors' })
            .catch(() => { // catch diperlukan untuk no-cors
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);

                pingDisplay.textContent = `${latency} ms`;
                pingDisplay.classList.remove('text-green-400', 'text-yellow-400', 'text-red-400');

                if (latency < 120) {
                    pingDisplay.classList.add('text-green-400');
                } else if (latency < 300) {
                    pingDisplay.classList.add('text-yellow-400');
                } else {
                    pingDisplay.classList.add('text-red-400');
                }
            });
    }

    setInterval(checkLatency, 3000); // Cek ping setiap 3 detik
    checkLatency(); // Cek ping saat pertama kali load
});
</script>
</body>
</html>
